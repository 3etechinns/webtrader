define(["indicator_base","highstock"],function(a){function b(b){if(b.index<b.period-1)return null;if(b.index==b.period-1)return a.getPrice(b.data.data,b.index,b.appliedTo,b.type);for(var c=2/(b.fastPeriod+1),d=2/(b.slowPeriod+1),e=Math.abs(a.getPrice(b.data.data,b.index,b.appliedTo,b.type)-a.getPrice(b.data.data,b.index-b.period,b.appliedTo,b.type)),f=0,g=0;g<b.period;g++)f+=Math.abs(a.getPrice(b.data.data,b.index-g,b.appliedTo,b.type)-a.getPrice(b.data.data,b.index-(g+1),b.appliedTo,b.type));var h=e/f,i=Math.pow(h*(c-d)+d,2),j=a.getPrice(b.data.data,b.index,b.appliedTo,b.type),k=a.getIndicatorData(b.data.kamaData,b.index-1);return k+i*(j-k)}var c={},d={};return{init:function(){!function(a,e,f){function g(a,e){var g=this,h=g.chart;for(var i in d)if(d[i]&&d[i].options&&d[i].options.data&&d[i].options.data.length>0&&c[i].parentSeriesID==g.options.id&&d[i].chart===h){var j=g.options.data,k=d[i].options.data,l=c[i],m=f.findIndexInDataForTime(j,a);if(m>=1){var n={data:{data:j,kamaData:k},index:m,period:l.period,fastPeriod:l.fastPeriod,slowPeriod:l.slowPeriod,type:this.options.type,appliedTo:l.appliedTo,isIndicatorData:!1},o=b(n);e?d[i].data[m].update({y:f.toFixed(o,4)}):d[i].addPoint([j[m].x||j[m][0],f.toFixed(o,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addKAMA&&(a.Series.prototype.addKAMA=function(a){var g=this.options.id;a=e.extend({period:21,fastPeriod:2,slowPeriod:30,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],appliedTo:f.CLOSE,parentSeriesID:g},a);var h="_"+(new Date).getTime(),i=this.options.data||[];if(!(a.period>=i.length)){if(i&&i.length>0){for(var j=[],k=0;k<i.length;k++){var l={data:{data:i,kamaData:j},index:k,period:a.period,fastPeriod:a.fastPeriod,slowPeriod:a.slowPeriod,type:this.options.type,appliedTo:a.appliedTo,isIndicatorData:!1},m=b(l);j.push([i[k].x||i[k][0],f.toFixed(m,4)])}var n=this.chart;c[h]=a;var o=this;d[h]=n.addSeries({id:h,name:"KAMA ("+a.period+", "+f.appliedPriceString(a.appliedTo)+")",data:j,type:"line",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:a.stroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:o.options.compare},!1,!1),e(d[h]).data({onChartIndicator:!0,indicatorID:"kama",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),n.redraw()}return h}},a.Series.prototype.removeKAMA=function(a){var b=this.chart;c[a]=null,b.get(a).remove(),d[a]=null},a.Series.prototype.preRemovalCheckKAMA=function(a){return{isMainIndicator:!0,period:c[a]?c[a].period:void 0,appliedTo:c[a]?c[a].appliedTo:void 0,isValidUniqueID:null!=c[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,e,h){a.call(this,b,d,e,h),f.checkCurrentSeriesHasIndicator(c,this.options.id)&&g.call(this,b[0])}),a.wrap(a.Point.prototype,"update",function(a,b,d,e){a.call(this,b,d,e),f.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&g.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});