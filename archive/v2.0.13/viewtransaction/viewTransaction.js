define(["jquery","windows/windows","websockets/binary_websockets","common/rivetsExtra","moment","lodash","jquery-growl","common/util"],function(a,b,c,d,e,f){"use strict";function g(a,b,c){var d=a.find(".transaction-chart")[0],e={title:"",credits:{href:"https://www.binary.com",text:"Binary.com"},chart:{type:"live",renderTo:d,backgroundColor:null,width:0,height:0,events:{load:function(){this.credits.element.onclick=function(){window.open("http://www.binary.com","_blank")}}}},title:{text:c,style:{fontSize:"16px"}},tooltip:{xDateFormat:"%A, %b %e, %H:%M:%S GMT"},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:f.head(b)[0],max:f.last(b)[0],labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:0,y:-2},title:""},series:[{name:c,data:b,type:"line"}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}}}},g=new Highcharts.Chart(e);return g.addPlotLineX=function(a){g.xAxis[0].addPlotLine({value:a.value,id:a.id||a.value,label:{text:a.label||"label",x:a.text_left?-15:5},color:a.color||"#e98024",width:a.width||2})},g.addPlotLineY=function(a){g.yAxis[0].addPlotLine({id:a.id||a.label,value:a.value,label:{text:a.label,align:"center"},color:"green",width:2})},d.chart=g}function h(a,b,d){var h=1*d.purchase_time,i=null,j={ticks_history:d.symbol};if("t"===d.duration_type[0])j.start=h-3,j.end=h+2*d.duration+3;else{var k={s:1,m:60,h:3600,d:86400}[d.duration_type[0]],l=d.duration*k,m={s:4,m:4,h:60,d:3600}[d.duration_type[0]];j.start=h-m,j.end=h+l+m,j.count=1e6,i=h+l}c.send(j).then(function(c){for(var j=c.history,k=j.times,l=j.prices,m=[],n=0;n<k.length;++n)m.push([1e3*k[n],1*l[n]]);a.chart.loading="";var o=d.sell_time,p=g(b,m,d.symbol_name),q=j.times.filter(function(a){return 1*a>h})[0],r=null;if("t"===d.duration_type[0]&&(r=j.times[j.times.indexOf(q)+1*d.duration]),"t"!==d.duration_type[0]&&i&&(r=f(j.times).filter(function(a){return i>=1*a}).last()),1*h!==1*q&&p.addPlotLineX({value:1e3*h,label:"Start Time",text_left:!0}),q&&p.addPlotLineX({value:1e3*q,label:"Entry Spot"}),r&&p.addPlotLineX({value:1e3*r,label:"Exit Spot",text_left:!0}),1*r>1*o&&p.addPlotLineX({value:1e3*o,label:"Sell Time"}),i&&p.addPlotLineX({value:1e3*i,label:"End Time"}),q){var s=j.prices[j.times.indexOf(q)];a.table.entry_spot=s}if(r){var t=j.prices[j.times.indexOf(r)];a.table.exit_spot=t}i&&(a.table.end_time=e.utc(1e3*i).format("YYYY-MM-DD HH:mm:ss")),a.chart.chart=p,a.chart.manual_reflow()})["catch"](function(b){a.chart.loading=b.message})}function i(a){return c.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(b){for(var c=b.trading_times.markets,d=0;d<c.length;++d)for(var e=c[d].submarkets,f=0;f<e.length;++f)for(var g=e[f].symbols,h=0;h<g.length;++h)if(g[h].symbol===a)return g[h].name;return"Transaction"})}function j(c){require(["text!viewtransaction/viewTransaction.html"]),i(c.symbol).then(function(e){c.symbol_name=e,require(["text!viewtransaction/viewTransaction.html"],function(e){var f=a(e),g=k(c,f),h=b.createBlankWindow(f,{title:c.symbol_name+" ("+c.transaction_id+")",width:700,minWidth:300,minHeight:350,destroy:function(){},resize:function(){g.chart.manual_reflow()},close:function(){i.unbind()},"data-authorized":"true"});h.dialog("open");var i=d.bind(f[0],g)})})}function k(a,b){var d={route:{value:"table",update:function(a){d.route.value=a}},longcode:a.longcode,validation:"-",table:{currency:a.currency?a.currency+" ":"USD ",now:e.utc().format("YYYY-MM-DD HH:mm:ss"),purchase_time:a.purchase_time&&e.utc(1e3*a.purchase_time).format("YYYY-MM-DD HH:mm:ss"),end_time:void 0,entry_spot:void 0,current_spot:void 0,exit_spot:void 0,purchase_price:a.buy_price&&(1*a.buy_price).toFixed(2),indicative_price:void 0,final_price:a.sell_price&&(1*a.sell_price).toFixed(2)},chart:{chart:null,loading:"Loading "+a.symbol+" ..."}};return d.chart.manual_reflow=function(){var a=-1*(b.find(".longcode").height()+b.find(".tabs").height()+b.find(".footer").height())-16;if(d.chart.chart){var c=b,e=c.width(),f=c.height();d.chart.chart.setSize(e,f+a,!1),d.chart.chart.hasUserSize=null}},c.send({proposal_open_contract:1,contract_id:a.contract_id}).then(function(a){d.validation=a.validation_error||"This contract has expired"})["catch"](function(a){d.validation=a.message}),h(d,b,a),d}return require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]),{init:j}});