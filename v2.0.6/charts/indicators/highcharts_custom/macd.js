define(["indicator_base","highstock"],function(a){function b(b,c,d,e){return 2===b[c].length?b[c][1]:a.isOHLCorCandlestick(e)?a.extractPriceForAppliedTO(d,b,c):a.extractPrice(b,c)}function c(a,c,d,e,f,g){if(e-1>d)return null;if(d===e-1){for(var h=0,i=0;e>i;i++)h+=b(a,i,g,f);return h/e}var j=b(a,d,g,f),k=c[d-1].length?c[d-1][1]:c[d-1];return(k*(e-1)+j)/e}function d(a,c,d,e,f,g){if(e-1>d)return null;if(d===e-1){for(var h=0,i=0;e>i;i++)h+=b(a,d,g,f);return h/e}var j=c[d-1].length?c[d-1][1]:c[d-1],k=b(a,d,g,f);return 2*k/(e+1)+j*(1-2/(e+1))}function e(b,c){for(var d=[],e=0,f=0;c>f;f++)if(e+=b[f][1],f===c-1){var g=e/c;$.isNumeric(g)||(g=b[f][1]),d.push([b[f][0],g])}else d.push([b[f][0],null]);for(var f=c;f<b.length;f++){var h=b[f][1],i=2*h/(c+1)+d[f-1][1]*(1-2/(c+1));d.push([b[f][0],a.toFixed(i,4)])}return d}function f(c,d,f,g,h,i){for(var j=[],k=0;k<c.length;k++){var l=b(c,k,g,f);j.push([c[k].x?c[k].x:c[k][0],l])}for(var m=e(j,d),n=e(m,d),o=e(n,d),p=[],k=0;k<o.length;k++){var q=3*m[k][1]-3*n[k][1]+o[k][1];p.push(i?[c[k].x||c[k][0],a.toFixed(q,4)]:q)}return u[h]=m,v[h]=n,w[h]=o,p}function g(c,d,e,f,g,h){var i=b(c,d,e,f),j=e.period,k=2*i/(j+1)+u[g][d-1][1]*(1-2/(j+1)),l=2*k/(j+1)+v[g][d-1][1]*(1-2/(j+1)),m=2*l/(j+1)+w[g][d-1][1]*(1-2/(j+1)),n=3*k-3*l+m;k=a.toFixed(k,4),l=a.toFixed(l,4),m=a.toFixed(m,4),n=a.toFixed(n,4);var o=c[d].x||c[d][0];return h?(u[g][d]=[o,k],v[g][d]=[o,l],w[g][d]=[o,m]):(u[g].push([o,k]),v[g].push([o,l]),w[g].push([o,m])),n}function h(a,c,d,e,f){if(d-1>c)return null;for(var g=0,h=c,i=d;h>=0&&i>=0;i--,h--){var j=b(a,h,f,e);g+=j*i}return g/(d*(d+1)/2)}function i(a,c,d,e,f,g){var h=Math.round(e+.5);if(h-1>d)return null;if(d===h-1){for(var i=0,j=0;h>j;j++)i+=b(a,j,g,f);return i/h}var k=b(a,d,g,f),l=c[d-1].length?c[d-1][1]:c[d-1];return(l*(h-1)+k)/h}function j(a,b,f,g,j,k,l){var m=null;switch(j){case z.SMA:m=c(a,b,f,g,k,l);break;case z.EMA:m=d(a,b,f,g,k,l);break;case z.WMA:m=h(a,f,g,k,l);break;case z.TEMA:m=e(a,b,f,g,k,l);break;case z.TRIMA:m=i(a,b,f,g,k,l)}return m}function k(b,c,d,e){var g=[],h=[],i=[],k=null;c.fastMaType===z.TEMA&&(g=f(b,c.fastPeriod,d,c.appliedTo,"f"+e,!1)),c.slowMaType===z.TEMA&&(h=f(b,c.slowPeriod,d,c.appliedTo,"s"+e,!1));for(var l=0;l<b.length;l++){if(c.fastMaType!=z.TEMA){var m=j(b,g,l,c.fastPeriod,c.fastMaType,d,c.appliedTo);g.push(m)}if(c.slowMaType!=z.TEMA){var n=j(b,h,l,c.slowPeriod,c.slowMaType,d,c.appliedTo);h.push(n)}l>=c.slowPeriod&&(k=g[l]-h[l]),i.push([b[l].x||b[l][0],a.toFixed(k,4)])}return x[e]=g,y[e]=h,i}function l(a,b,c,d,e,f){var h=null,i=null,k=null;return i=c.fastMaType===z.TEMA?g(a,c.fastPeriod,d,c.appliedTo,"f"+uniqueID,!1):j(a,x[e],b,c.fastPeriod,c.fastMaType,d,c.appliedTo),k=c.slowMaType===z.TEMA?g(a,c.slowPeriod,d,c.appliedTo,"s"+uniqueID,!1):j(a,y[e],b,c.slowPeriod,c.slowMaType,d,c.appliedTo),b>=c.slowPeriod&&(h=i-k),f?(x[e][b]=i,y[e][b]=k):(x[e].push(i),y[e].push(k)),h}function m(b,c,d,e){var g=[];if(c.signalMaType==z.TEMA)g=f(b,c.signalPeriod,d,c.appliedTo,"sg"+e,!0);else for(var h=0;h<b.length;h++){var i=j(b,g,h,c.signalPeriod+c.slowPeriod-1,c.signalMaType,d,c.appliedTo);g.push([b[h].x||b[h][0],a.toFixed(i,4)])}return g}function n(a,b,c,d,e){var f=null;return f=d.signalMaType===z.TEMA?g(a,d.signalPeriod,e,d.appliedTo,"sg"+uniqueID,!1):j(a,b,c,d.signalPeriod+d.slowPeriod-1,d.signalMaType,e,d.appliedTo)}function o(b,c){for(var d=[],e=0;e<b.length;e++){var f=null,g=b[e][1]||b[e].y,h=c[e][1]||c[e].y;g&&h&&(f=g-h),d.push([b[e].x||b[e][0],a.toFixed(f,4)])}return d}function p(a,b,c){var d=null,e=a[c][1]||a[c].y,f=b[c][1]||b[c].y;return e&&f&&(d=e-f),d}var q={},r={},s={},t={},u={},v={},w={},x={},y={},z={SMA:"SMA",EMA:"EMA",WMA:"WMA",TEMA:"TEMA",TRIMA:"TRIMA"};return{init:function(){!function(a,b,c){function d(a,b){{var d=this;d.chart}for(var e in r)if(r[e]&&r[e].options&&r[e].options.data&&r[e].options.data.length>0&&q[e].parentSeriesID==d.options.id){var f=d.options.data,g=q[e],h=c.findIndexInDataForTime(f,a);if(h>=1){var i=l(f,h,g,this.options.type,e,b&&r[e].options.data.length>=f.length);b?r[e].data[h].update({y:c.toFixed(i,4)}):r[e].addPoint([f[h].x||f[h][0],c.toFixed(i,4)],!0,!0,!1)}}}function e(a,b){{var d=this;d.chart}for(var e in s)if(s[e]&&s[e].options&&s[e].options.data&&s[e].options.data.length>0&&q[e].parentSeriesID==d.options.id){var f=d.options.data,g=q[e],h=c.findIndexInDataForTime(f,a),i=s[e].options.data,j=e.replace("s","m"),k=r[j].options.data;if(h>=1){var l=n(k,i,h,g,this.options.type,e,b&&s[e].options.data.length>=f.length);l&&!isNaN(l)&&(b?s[e].data[h].update({y:c.toFixed(l,4)}):s[e].addPoint([f[h].x||f[h][0],c.toFixed(l,4)],!0,!0,!1))}}}function f(a,b){{var d=this;d.chart}for(var e in t)if(t[e]&&t[e].options&&t[e].options.data&&t[e].options.data.length>0&&q[e].parentSeriesID==d.options.id){var f=d.options.data,g=e.replace("h","m"),h=r[g].options.data,i=e.replace("h","s"),j=s[i].options.data,k=(q[e],c.findIndexInDataForTime(f,a));if(k>=1){var l=p(h,j,k);b?t[e].data[k].update({y:c.toFixed(l,4)}):t[e].addPoint([f[k].x||f[k][0],c.toFixed(l,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addMACD&&(a.Series.prototype.addMACD=function(a){var d=this.options.id;a=b.extend({fastPeriod:12,slowPeriod:26,signalPeriod:9,fastMaType:"EMA",slowMaType:"EMA",signalMaType:"EMA",macdStroke:"red",signalLineStroke:"#A52A2A",macdHstgrmColor:"#A52A2A",strokeWidth:1,dashStyle:"line",appliedTo:c.CLOSE,parentSeriesID:d},a);var e=(new Date).getTime(),f="m-"+e,g="s-"+e,h="h-"+e,i=this.options.data||[];if(i&&i.length>0){var j=k(i,a,this.options.type,f),l=m(j,a,this.options.type,g),n=o(j,l),p=this.chart;q[f]=a,q[g]=a,q[h]=a,p.addAxis({id:"macd"+f,title:{text:"MACD",align:"high",offset:0,rotation:0,y:10,x:35},lineWidth:2},!1,!1,!1),c.recalculate(p);var u=this;t[h]=p.addSeries({id:h,name:"MACD (HISTOGRAM, "+c.appliedPriceString(a.appliedTo)+")",data:n,type:"column",yAxis:"macd"+f,dataGrouping:u.options.dataGrouping,opposite:u.options.opposite,color:a.macdHstgrmColor,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:u.options.compare},!1,!1);var u=this;r[f]=p.addSeries({id:f,name:"MACD ("+a.fastPeriod+","+c.appliedPriceString(a.appliedTo)+")",data:j,type:"line",yAxis:"macd"+f,dataGrouping:u.options.dataGrouping,opposite:u.options.opposite,color:a.macdStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:u.options.compare},!1,!1);var u=this;s[g]=p.addSeries({id:g,name:"MACD (SIGNAL,"+a.signalPeriod+","+c.appliedPriceString(a.appliedTo)+")",data:l,type:"line",yAxis:"macd"+f,dataGrouping:u.options.dataGrouping,opposite:u.options.opposite,color:a.signalLineStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:u.options.compare},!1,!1),b(t[h]).data({onChartIndicator:!0,indicatorID:"macd",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.slowPeriod}),b(r[f]).data({onChartIndicator:!0,indicatorID:"macd",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.fastPeriod}),b(s[g]).data({onChartIndicator:!0,indicatorID:"macd",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.signalPeriod}),p.redraw()}},a.Series.prototype.removeMACD=function(a){var b=this.chart,d=a.replace("m-","").replace("s-","").replace("h-","");["m","s","h"].forEach(function(a){var c=a+"-"+d;"TEMA"===q[c].maType&&(ema1Data[c]=[],ema2Data[c]=[],ema3Data[c]=[]),q[c]=null,b.get(c).remove(),r[c]=null,s[c]=null,t[c]=null}),b.get("macd"+a).remove(!1),c.recalculate(b),b.redraw()},a.Series.prototype.preRemovalCheckMACD=function(a){var b=void 0;return q[a]&&(b="MACD ("+q[a].fastPeriod+","+q[a].slowPeriod+","+q[a].signalPeriod+","+c.appliedPriceString(q[a].appliedTo)+")"),{isMainIndicator:0===a.indexOf("m-"),fastPeriod:q[a]?q[a].fastPeriod:void 0,slowPeriod:q[a]?q[a].slowPeriod:void 0,signalPeriod:q[a]?q[a].signalPeriod:void 0,fastMaType:q[a]?q[a].fastMaType:void 0,slowMaType:q[a]?q[a].slowMaType:void 0,signalMaType:q[a]?q[a].signalMaType:void 0,isValidUniqueID:null!=q[a],indicatorName:b}},a.wrap(a.Series.prototype,"addPoint",function(a,b,g,h,i){a.call(this,b,g,h,i),c.checkCurrentSeriesHasIndicator(q,this.options.id)&&(d.call(this,b[0]),e.call(this,b[0]),f.call(this,b[0]))}),a.wrap(a.Point.prototype,"update",function(a,b,g,h){a.call(this,b,g,h),c.checkCurrentSeriesHasIndicator(q,this.series.options.id)&&(d.call(this.series,this.x,!0),e.call(this.series,this.x,!0),f.call(this.series,this.x,!0))}))}(Highcharts,jQuery,a)}}});