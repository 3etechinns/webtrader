define(["indicator_base","highstock"],function(a){function b(b){var c=(a.getPrice(b.data,b.index,a.HIGH,b.type)+a.getPrice(b.data,b.index,a.LOW,b.type)+a.getPrice(b.data,b.index,a.CLOSE,b.type))/3,d=b.data[b.index][0]||b.data[b.index].x;if(b.isPointUpdate?f[b.key][b.index]=[d,c]:f[b.key].push([d,c]),b.index<b.period-1)return e[b.key].push([d,null]),g[b.key].push([d,null]),null;for(var h={data:f[b.key],maData:e[b.key],index:b.index,period:b.period,maType:b.maType,type:b.type,key:b.key,isPointUpdate:b.isPointUpdate,isIndicatorData:!0},i=a.calculateMAValue(h),j=0,k=0;k<b.period-1;k++)j+=Math.abs(i-f[b.key][b.index-k][1]);var l=j/b.period,m=(c-i)/(.015*l);return b.isPointUpdate?(e[b.key][b.index]=[d,i],g[b.key][b.index]=[d,l]):(e[b.key].push([d,i]),g[b.key].push([d,l])),m}var c={},d={},e={},f={},g={};return{init:function(){!function(a,h,i){function j(a,e){var f=this,g=f.chart;for(var h in d)if(d[h]&&d[h].options&&d[h].options.data&&d[h].options.data.length>0&&c[h].parentSeriesID===f.options.id&&d[h].chart===g){var j=f.options.data,k=c[h],l=i.findIndexInDataForTime(j,a);if(l>=1){var m={data:j,index:l,period:k.period,maType:k.maType,type:this.options.type,key:h,isPointUpdate:e,isIndicatorData:!1},n=b(m);e?d[h].data[l].update({y:i.toFixed(n,4)}):d[h].addPoint([j[l].x||j[l][0],i.toFixed(n,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addCCI&&(a.Series.prototype.addCCI=function(a){var j=this.options.id;a=h.extend({period:20,maType:"SMA",strokeColor:"red",strokeWidth:1,dashStyle:"line",parentSeriesID:j},a);var k="_"+(new Date).getTime(),l=this.options.data||[];if(l&&l.length>0){var m=[];f[k]=[],e[k]=[],g[k]=[];for(var n=0;n<l.length;n++){var o={data:l,index:n,period:a.period,maType:a.maType,type:this.options.type,key:k,isPointUpdate:!1,isIndicatorData:!1},p=b(o);m.push([l[n][0]||l[n].x,null!=p?i.toFixed(p,4):null])}var q=this.chart;c[k]=a,q.addAxis({id:"cci"+k,title:{text:"CCI",align:"high",offset:0,rotation:0,y:10,x:35},lineWidth:2},!1,!1,!1),i.recalculate(q);var r=this;d[k]=q.addSeries({id:k,name:"CCI ("+a.period+")",data:m,type:"line",yAxis:"cci"+k,dataGrouping:r.options.dataGrouping,opposite:r.options.opposite,color:a.strokeColor,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:r.options.compare},!1,!1),h(d[k]).data({onChartIndicator:!0,indicatorID:"cci",isIndicator:!0,parentSeriesID:a.parentSeriesID}),q.redraw()}},a.Series.prototype.removeCCI=function(a){var b=this.chart;c[a]=null,b.get(a).remove(!1),d[a]=null,b.get("cci"+a).remove(!1),i.recalculate(b),b.redraw()},a.Series.prototype.preRemovalCheckCCI=function(a){return{isMainIndicator:!0,isValidUniqueID:null!=c[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,e,f){a.call(this,b,d,e,f),i.checkCurrentSeriesHasIndicator(c,this.options.id)&&j.call(this,b[0])}),a.wrap(a.Point.prototype,"update",function(a,b,d,e){a.call(this,b,d,e),i.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&j.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});