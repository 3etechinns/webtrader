define(["indicator_base","highstock"],function(a){function b(b){var c=b.data.data[b.index][0]||b.data.data[b.index].x,d=Math.round(b.period/2),h={data:b.data.data,maData:e[b.key],index:b.index,period:d,maType:b.maType,type:b.type,key:"n"+b.key,isPointUpdate:b.isPointUpdate,appliedTo:b.appliedTo,isIndicatorData:!1},i=a.calculateMAValue(h);b.isPointUpdate?e[b.key][b.index]=[c,i]:e[b.key].push([c,i]);var j={data:b.data.data,maData:f[b.key],index:b.index,period:b.period,maType:b.maType,type:b.type,key:"p"+b.key,isPointUpdate:b.isPointUpdate,appliedTo:b.appliedTo,isIndicatorData:!1},k=a.calculateMAValue(j);b.isPointUpdate?f[b.key][b.index]=[c,k]:f[b.key].push([c,k]);var l=2*i-k;b.isPointUpdate?g[b.key][b.index]=[c,l]:g[b.key].push([c,l]);var m=Math.round(Math.sqrt(b.period,2)),n={data:g[b.key],maData:b.data.hmaData,index:b.index,period:m,maType:b.maType,type:b.type,key:"h"+b.key,isPointUpdate:b.isPointUpdate,appliedTo:b.appliedTo,isIndicatorData:!0};return a.calculateMAValue(n)}var c={},d={},e={},f={},g={};return{init:function(){!function(a,h,i){function j(a,e){var f=this,g=f.chart;for(var h in d)if(d[h]&&d[h].options&&d[h].options.data&&d[h].options.data.length>0&&c[h].parentSeriesID===f.options.id&&d[h].chart===g){var j=f.options.data,k=d[h].options.data,l=c[h],m=i.findIndexInDataForTime(j,a);if(m>=1){var n={data:{data:j,hmaData:k},index:m,period:l.period,maType:l.maType,type:this.options.type,key:h,isPointUpdate:e,appliedTo:l.appliedTo,isIndicatorData:!1},o=b(n);e?d[h].data[m].update({y:i.toFixed(o,4)}):d[h].addPoint([j[m].x||j[m][0],i.toFixed(o,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addHMA&&(a.Series.prototype.addHMA=function(a){var j=this.options.id;a=h.extend({period:20,maType:"SMA",appliedTo:i.CLOSE,strokeColor:"red",strokeWidth:1,dashStyle:"line",parentSeriesID:j},a);var k="_"+(new Date).getTime(),l=this.options.data||[];if(l&&l.length>0){var m=[];e[k]=[],f[k]=[],g[k]=[];for(var n=0;n<l.length;n++){var o={data:{data:l,hmaData:m},index:n,period:a.period,maType:a.maType,type:this.options.type,key:k,isPointUpdate:!1,appliedTo:a.appliedTo,isIndicatorData:!1},p=b(o);m.push([l[n][0]||l[n].x,i.toFixed(p,4)])}var q=this.chart;c[k]=a;var r=this;d[k]=q.addSeries({id:k,name:"HMA ("+a.period+", "+i.appliedPriceString(a.appliedTo)+")",data:m,type:"line",dataGrouping:r.options.dataGrouping,opposite:r.options.opposite,color:a.strokeColor,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:r.options.compare},!1,!1),h(d[k]).data({onChartIndicator:!0,indicatorID:"hma",isIndicator:!0,parentSeriesID:a.parentSeriesID}),q.redraw()}},a.Series.prototype.removeHMA=function(a){var b=this.chart;c[a]=null,b.get(a).remove(!1),d[a]=null,e[a]=[],f[a]=[],g[a]=[],b.redraw()},a.Series.prototype.preRemovalCheckHMA=function(a){return{isMainIndicator:!0,isValidUniqueID:null!=c[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,e,f){a.call(this,b,d,e,f),i.checkCurrentSeriesHasIndicator(c,this.options.id)&&j.call(this,b[0])}),a.wrap(a.Point.prototype,"update",function(a,b,d,e){a.call(this,b,d,e),i.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&j.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});