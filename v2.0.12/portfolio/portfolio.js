define(["jquery","windows/windows","websockets/binary_websockets","jquery-ui","datatables","jquery-growl"],function(a,b,c){"use strict";function d(a){a.click(function(){h?h.moveToTop():f()})}function e(a){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(c&&i){var e=i.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=i.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}function f(){require(["css!portfolio/portfolio.css"]),c.send({balance:1}).then(function(d){var f=function(){"minimized"===h.dialogExtend("state")&&h.dialogExtend("restore"),c.send({balance:1})["catch"](function(b){a.growl.error({message:b.message})}),g()};c.events.on("balance",function(a){l=a.balance.currency,j.update(a.balance.balance)}),c.events.on("transaction",function(a){a.transaction;g()}),h=b.createBlankWindow(a("<div/>"),{title:"Portfolio",width:700,minHeight:60,"data-authorized":"true",close:function(){c.send({forget_all:"proposal_open_contract"})["catch"](function(a){}),c.events.on("proposal_open_contract",e)},open:function(){f(),c.send({proposal_open_contract:1,subscribe:1})["catch"](function(b){a.growl.error({message:b.message})}),c.events.on("proposal_open_contract",e)},destroy:function(){i&&i.DataTable().destroy(!0),h=null},refresh:f});var k=h.parent().find(".ui-dialog-title").addClass("with-content");j=a('<span class="span-in-dialog-header" />').insertAfter(k),j.update=function(a){j.html("Account balance: <strong>"+l+" "+formatPrice(a)+"</strong>")};var l=d.balance.currency;i=a("<table width='100%' class='portfolio-dialog display compact'/>"),i.appendTo(h),i=i.dataTable({data:[],columns:[{title:"Ref."},{title:"Contract Details"},{title:"Purchase",render:function(a){return l+' <span class="bold">'+a+"</span>"}},{title:"Indicative",render:function(a){return l+' <span class="bold">'+a+"</span>"}}],rowId:"4",paging:!1,ordering:!1,processing:!0}),i.parent().addClass("hide-search-input"),h.dialog("open")})["catch"](function(a){})}function g(){var b=a("#"+i.attr("id")+"_processing").show();c.send({portfolio:1}).then(function(a){var d=a.portfolio&&a.portfolio.contracts,e=d.map(function(a){return[a.transaction_id,a.longcode,formatPrice(a.buy_price),"0.00",a.contract_id]});i.api().rows().remove(),i.api().rows.add(e),i.api().draw(),b.hide(),d.forEach(function(a){c.send({proposal_open_contract:1,contract_id:a.contract_id})["catch"](function(a){})})})["catch"](function(c){i.api().rows().remove(),i.api().draw(),b.hide(),a.growl.error({message:c.message})})}var h=null,i=null,j=null;return{init:d}});