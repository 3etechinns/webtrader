define([],function(){function a(a){var b=a.toUpperCase().replace("D","").replace("M","").replace("W",""),c=""==b?1:parseInt(b),d=a.toUpperCase().replace(""+c,"");return{suffix:d,intVal:c}}function b(a,b){var c=0;switch(a){case"M":c=60*b;break;case"H":c=60*b*60;break;case"D":c=24*b*60*60}return c}function c(a,b,c,d,e,f,g){if(!(g.length>0&&g[g.length-1][0]>e))if(f&&isDataTypeClosePriceOnly(f)){if(!$.isNumeric(e)||!$.isNumeric(d))return;g.push([e,d])}else{if(!($.isNumeric(e)&&$.isNumeric(a)&&$.isNumeric(b)&&$.isNumeric(c)&&$.isNumeric(d)))return;g.push([e,a,b,c,d])}}function d(a,b,c,d,e,f){if(a){var g=b.length,h=b.length>30?g-30:0;a.xAxis[0].range=b[g-1][0]-b[h][0];var i=a.addSeries({id:e,name:d,data:b,type:c?c:"candlestick",dataGrouping:{enabled:!1},compare:f});i.isDirty=!0,$(i).data("isInstrument",!0),i.isDirtyData=!0,$(document).oneTime(1e3,null,function(){i.addCurrentPrice(),a.redraw()}),a.hideLoading()}}return{retrieveChartDataAndRender:function(c,d,e,f,g,h,i,j,k){var l=a(c),m=l.suffix,n=l.intVal,o=b(m,n);var p=1e3;"D"==m&&n>1&&(p=Math.floor(p/n));var q=Math.ceil((new Date).getTime()/1e3),r=q-p*o,s=Math.ceil((q-r)/o);if(isTick(c)&&(s=1e3),i[(d+c).toUpperCase()]={tickStreamingID:"",chartIDs:[{containerIDWithHash:e,series_compare:h,instrumentCode:d,instrumentName:g}]};var t={ticks:d,end:"latest",count:s,adjust_start_time:1,instrumentCdAndTp:(d+c).toUpperCase()};isTick(c)||(t=$.extend(t,{start:r,granularity:m+n})),{var j=e,k=f[j].chartIDs;if(i){var l=void 0;k.forEach(function(a){return a.containerIDWithHash==i?(l=a,!1):void 0});var m=$(i).highcharts(),n=g.chain().find({instrumentCdAndTp:j}).simplesort("time",!1).data(),o=[],p=$(i).data("type");for(var q in n)c(n[q].open,n[q].high,n[q].low,n[q].close,n[q].time,p,o);{var l=k[r];if(h){var s=$(l.containerIDWithHash).highcharts().get(e),t=s.data[s.data.length-1].x||s.data[s.data.length-1].time,n=g.chain().find({instrumentCdAndTp:j}).where(function(a){return a.time>=t}).simplesort("time",!1).data();for(var r in n){for(var u=n[r],v=void 0,w=s.data.length-1;w>=0;w--){var x=s.data[w];if(x&&u.time==(x.x||x.time)){v=x;break}}v?v.update(p&&isDataTypeClosePriceOnly(p)?[u.time,u.close]:[u.time,u.open,u.high,u.low,u.close]):p&&isDataTypeClosePriceOnly(p)?s.addPoint([u.time,u.close],!1,!1):s.addPoint([u.time,u.open,u.high,u.low,u.close],!1,!1),s.isDirty=!0,s.isDirtyData=!0}s.chart.redraw()}else{var m=$(l.containerIDWithHash).highcharts(),n=g.chain().find({instrumentCdAndTp:j}).simplesort("time",!1).data(),o=[],p=$(l.containerIDWithHash).data("type");for(var q in n)c(n[q].open,n[q].high,n[q].low,n[q].close,n[q].time,p,o);d(m,o,p,l.instrumentName,j,l.series_compare,l.instrumentCode)}}if($.isEmptyObject(f[j].tickStreamingID)){var l=f[j].chartIDs[0],y=$(l.containerIDWithHash).data("instrumentCode"),z=$(l.containerIDWithHash).data("timeperiod");if($(document).trigger("sendAnyWSMessage",[{ticks:l.instrumentCode,instrumentCdAndTp:j}]),isTick(z))return;for(var n=g.chain().find({instrumentCdAndTp:j}).simplesort("time",!0).limit(1).data(),A=a(z),B=A.suffix,C=A.intVal,D=b(B,C),E=n[0].time,F=E+1e3*D,G=new Date;F<G.getTime();)F+=1e3*D;if(b&&b.length>0){b=b[0],var c=a(z),d=c.suffix,e=c.intVal,f={ticks:y,end:"latest",instrumentCdAndTp:j,start:b.time/1e3,granularity:d+e,isTimer:"true"};