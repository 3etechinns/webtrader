define(["jquery","charts/chartingRequestMap","websockets/binary_websockets","websockets/ohlc_handler","currentPriceIndicator","charts/indicators/highcharts_custom/indicators","moment","lodash","text!charts/indicators/indicators.json","highcharts-exporting","common/util","paralleljs","jquery-growl"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(a){var c=a.containerIDWithHash,d=a.timePeriod,e=a.instrumentCode;if(d&&e){var f=b.keyFor(e,d);b.unregister(f,c)}}function k(c,d){var e=d.instrumentName+" ("+d.timePeriod+").csv",f=[],i=[],j=function(a){var b=null;if(h.isArray(a)&&a.length>3){var c=a[0];b='"'+g.utc(c).format("YYYY-MM-DD HH:mm")+'",'+a.slice(1,a.length).join(",")}else b=h.isNumber(a.high)?'"'+g.utc(a.time).format("YYYY-MM-DD HH:mm")+'",'+a.open+","+a.high+","+a.low+","+a.close:h.isArray(a)&&a.length>1?'"'+g.utc(a[0]).format("YYYY-MM-DD HH:mm")+'",'+a[1]:h.isObject(a)&&a.title&&a.text?a instanceof FractalUpdateObject?'"'+g.utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+(a.isBull?"UP":a.isBear?"DOWN":" "):'"'+g.utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+a.text:h.isNumber(a.y)?'"'+g.utc(a.x||a.time).format("YYYY-MM-DD HH:mm")+'",'+(a.y||a.close):a.toString();return b};c.series.forEach(function(a,c){if("navigator"===a.options.id)return!0;var e=a.options.data.map(function(a){return j(a)})||[];if(0==c){var h=e[0].split(",").length>2;f.push(h?"Date,Open,High,Low,Close":'Date,"'+a.options.name+'"');var k=b.keyFor(d.instrumentCode,d.timePeriod),l=b.barsTable.chain().find({instrumentCdAndTp:k}).simplesort("time",!1).data();f=f.concat(l.map(function(a){return h?['"'+g.utc(a.time).format("YYYY-MM-DD HH:mm")+'"',a.open,a.high,a.low,a.close].join(","):['"'+g.utc(a.time).format("YYYY-MM-DD HH:mm")+'"',a.close].join(",")}))}else f[0]+=',"'+a.options.name+'"',i.push(e)}),a.growl.notice({message:"Downloading CSV"}),new Parallel([f,i]).spawn(function(a){var b=a[0],c=a[1];return b=b.map(function(a){return c.forEach(function(b){var c=!1;b.forEach(function(b){if(b){var d=b.split(",");if(a.split(",")[0]===d[0])return a+=","+d.slice(1,d.length).join(","),c=!0,!1}}),-1!=a.indexOf("Date")||c||(a+=",")}),a})}).then(function(a){var b=a.join("\n"),c=new Blob([b],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(c,e);else{var d=document.createElement("a");if(void 0!==d.download){var f=URL.createObjectURL(c);d.setAttribute("href",f),d.setAttribute("download",e),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d)}}},function(b){a.growl.error({message:"Error downloading CSV"})})}return a(function(){var a=h(JSON.parse(i)).values().map("id").value();a.push("data");var b=Highcharts.Series.prototype.update;Highcharts.Series.prototype.update=function(){var a=this,c={};h.each(c,function(b){a[b]&&(c[b]=a[b])}),b.apply(this,arguments),h.each(c,function(b,c){a[c]=b})},Highcharts.setOptions({global:{useUTC:!0},lang:{thousandsSep:","}})}),f.initHighchartIndicators(b.barsTable),{drawChart:function(f,g,j){var l=[];if(a(f).highcharts()){var m=b.keyFor(g.instrumentCode,g.timePeriod);b.removeChart(m,f);var n=a(f).highcharts();if(n.series.length>0){var o=h(JSON.parse(i)).values().map("id").value();o.forEach(function(a){n.series[0][a]&&l.push({id:a,options:n.series[0][a][0].options})})}n.destroy()}a(f).data({instrumentCode:g.instrumentCode,instrumentName:g.instrumentName,timePeriod:g.timePeriod,type:g.type,delayAmount:g.delayAmount}),a(f).highcharts("StockChart",{chart:{events:{load:function(){this.showLoading(),e.init(),c.execute(function(){d.retrieveChartDataAndRender({timePeriod:g.timePeriod,instrumentCode:g.instrumentCode,containerIDWithHash:f,type:g.type,instrumentName:g.instrumentName,series_compare:g.series_compare,delayAmount:g.delayAmount}).then(function(){var b=a(f).highcharts();l.forEach(function(a){b.series[0].addIndicator(a.id,a.options)})})}),a.isFunction(j)&&j(),this.credits.element.onclick=function(){window.open("http://www.binary.com","_blank")}}},spacingLeft:0,marginLeft:45},navigator:{enabled:!0,series:{id:"navigator"}},plotOptions:{candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!1},series:{events:{afterAnimate:function(){this.options.isInstrument&&"navigator"!==this.options.id&&(this.removeCurrentPrice(),this.addCurrentPrice()),this.chart.hideLoading()}}}},title:{text:"true"===getParameterByName("affiliates")?g.instrumentName+" ("+g.timePeriod+")":""},credits:{href:"http://www.binary.com",text:"Binary.com"},xAxis:{events:{afterSetExtremes:function(){}},labels:{formatter:function(){var a=this.axis.defaultLabelFormatter.call(this);return a.replace(".","")}},ordinal:!1},scrollbar:{liveRedraw:!1},yAxis:[{opposite:!1,labels:{formatter:function(){return a(f).data("overlayIndicator")?(this.value>0?" + ":"")+this.value+"%":this.value},align:"center"}}],rangeSelector:{enabled:!1},tooltip:{crosshairs:[{width:2,color:"red",dashStyle:"dash"},{width:2,color:"red",dashStyle:"dash"}],enabled:!0,enabledIndicators:!0},exporting:{enabled:!0,buttons:{contextButton:{menuItems:[{text:"Download PNG",onclick:function(){this.exportChartLocal()}},{text:"Download SVG",onclick:function(){this.exportChartLocal({type:"image/svg+xml"})},separator:!1},{text:"Download CSV",onclick:function(){k(a(f).highcharts(),a(f).data())},separator:!1}]}},filename:g.instrumentName.split(" ").join("_")+"("+g.timePeriod+")"}})},destroy:j,triggerReflow:function(b){a(b).highcharts()&&a(b).highcharts().reflow()},refresh:function(b){var c=a(b).highcharts(),d=[],e=void 0;a(c.series).each(function(a,b){b.options.isInstrument&&(d.push(b.name),e=b.options.compare)}),this.drawChart(b,{instrumentCode:a(b).data("instrumentCode"),instrumentName:a(b).data("instrumentName"),timePeriod:a(b).data("timePeriod"),type:a(b).data("type"),series_compare:e,delayAmount:a(b).data("delayAmount")});var f=this;require(["instruments/instruments"],function(c){d.forEach(function(d){var e=c.getSpecificMarketData(d);void 0!=e.symbol&&a.trim(e.symbol)!=a(b).data("instrumentCode")&&f.overlay(b,e.symbol,d,e.delay_amount)})})},addIndicator:function(b,c){if(a(b).highcharts()){var d=a(b).highcharts(),e=d.series[0];e&&d.addIndicator(a.extend({id:e.options.id},c))}},overlay:function(b,e,f,g){if(a(b).highcharts()){var h=a(b).highcharts(),i=a(b).data("timePeriod"),j=a(b).data("type");h.showLoading();for(var k=0;k<h.series.length;k++){var l=h.series[k];(l.options.isInstrument||l.options.onChartIndicator)&&l.update({compare:"percent"})}c.execute(function(){d.retrieveChartDataAndRender({timePeriod:i,instrumentCode:e,containerIDWithHash:b,type:j,instrumentName:f,series_compare:"percent",delayAmount:g})})}}}});