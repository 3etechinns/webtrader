define(["exports","text!./workspace.html","../common/rivetsExtra","jquery","../websockets/binary_websockets","../windows/tracker","jquery-growl","css!./workspace.css"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.tileDialogs=a.events=a.addDialog=a.init=void 0;var h=g(b),i=g(c),j=g(d),k=g(e),l=g(f),m="my-workspace-1";!function(){var a=local_storage.get("states");a&&!a.name&&(a.name=m,local_storage.set("states",a))}();var n=function(a){return JSON.parse(JSON.stringify(a))},o={route:"all",workspaces:local_storage.get("workspaces")||[],dialogs:[],update_route:function(a){return o.route=a},hide_submenu:function(){"submenu"===o.route&&(o.route="active")},tileDialogs:function(){return s()},closeAll:function(){return j["default"](".webtrader-dialog").dialog("close")},workspace:{remove:function(a){var b=o.workspaces.indexOf(a);-1!==b&&o.workspaces.splice(b,1),local_storage.set("workspaces",o.workspaces)},show:function(a){var b=a.tradeDialog&&a.tradeDialog.length;return b=b||a.portfolio||a.statement||a.profitTable||a.deposit||a.withdraw,b&&!k["default"].is_authenticated()?void j["default"].growl.notice({message:"Please log in to see your saved workspace.".i18n()}):(o.closeAll(),void _.delay(function(){o.current_workspace.name=a.name,local_storage.set("states",a),l["default"].reopen(n(a))},500))}},current_workspace:{name:(local_storage.get("states")||{}).name||"my-workspace-1",name_perv_value:"",is_saved:function(){return-1!==_.findIndex(o.workspaces,{name:o.current_workspace.name})},save:function(){var a=o.current_workspace,b=a.name,c=a.is_saved;if(!c())return o.saveas.show();var d=local_storage.get("states");d.name=b;var e=_.findIndex(o.workspaces,{name:d.name});o.workspaces[e]=d,o.workspaces=n(o.workspaces),local_storage.set("workspaces",o.workspaces),j["default"].growl.notice({message:"Workspace changes saved".i18n()})}},rename:{show:function(){o.current_workspace.name_perv_value=o.current_workspace.name,o.route="rename"},apply:function(){var a=o.current_workspace,b=a.name,c=a.name_perv_value;if(!b||b===c)return o.rename.cancel();if(_.find(o.workspaces,{name:b})){var d=b.match(/\d+$/),e=d?parseInt(d[0]):0;for(b=b.replace(/\d+$/,"");_.find(o.workspaces,{name:b+e});)e+=1;b+=e}var f=_.find(o.workspaces,{name:c});f&&(f.name=b,local_storage.set("workspaces",o.workspaces)),o.current_workspace.name=b,o.route="active"},cancel:function(){o.current_workspace.name=o.current_workspace.name_perv_value,o.route="active"}},saveas:{show:function(){o.current_workspace.name_perv_value=o.current_workspace.name,o.route="saveas"},apply:function(){{var a=o.current_workspace,b=a.name;a.name_perv_value}if(!b)return o.saveas.cancel();if(_.find(o.workspaces,{name:b})){var c=b.match(/\d+$/),d=c?parseInt(c[0]):0;for(b=b.replace(/\d+$/,"");_.find(o.workspaces,{name:b+d});)d+=1;b+=d}var e=local_storage.get("states");e.name=b,o.workspaces.push(e),local_storage.set("workspaces",o.workspaces),o.current_workspace.name=b,o.route="active"},cancel:function(){return o.rename.cancel()}},file:{hash_code:function(a){return JSON.stringify(a).split("").reduce(function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0)},open_selector:function(a){var b=j["default"](a.target).closest(".workspace-manager");b.find("input[type=file]").click()},upload:function(a){var b=a.target.files[0];if(a.target.value=null,b){var c=new FileReader;c.onload=function(a){var b=a.target.result,c=null;try{c=JSON.parse(b);var d=c.random;if(delete c.random,d!==o.file.hash_code(c))throw"Invalid JSON file".i18n();if("workspace-template"!==c.template_type)throw"Invalid template type.".i18n()}catch(a){return void j["default"].growl.error({message:a})}if(_.find(o.workspaces,{name:c.name})){{name.match(/\d+$/)}return void j["default"].growl.error({message:"Template name already exists".i18n()})}delete c.template_type,delete c.random,o.workspaces.push(c),local_storage.set("workspaces",o.workspaces),j["default"].growl.notice({message:"Successfully added workspace as ".i18n()+"<b>"+c.name+"</b>"})},c.readAsText(b)}},download:function(){var a=o.current_workspace.name,b=_.findIndex(o.workspaces,{name:a}),c=-1!==b?o.workspaces[b]:local_storage.get("states");c.name=a,c.template_type="workspace-template",c.random=o.file.hash_code(c);var d=JSON.stringify(c);download_file_in_browser(c.name+".json","text/json;charset=utf-8;",d),j["default"].growl.notice({message:"Downloading workspace as %1".i18n().replace("%1","<b>"+c.name+".json</b>")})}}};o.current_workspace.root=o;var p=a.init=function(a){var b=j["default"](h["default"]);a.append(b),i["default"].bind(b[0],o)},q=a.addDialog=function(a,b,c){var d={name:a,click:function(){return b()},remove:function(){e(),c()}},e=function(){var a=o.dialogs.indexOf(d);-1!==a&&o.dialogs.splice(a,1)};return o.dialogs.push(d),e},r=a.events=j["default"]("<div/>"),s=function(){for(var a=function(a){for(var b=void 0,c=void 0,d=a.length;d>0;)c=Math.floor(Math.random()*d),--d,b=a[d],a[d]=a[c],a[c]=b;return a},b=j["default"](".webtrader-dialog").filter(function(a,b){var c=j["default"](b);return c.hasClass("ui-dialog-content")&&c.dialog("isOpen")&&!c.hasClass("ui-dialog-minimized")&&j["default"](window).width()>=c.dialog("option","width")}),c=function(a,b){var c=0,d=j["default"](window).width(),e=115;j["default"]("#msg-notification").is(":visible")&&(e=150);for(var f=0;f<a.length;){for(var g=f,h=0,i=0;f!=a.length;){var k=j["default"](a[f]),l=k.dialog("option","width"),m=k.dialog("option","height");if(h=Math.max(h,m),!(d>=i+l))break;i+=l,++f}var n=d>i?d-i:0,o=d>i?(d-i)/(f-g+1):0;f!=a.length&&(c+=n),0===i&&j["default"](a[f]).dialog("option","width")>d&&(++f,o=0),i=0;for(var p=g;f>p;++p){i+=o;{var q=j["default"](a[p]),r=q.dialog("option","width");q.dialog("option","height")}b&&q.dialog("widget").animate({left:i+"px",top:e+"px"},1500,q.trigger.bind(q,"animated")),q.dialog("option","position",{my:i,at:e}),i+=r}e+=h+20}return c},d=null,e=1e6,f=0;100>f;++f){a(b);var g=c(b,!1);e>g&&(d=b.slice(),e=g)}var h=j["default"](".webtrader-dialog").filter(function(a,b){var c=j["default"](b);return c.hasClass("ui-dialog-content")&&c.dialog("isOpen")&&!c.hasClass("ui-dialog-minimized")&&j["default"](window).width()<c.dialog("option","width")});_(h).forEach(function(a){d.push(a)}),c(d,!0),setTimeout(function(){return r.trigger("tile")},1600)};a.tileDialogs=s,a["default"]={init:p,addDialog:q,events:r,tileDialogs:s}});