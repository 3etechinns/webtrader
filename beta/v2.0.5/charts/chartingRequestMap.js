define(["lokijs","jquery","common/util"],function(a,b){function c(a){var c=a;if(this[c]){var d=this[c].chartIDs,f=this.processOHLC;d.forEach(function(a){if(a){var d=b(a.containerIDWithHash).highcharts().get(c),g=b(a.containerIDWithHash).data("type");if(d){var h=d.data[d.data.length-1].x||d.data[d.data.length-1].time,i=e.chain().find({instrumentCdAndTp:c}).where(function(a){return a.time>=h}).simplesort("time",!1).data();for(var j in i){for(var k=i[j],l=void 0,m=d.data.length-1;m>=0;m--){var n=d.data[m];if(n&&k.time==(n.x||n.time)){l=n;break}}l?g&&isDataTypeClosePriceOnly(g)?l.update([k.time,k.close],!1):l.update([k.time,k.open,k.high,k.low,k.close],!1):g&&isDataTypeClosePriceOnly(g)?d.addPoint([k.time,k.close],!1,!0):d.addPoint([k.time,k.open,k.high,k.low,k.close],!1,!0)}d.isDirty=!0,d.isDirtyData=!0,d.chart.redraw()}else{var o=b(a.containerIDWithHash).highcharts(),p=[],i=e.chain().find({instrumentCdAndTp:c}).simplesort("time",!1).data();for(var q in i)f(i[q].open,i[q].high,i[q].low,i[q].close,i[q].time,g,p);if(!o)return;var r=p.length,s=p.length>30?r-30:0,t=a.instrumentName,u=a.series_compare,v=0;o.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++v}),0===v&&(o.xAxis[0].range=p[r-1][0]-p[s][0]);var w={id:c,name:t,data:p,type:g?g:"candlestick",dataGrouping:{enabled:!1},compare:u,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(g)||isDotType(g))&&(w.type="line",isDotType(g)&&(w.dashStyle="dot"),w.marker={enabled:!isDotType(g),radius:4}),o.addSeries(w)}}})}}var d=new a,e=d.addCollection("bars_table");return{barsTable:e,processOHLC:function(a,c,d,e,f,g,h){if(!(h.length>0&&h[h.length-1][0]>f))if(g&&isDataTypeClosePriceOnly(g)){if(!b.isNumeric(f)||!b.isNumeric(e))return;h.push([f,e])}else{if(!(b.isNumeric(f)&&b.isNumeric(a)&&b.isNumeric(c)&&b.isNumeric(d)&&b.isNumeric(e)))return;h.push([f,a,c,d,e])}},barsLoaded:c}});