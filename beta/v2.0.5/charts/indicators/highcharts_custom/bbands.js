define(["indicator_base","highstock"],function(a){function b(b,c,d,e){var f=0;return f=a.isOHLCorCandlestick(e)?a.extractPriceForAppliedTO(d.appliedTo,b,c):a.extractPrice(b,c)}function c(a,c,d,e,f){for(var g=0,h=0;h<d.period&&c>=0;h++){var i=b(a,c,d,e),j=Math.pow(i-f,2);g+=j,--c}return Math.sqrt(g/h)}function d(c,d,e,f,g){var h=null;if(e>=1){var i=b(c,e,f,g);h=a.toFixed(((d[e-1].y||d[e-1][1])*(f.period-1)+i)/f.period,4)}return h}function e(a,c,e){for(var f=[],g=0,h=0;h<c.period;h++)g+=b(a,h,c,e),f.push(h==c.period-1?[a[c.period-1].x?a[c.period-1].x:a[c.period-1][0],g/c.period]:[a[h].x?a[h].x:a[h][0],null]);for(var h=c.period;h<a.length;h++){var i=d(a,f,h,c,e);f.push([a[h].x||a[h][0],i])}return f}function f(a,c,d,e,f){var g=b(a,d,e,f);return 2*g/(e.period+1)+(c[d-1][1]||c[d-1].y)*(1-2/(e.period+1))}function g(c,d,e){for(var g=[],h=0,i=0;i<d.period;i++)h+=b(c,i,d,e),g.push(i==d.period-1?[c[d.period-1].x?c[d.period-1].x:c[d.period-1][0],h/d.period]:[c[i].x?c[i].x:c[i][0],null]);for(var i=d.period;i<c.length;i++){var j=f(c,g,i,d,e);g.push([c[i].x||c[i][0],a.toFixed(j,4)])}return g}function h(b,c){for(var d=[],e=0,f=0;c>f;f++)if(e+=b[f][1],f==c-1){var g=e/c;$.isNumeric(g)||(g=b[f][1]),d.push([b[f][0],g])}else d.push([b[f][0],null]);for(var f=c;f<b.length;f++){var h=b[f][1],i=2*h/(c+1)+d[f-1][1]*(1-2/(c+1));d.push([b[f][0],a.toFixed(i,4)])}return d}function i(c,d,e,f){for(var g=[],i=0;i<c.length;i++){var j=b(c,i,d,e);g.push([c[i].x?c[i].x:c[i][0],j])}for(var k=h(g,d.period),l=h(k,d.period),m=h(l,d.period),n=[],i=0;i<m.length;i++){var o=3*k[i][1]-3*l[i][1]+m[i][1];n.push([m[i][0],a.toFixed(o,4)])}return w[f]=k,x[f]=l,y[f]=m,n}function j(c,d,e,f,g,h){var i=b(c,d,e,f),j=e.period,k=2*i/(j+1)+w[g][d-1][1]*(1-2/(j+1)),l=2*k/(j+1)+x[g][d-1][1]*(1-2/(j+1)),m=2*l/(j+1)+y[g][d-1][1]*(1-2/(j+1)),n=3*k-3*l+m;k=a.toFixed(k,4),l=a.toFixed(l,4),m=a.toFixed(m,4),n=a.toFixed(n,4);var o=c[d].x||c[d][0];return h?(w[g][d]=[o,k],x[g][d]=[o,l],y[g][d]=[o,m]):(w[g].push([o,k]),x[g].push([o,l]),y[g].push([o,m])),n}function k(a,c,d,e){for(var f=0,g=d,h=c.period;g>=0&&h>=0;h--,g--){var i=b(a,g,c,e);f+=i*h}return f/(c.period*(c.period+1)/2)}function l(b,c,d){for(var e=[],f=0;f<c.period;f++)e.push([b[c.period-1].x?b[c.period-1].x:b[c.period-1][0],null]);for(var f=c.period;f<b.length;f++){var g=k(b,c,f,d);e.push([b[f].x||b[f][0],a.toFixed(g,4)])}return e}function m(a,c,d,e,f,g){var h=b(a,d,e,f);return(c[d-1][1]*(g-1)+h)/g}function n(b,c,d){for(var e=[],f=0,g=c.period+1,h=Math.round(g/2),i=0;h>i;i++)f+=a.isOHLCorCandlestick(d)?a.extractPriceForAppliedTO(c.appliedTo,b,i):a.extractPrice(b,i),e.push(i==h-1?[b[h-1].x?b[h-1].x:b[h-1][0],f/h]:[b[i].x?b[i].x:b[i][0],null]);for(var i=h;i<b.length;i++){var j=m(b,e,i,c,d,h);e.push([b[i].x||b[i][0],a.toFixed(j,4)])}return e}function o(a,b,c,e,g,h,i){var l=null;switch(e.maType){case"SMA":l=d(a,b,c,e,g);break;case"EMA":l=f(a,b,c,e,g);break;case"WMA":l=k(a,e,c,g);break;case"TEMA":l=j(a,c,e,g,h,i);break;case"TRIMA":var n=Math.round((e.period+1)/2);l=m(a,b,c,e,g,n)}return l}function p(a,b,c,d){var f=[];switch(b.maType){case"SMA":f=e(a,b,c);break;case"EMA":f=g(a,b,c);break;case"WMA":f=l(a,b,c);break;case"TEMA":f=i(a,b,c,d);break;case"TRIMA":f=n(a,b,c)}return f}function q(b,d,e,f){for(var g=[],h=0;h<b.length;h++){var i=d[h][1],j=c(b,h,e,f,i),k=i-j*e.devDn;g.push([b[h].x||b[h][0],a.toFixed(k,4)])}return g}function r(b,d,e,f){for(var g=[],h=0;h<b.length;h++){var i=d[h][1],j=c(b,h,e,f,i),k=i+j*e.devDn;g.push([b[h].x||b[h][0],a.toFixed(k,4)])}return g}var s={},t={},u={},v={},w={},x={},y={};return{init:function(){!function(a,b,d){function e(a,b){{var c=this;c.chart}for(var e in t)if(t[e]&&t[e].options&&t[e].options.data&&t[e].options.data.length>0&&s[e].parentSeriesID==c.options.id){var f=c.options.data,g=t[e].options.data,h=s[e],i=(t[e].options.data,d.findIndexInDataForTime(f,a));if(i>=1){var j=o(f,g,i,h,this.options.type,e,b&&t[e].options.data.length>=f.length);b?t[e].data[i].update({y:d.toFixed(j,4)}):t[e].addPoint([f[i].x||f[i][0],d.toFixed(j,4)],!0,!0,!1)}}}function f(a,b){{var e=this;e.chart}for(var f in u)if(u[f]&&u[f].options&&u[f].options.data&&u[f].options.data.length>0&&s[f].parentSeriesID==e.options.id){var g=e.options.data,h=(u[f].options.data,f.replace("u","m")),i=t[h].options.data,j=s[f],k=d.findIndexInDataForTime(g,a);if(k>=1){var l=i[k][1]||i[k].y,m=c(g,k,j,this.options.type,l),n=l+m*j.devDn;b?u[f].data[k].update({y:d.toFixed(n,4)}):u[f].addPoint([g[k].x||g[k][0],d.toFixed(n,4)],!0,!0,!1)}}}function g(a,b){{var e=this;e.chart}for(var f in v)if(v[f]&&v[f].options&&v[f].options.data&&v[f].options.data.length>0&&s[f].parentSeriesID==e.options.id){var g=e.options.data,h=(v[f].options.data,f.replace("l","m")),i=t[h].options.data,j=s[f],k=d.findIndexInDataForTime(g,a);if(k>=1){var l=i[k][1]||i[k].y,m=c(g,k,j,this.options.type,l),n=l-m*j.devDn;b&&v[f].options.data.length>=g.length?v[f].data[k].update({y:d.toFixed(n,4)}):v[f].addPoint([g[k].x||g[k][0],d.toFixed(n,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addBBANDS&&(a.Series.prototype.addBBANDS=function(a){var c=this.options.id;a=b.extend({period:20,devUp:2,devDn:2,maType:"SMA",mdlBndStroke:"red",uprBndStroke:"#A52A2A",lwrBndStroke:"#A52A2A",strokeWidth:1,dashStyle:"line",appliedTo:d.CLOSE,parentSeriesID:c},a);var e=(new Date).getTime(),f="m-"+e,g="u-"+e,h="l-"+e,i=this.options.data||[];if(i&&i.length>0){var j=p(i,a,this.options.type,f),k=r(i,j,a,this.options.type),l=q(i,j,a,this.options.type),m=this.chart;s[f]=a,s[g]=a,s[h]=a;var n=this;t[f]=m.addSeries({id:f,name:"BBANDS (Middle,"+a.period+","+a.devUp+","+a.devDn+","+d.appliedPriceString(a.appliedTo)+")",data:j,type:"line",dataGrouping:n.options.dataGrouping,opposite:n.options.opposite,color:a.mdlBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:n.options.compare},!1,!1);var n=this;u[g]=m.addSeries({id:g,name:"BBANDS (Upper,"+a.period+","+a.devUp+","+a.devDn+","+d.appliedPriceString(a.appliedTo)+")",data:k,type:"line",dataGrouping:n.options.dataGrouping,opposite:n.options.opposite,color:a.uprBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:n.options.compare},!1,!1);var n=this;v[h]=m.addSeries({id:h,name:"BBANDS (Lower,"+a.period+","+a.devUp+","+a.devDn+","+d.appliedPriceString(a.appliedTo)+")",data:l,type:"line",dataGrouping:n.options.dataGrouping,opposite:n.options.opposite,color:a.lwrBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:n.options.compare},!1,!1),b(t[f]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(u[g]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(v[h]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),m.redraw()}},a.Series.prototype.removeBBANDS=function(a){var b=this.chart,c=a.replace("m-","").replace("l-","").replace("u-","");["m","u","l"].forEach(function(a){var d=a+"-"+c;"TEMA"===s[d].maType&&(w[d]=[],x[d]=[],y[d]=[]),s[d]=null,b.get(d).remove(),t[d]=null,u[d]=null,v[d]=null}),b.redraw()},a.Series.prototype.preRemovalCheckBBANDS=function(a){var b=void 0;return s[a]&&(b="BBANDS ("+s[a].period+","+s[a].devUp+","+s[a].devDn+","+d.appliedPriceString(s[a].appliedTo)+")"),{isMainIndicator:0===a.indexOf("m-"),period:s[a]?s[a].period:void 0,appliedTo:s[a]?s[a].appliedTo:void 0,devUp:s[a]?s[a].devUp:void 0,devDn:s[a]?s[a].devDn:void 0,maType:s[a]?s[a].maType:void 0,isValidUniqueID:null!=s[a],indicatorName:b}},a.wrap(a.Series.prototype,"addPoint",function(a,b,c,h,i){a.call(this,b,c,h,i),d.checkCurrentSeriesHasIndicator(s,this.options.id)&&(e.call(this,b[0]),f.call(this,b[0]),g.call(this,b[0]))}),a.wrap(a.Point.prototype,"update",function(a,b,c,h){a.call(this,b,c,h),d.checkCurrentSeriesHasIndicator(s,this.series.options.id)&&(e.call(this.series,this.x,!0),f.call(this.series,this.x,!0),g.call(this.series,this.x,!0))}))}(Highcharts,jQuery,a)}}});