define(["indicator_base","highstock"],function(a){function b(b,c,d){for(var e=0,f=b,g=c.period;f>=0&&g>=0;g--,f--){var h=0;h=a.isOHLCorCandlestick(this.options.type)?a.extractPriceForAppliedTO(c.appliedTo,d,f):d[f].y?d[f].y:d[f][1],e+=h*g}return e/(c.period*(c.period+1)/2)}var c={},d={};return{init:function(){!function(a,e,f){function g(a,e){var g=this,h=(g.chart,g.options.data);for(var i in d)if(d[i]&&d[i].options&&d[i].options.data&&d[i].options.data.length>0&&c[i].parentSeriesID==g.options.id){var j=(d[i].options.data,f.findIndexInDataForTime(h,a));if(j>=1){var k=b.call(this,j,c[i],h);k=f.toFixed(k,4),e?d[i].data[j].update({y:k}):d[i].addPoint([h[j].x||h[j][0],k],!0,!0,!1)}}}a&&!a.Series.prototype.addWMA&&(a.Series.prototype.addWMA=function(a){var g=this.options.id;a=e.extend({period:21,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],appliedTo:f.CLOSE,parentSeriesID:g},a);var h="_"+(new Date).getTime(),i=this.options.data||[];if(!(a.period>=i.length)){if(i&&i.length>0){for(var j=[],k=0;k<a.period;k++)j.push([i[a.period-1].x?i[a.period-1].x:i[a.period-1][0],null]);for(var k=a.period;k<i.length;k++){var l=b.call(this,k,a,i);j.push([i[k].x||i[k][0],f.toFixed(l,4)])}var m=this.chart;c[h]=a;var n=this;d[h]=m.addSeries({id:h,name:"WMA ("+a.period+", "+f.appliedPriceString(a.appliedTo)+")",data:j,type:"line",dataGrouping:n.options.dataGrouping,opposite:n.options.opposite,color:a.stroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:n.options.compare},!1,!1),e(d[h]).data({onChartIndicator:!0,indicatorID:"wma",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),m.redraw()}return h}},a.Series.prototype.removeWMA=function(a){var b=this.chart;c[a]=null,b.get(a).remove(),d[a]=null},a.Series.prototype.preRemovalCheckWMA=function(a){return{isMainIndicator:!0,period:c[a]?c[a].period:void 0,appliedTo:c[a]?c[a].appliedTo:void 0,isValidUniqueID:null!=c[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,e,h){a.call(this,b,d,e,h),f.checkCurrentSeriesHasIndicator(c,this.options.id)&&g.call(this,b[0])}),a.wrap(a.Point.prototype,"update",function(a,b,d,e){a.call(this,b,d,e),f.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&g.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});