{"version":3,"sources":["../../../../src/charts/chartTemplateManager.es6"],"names":["define","$","chartWindow","rv","require","local_storage","get","set","ChartTemplateManager","root","dialog_id","state","init_state","append","html","view","bind","chart","highcharts","route","value","menu","save_changes_disabled","templates","array","save_as_value","rename_tmpl","rename_value","current","current_tmpl","get_chart_options","_","findIndex","t","name","update","save_as","options","timePeriod","type","concat","indicators","map","ind","overlays","overlay","displaySymbol","join","substring","save_changes","inx","push","growl","notice","message","text","i18n","includes","error","set_chart_options","remove","tmpl","filter","rename","do_rename","new_name","find","apply","apply_chart_options","confirm","event","console","log","action","currentTarget","confirm_prevMenu","confirm_text","confirm_yes","confirm_no","unbind","init"],"mappings":"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","file":"chartTemplateManager.js","sourcesContent":["/**\n * Created by amin on July 31, 2016.\n */\ndefine(['jquery', 'charts/chartWindow', 'common/rivetsExtra'], function($, chartWindow, rv) {\n  require(['text!charts/chartTemplateManager.html']);\n\n  if(!local_storage.get('templates')) {\n    local_storage.set('templates', []);\n  }\n\n  class ChartTemplateManager {\n    constructor(root, dialog_id) {\n      const state = this.init_state(root, dialog_id);\n      require(['text!charts/chartTemplateManager.html'], html => {\n        root.append(html);\n        this.view = rv.bind(root[0], state);\n      });\n    }\n\n    init_state(root, dialog_id) {\n      const chart = $('#' + dialog_id + '_chart').highcharts();\n      const state = {\n        route: { value: 'menu' },\n        menu: {\n          save_changes_disabled: true\n        },\n        templates: {\n          array: local_storage.get('templates'),\n          save_as_value: '',\n          rename_tmpl: null,\n          rename_value: '',\n          current: null,\n        }\n      };\n      const {route, templates, menu} = state;\n\n      /* persist applied templates between page reloads */\n      const current_tmpl = chartWindow.get_chart_options(dialog_id);\n      if(_.findIndex(templates.array, t => t.name === current_tmpl.name) !== -1) {\n        templates.current = current_tmpl;\n      }\n\n      route.update = value => {\n        route.value = value;\n      };\n\n      menu.save_as = () => {\n        const options = chartWindow.get_chart_options(dialog_id) || {};\n        options.name = [`${options.timePeriod} ${options.type}`]\n                      .concat(options.indicators.map(ind => ind.name))\n                      .concat(options.overlays.map(overlay => overlay.displaySymbol))\n                      .join(' + ');\n        templates.save_as_value = options.name.substring(0,20);\n        route.update('save-as');\n      }\n\n      menu.templates = () => {\n        templates.array = local_storage.get('templates'); // it can be modified from other dialogs.\n        route.update('templates');\n      }\n\n      menu.save_changes = () => {\n        const current = chartWindow.get_chart_options(dialog_id);\n\n        const name = current.name;\n        const array = local_storage.get('templates');\n        const inx = _.findIndex(array, t => t.name === name);\n        if(inx !== -1) {\n          array[inx] = current;\n        } else {\n          array.push(current);\n        }\n        local_storage.set('templates', array);\n        templates.array = array;\n        templates.current = current;\n        $.growl.notice({message: $(\"<div/>\").text('Template changes saved '.i18n() + '(' + current.name + ')').html()});\n      }\n\n      templates.save_as = () => {\n        const name = templates.save_as_value.substring(0,20);\n        const options = chartWindow.get_chart_options(dialog_id);\n        if(options) {\n          options.name = name;\n          const array = local_storage.get('templates');\n          if(array.map(t => t.name).includes(name)) {\n            $.growl.error({message: 'Template name already exists'.i18n() });\n            return;\n          }\n          array.push(options);\n          templates.current = options;\n          local_storage.set('templates', array);\n          templates.array = array;\n          route.update('menu');\n          chartWindow.set_chart_options(dialog_id, options); /* update the name */\n        }\n      }\n\n      templates.remove = (tmpl) => {\n        let array = local_storage.get('templates');\n        templates.array = array.filter(t => t.name !== tmpl.name);\n        local_storage.set('templates', templates.array);\n        if(templates.current && tmpl.name === templates.current.name) {\n          templates.current = null;\n        }\n      }\n\n      templates.rename = tmpl => {\n        templates.rename_value = tmpl.name;\n        templates.rename_tmpl = tmpl;\n        route.update('rename');\n      }\n\n      templates.do_rename = () => {\n        const name = templates.rename_tmpl.name;\n        const new_name = templates.rename_value.substring(0,20);\n        const array = local_storage.get('templates');\n        if(array.map(t => t.name).includes(new_name)) {\n            $.growl.error({message: 'Template name already exists'.i18n() });\n            return;\n        };\n        const tmpl = array.find(t => t.name === name);\n        if(tmpl) {\n          tmpl.name = new_name;\n          local_storage.set('templates', array);\n          templates.array = array;\n          route.update('templates');\n\n          /* update template name in chartWindow options */\n          const current = chartWindow.get_chart_options(dialog_id);\n          if(current.name == name) {\n            templates.current = current;\n            current.name = new_name;\n            chartWindow.set_chart_options(dialog_id, current);\n          }\n        }\n      }\n\n      templates.apply = tmpl => {\n        chartWindow.apply_chart_options(dialog_id, tmpl);\n        templates.current = tmpl;\n      }\n\n      templates.confirm = (tmpl, event) => {\n        route.update(\"confirm\");\n        console.log(event);\n        const action = event.currentTarget.text;\n        templates.confirm_prevMenu = action === \"Delete\".i18n() ? \"templates\" : \"menu\";\n        templates.confirm_text = action === \"Delete\" ? \"Are you sure you want to delete template?\".i18n() : \"Are you sure you want to overwrite current template?\".i18n();\n        \n        templates.confirm_yes = () => {\n          action === \"Delete\".i18n()? templates.remove(tmpl) : menu.save_changes();\n          templates.confirm_no();\n        }\n\n        templates.confirm_no = () => {\n          route.update(templates.confirm_prevMenu);\n        }\n      }\n\n      return state;\n    }\n\n    unbind() {\n      this.view && this.view.unbind();\n      this.view = null;\n    }\n  }\n\n  return {\n    init: (root, dialog_id) => new ChartTemplateManager(root, dialog_id)\n  }\n});\n"]}