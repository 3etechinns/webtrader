{"version":3,"sources":["../../../../src/cashier/deposit.es6"],"names":["define","$","liveapi","windows","rv","_","moment","require","deposit_win","deposit_win_view","error_handler","err","console","error","growl","message","init","li","click","init_deposit_win","moveToTop","root","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","dialog","trigger","remove","open","destroy","unbind","init_state","offset","top","my","left","at","css","fixFooterPosition","track","module_id","is_unique","app_id","state","route","value","empty_fields","validate","clear","debounce","show","user","email","local_storage","get","cashier_url","residence","residence_name","standard_methods","iframe_visible","payment_agents","list","current","update","iframe_loaded","get_commission_text","agent","deposit_commission","withdrawal_commission","i18n","onclick","e","warn","target","elem","next","cur_elem","is_active","scrollHeight","bind","send","cashier","then","data","catch","residence_promise","get_settings","country_code","country","paymentagent_list","cached","map","commission_text","supported_banks","toLowerCase","split"],"mappings":"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","file":"deposit.js","sourcesContent":["/*\n * Created by amin on June 26, 2016.\n */\n\ndefine(['jquery', 'websockets/binary_websockets', 'windows/windows', 'common/rivetsExtra', 'lodash', 'moment'], function($, liveapi, windows, rv, _, moment) {\n    require(['text!cashier/deposit.html']);\n    require(['css!cashier/deposit.css']);\n    var deposit_win = null;\n    var deposit_win_view = null; // rivets view\n\n    var error_handler = function(err) {\n      console.error(err);\n      $.growl.error({ message: err.message });\n    };\n\n    function init(li) {\n      li.click(() => {\n          if(!deposit_win)\n            require(['text!cashier/deposit.html'], init_deposit_win);\n          else\n            deposit_win.moveToTop();\n      });\n    }\n\n    function init_deposit_win(root) {\n      root = $(root);\n      deposit_win = windows.createBlankWindow(root, {\n          title: 'Deposit funds',\n          resizable: true,\n          collapsable: false,\n          minimizable: true,\n          maximizable: true,\n          width: 700,\n          height: 600,\n          'data-authorized': true,\n          close: function () {\n            deposit_win.dialog('destroy');\n            deposit_win.trigger('dialogclose'); // TODO: figure out why event is not fired.\n            deposit_win.remove();\n            deposit_win = null;\n          },\n          open: function () { },\n          destroy: function() {\n            deposit_win_view && deposit_win_view.unbind();\n            deposit_win_view = null;\n          }\n      });\n\n      init_state(root);\n      deposit_win.dialog('open');\n\n      /* update dialog position, this way when dialog is resized it will not move*/\n      var offset = deposit_win.dialog('widget').offset();\n      offset.top = 110;\n      deposit_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\n      deposit_win.dialog('widget').css({\n          left: offset.left + 'px',\n          top: offset.top + 'px'\n      });\n      deposit_win.fixFooterPosition();\n      deposit_win.track({\n        module_id: 'deposit',\n        is_unique: true\n      });\n    }\n\n    function init_state(root) {\n      var app_id = liveapi.app_id;\n      var state = {\n        route: { value: 'standard-methods'},\n        empty_fields: {\n          validate: false,\n          clear: _.debounce(function() {\n            state.empty_fields.validate = false;\n          }, 4000),\n          show: function() {\n            state.empty_fields.validate = true;\n            state.empty_fields.clear();\n          }\n        },\n        user: {\n          email: local_storage.get('authorize').email,\n          cashier_url:'',\n          residence: '',\n          residence_name: ''\n        },\n        standard_methods: {\n          iframe_visible: false,\n        },\n        payment_agents: {\n          list: [],\n          current: {}\n        }\n      };\n\n      state.route.update = route => { state.route.value = route; };\n\n      state.standard_methods.iframe_loaded = function() {\n        if(state.user.cashier_url)\n          state.standard_methods.iframe_visible = true;\n      }\n\n      state.payment_agents.get_commission_text = function(agent) {\n        if(agent.deposit_commission === agent.withdrawal_commission) {\n            return agent.deposit_commission + '% ' + 'commission'.i18n();\n        }\n        return agent.deposit_commission + '% ' + 'deposits'.i18n() + ' / ' +\n               agent.withdrawal_commission + '% ' + 'withdrawals'.i18n();\n      }\n      state.payment_agents.onclick = function(agent, e){\n        console.warn(e.target);\n        var elem = $(e.target).next();\n        var cur_elem = state.payment_agents.elem;\n        cur_elem && cur_elem.css('max-height', '0');\n        state.payment_agents.current.is_active = false;\n        if(state.payment_agents.current === agent) {\n          state.payment_agents.current = {};\n        }\n        else {\n          state.payment_agents.current = agent;\n          state.payment_agents.elem = elem;\n          elem.css('max-height', elem[0].scrollHeight + 'px');\n          agent.is_active = true;\n        }\n      }\n\n      deposit_win_view = rv.bind(root[0], state);\n\n      /* get the cashier_url */\n      liveapi.send({\n        cashier: 'deposit'\n      }).then(function(data) {\n          state.user.cashier_url = data.cashier;\n      }).catch(error_handler);\n\n      /* get the residence field and its states */\n      var residence_promise = liveapi.send({get_settings: 1})\n             .then(function(data){\n               state.user.residence = data.get_settings.country_code;\n               state.user.residence_name = data.get_settings.country;\n             })\n             .catch(error_handler);\n\n      /* get payment agents list */\n      residence_promise.then(function() {\n        if(!state.user.residence)\n          return { paymentagent_list: { list: [] } };\n        return liveapi.cached.send({paymentagent_list: state.user.residence });\n      }).then(function(data){\n        var list = data.paymentagent_list.list.map(function(agent){\n          agent.commission_text = state.payment_agents.get_commission_text(agent);\n          agent.supported_banks = agent.supported_banks.toLowerCase().split(',');\n          return agent;\n        })\n        state.payment_agents.list = list;\n      }).catch(error_handler);\n    }\n\n    return {\n      init: init\n    }\n});\n"]}