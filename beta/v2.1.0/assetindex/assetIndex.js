define(["jquery","windows/windows","websockets/binary_websockets","navigation/menu","lodash","datatables","jquery-growl"],function(a,b,c,d,e){function f(c){require(["css!assetindex/assetIndex.css"]),c.click(function(){var c=local_storage.get("windows")||{};c.windows=c.windows||[],-1==e.findIndex(c.windows,function(a){return a.isAsset})&&(c.windows.push({isAsset:!0}),local_storage.set("windows",c)),k?k.moveToTop():(k=b.createBlankWindow(a("<div/>"),{title:"Asset Index",width:750,minHeight:70,close:function(){c=local_storage.get("windows")||{};var a=e.findIndex(c.windows,function(a){return a.isAsset});a>=0&&(c.windows.splice(a,1),local_storage.set("windows",c))}}),k.dialog("open"),require(["text!assetindex/assetIndex.html"],i))})}function g(a){a=d.extractChartableMarkets(a);var b={};return a.forEach(function(a){var c=b[a.display_name]={};a.submarkets.forEach(function(a){c[a.display_name]=a.instruments.map(function(a){return a.display_name})})}),b}function h(){var d=[],e={},f=function(a,b){var c=e[a][b],f=d.filter(function(a){return c.indexOf(a[1])>-1}).map(function(a){var b=a[2].map(function(a){return a[2]+" - "+a[3]});return b.unshift(a[1]),b});j.api().rows().remove(),j.api().rows.add(f),j.api().draw()},h=a("#"+j.attr("id")+"_processing").show();Promise.all([c.cached.send({trading_times:(new Date).toISOString().slice(0,10)}),c.cached.send({asset_index:1})]).then(function(c){try{d=c[1].asset_index,e=g(c[0]);var i=(k.parent().find(".ui-dialog-title").addClass("with-content"),k.parent().find(".ui-dialog-titlebar-buttonpane")),j=b.makeSelectmenu(a("<select />").insertBefore(i),{list:Object.keys(e),inx:1,changed:function(a){var b=Object.keys(e[a]);l.update_list(b),f(j.val(),l.val())},width:"120px"});j.selectmenu("widget").addClass("asset-index-selectmenu");var l=b.makeSelectmenu(a("<select />").insertBefore(i),{list:Object.keys(e[j.val()]),inx:0,changed:function(){f(j.val(),l.val())},width:"135px"});l.selectmenu("widget").addClass("asset-index-selectmenu"),f(j.val(),l.val()),h.hide()}catch(m){}})["catch"](function(b){a.growl.error({message:b.message})})}function i(b){b=a(b),j=b.filter("table"),b.appendTo(k),j=j.dataTable({data:[],columnDefs:[{className:"dt-body-center dt-header-center",targets:[0,1,2,3,4]},{defaultContent:"-",targets:[0,1,2,3,4]}],paging:!1,ordering:!1,searching:!0,processing:!0}),j.parent().addClass("hide-search-input"),j.api().column(0).every(function(){var b=this;a("input",this.header()).on("keyup change",function(){b.search()!==this.value&&b.search(this.value).draw()})}),h()}var j=null,k=null;return{init:f}});