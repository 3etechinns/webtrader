define(["jquery","lodash","datatables"],function(a,b){function c(d,e,f){a.each(e,function(e,g){g.submarkets||g.instruments?c(d,g.submarkets||g.instruments,f):a(d.row.add([g.display_name]).node()).data({symbol:g.symbol,delay_amount:g.delay_amount}).click(function(){a(".overlay_dialog_add").dialog("close");var c=a(this).data("symbol"),d=a(this).data("delay_amount"),e=a(this).text(),g=(a(f).data("timePeriod"),a(f).data("type"));require(["charts/chartOptions","charts/charts","common/util"],function(h,i){var j=function(){a(f).data("overlayIndicator",!0);var b=f.replace("#","").replace("_chart","");h.isCurrentViewInLogScale(b)&&h.triggerToggleLogScale(b),h.disableEnableLogMenu(b,!1),h.disableEnableCandlestick(b,!1),h.disableEnableOHLC(b,!1),i.overlay(f,c,e,d)};"candlestick"===g||"ohlc"==g?(a(f).data("type","line"),i.refresh(f),b.defer(j)):j()})})})}function d(b,d,e){b.find("tbody tr").remove();var f=b.find("table").DataTable();f.clear().draw(),c(f,d.getMarketData(),e),f.draw(),a(".overlay_dialog_add").dialog("open")}function e(b){require(["instruments/instruments"],function(c){a.isEmptyObject(c.getMarketData())?require(["jquery","jquery-growl"],function(a){a.growl.error({message:"Market data is not loaded yet!"})}):require(["text!overlay/overlay_add.html"],function(e){e=a(e),e.hide(),e.appendTo("body"),e.find("table").DataTable({paging:!1,scrollY:200,info:!1}),a(".overlay_dialog_add").dialog({autoOpen:!1,resizable:!1,modal:!0,my:"center",at:"center",of:window,buttons:[]}),d(e,c,b)})})}return{openDialog:function(b){return 0==a(".overlay_dialog_add").length?void e(b):void require(["instruments/instruments"],function(c){d(a(".overlay_dialog_add"),c,b)})}}});