define(["jquery","windows/windows","websockets/binary_websockets","lodash","common/rivetsExtra","moment","jquery-growl","common/util"],function(a,b,c,d,e,f){function g(){return h?Promise.resolve(!0):new Promise(function(d){c.cached.authorize().then(function(f){j.loginId=f.authorize.loginid,c.cached.send({landing_company_details:f.authorize.landing_company_name}).then(function(c){c&&c.landing_company_details.has_reality_check?require(["text!realitycheck/realitycheck.html","css!realitycheck/realitycheck.css"],function(c){var f=a(c);f.find(".realitycheck_firstscreen").show(),f.find(".realitycheck_secondscreen").hide(),h=b.createBlankWindow(a("<div/>"),{title:"Reality check",width:600,minHeight:90,height:220,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,closable:!1,modal:!0,closeOnEscape:!1,ignoreTileAction:!0,"data-authorized":"true"}),f.appendTo(h),a("body").append(h.dialog("widget")),e.bind(f[0],j),d()}):local_storage.remove("realitycheck")})})})}var h=null,i=null,j={timeOutInMins:(local_storage.get("realitycheck")||{}).timeOutInMins||10,timeOutMin:10,timeOutMax:120,loginId:null,durationInMins:null,bought:null,turnOver:null,loginTime:null,sold:null,pnl:null,currentTime:null,open:null,potentialProfit:null,currency:null,continueTrading:function(b,c){return c.timeOutInMins<c.timeOutMin||c.timeOutInMins>c.timeOutMax?void a.growl.error({message:"Please enter a number between "+c.timeOutMin+" to "+c.timeOutMax}):(h.dialog("close"),local_storage.set("realitycheck",{timeOutInMins:0|c.timeOutInMins,accepted_time:f.utc().valueOf()}),void k(c.timeOutInMins))},logout:function(){c.invalidate()}},k=function(a){i&&clearTimeout(i);var b=60*a*1e3;i=setTimeout(function(){c.send({reality_check:1}).then(function(a){var b=f.utc().valueOf()-1e3*a.reality_check.start_time,c=1728e5;b>c&&(b=c),j.durationInMins=f.duration(b).humanize(),j.bought=a.reality_check.buy_count,j.turnOver=a.reality_check.buy_amount,j.loginTime=f.utc(1e3*a.reality_check.start_time).format("MMM D, YYYY hh:mm")+" GMT",j.sold=a.reality_check.sell_count,j.pnl=a.reality_check.sell_amount-a.reality_check.buy_amount,j.currentTime=f.utc().format("MMM D, YYYY hh:mm")+" GMT",j.open=a.reality_check.open_contract_count,j.potentialProfit=a.reality_check.potential_profit,j.currency=a.reality_check.currency;var d=h.dialog("widget");d.find(".realitycheck_firstscreen").hide(),d.find(".realitycheck_secondscreen").show(),h.dialog({height:310}),h.moveToTop()})},b)},l=function(){h&&h.dialog("close"),i&&clearTimeout(i),i=null,j.timeOutInMins=10,j.loginId=null,j.durationInMins=null,j.bought=null,j.turnOver=null,j.loginTime=null,j.sold=null,j.pnl=null,j.currentTime=null,j.open=null,j.potentialProfit=null,j.currency=null},m=function(){l();var a=local_storage.get("realitycheck");if(a){var b=(f.utc().valueOf()-a.accepted_time)/60/1e3;g().then(b>=a.timeOutInMins?function(){var a=h.dialog("widget");a.find(".realitycheck_firstscreen").show(),a.find(".realitycheck_secondscreen").hide(),h.dialog("open")}:function(){k(Math.abs(a.timeOutInMins-b))})}else g().then(function(){var a=h.dialog("widget");a.find(".realitycheck_firstscreen").show(),a.find(".realitycheck_secondscreen").hide(),h.dialog("open")})};return c.events.on("login",m),c.events.on("logout",function(){l(),local_storage.remove("realitycheck")}),{}});