define(["indicator_base","highstock"],function(a){function b(b){var c=b.data,d=b.mamaData,p=b.index,q=b.fastLimit,r=b.slowLimit,s=b.type,t=b.key,u=b.appliedTo,v=c[p].x||c[p][0],w=a.getPrice(c,p,u,s);if(10>=p)e[t][p]=[v,0],f[t][p]=[v,0],h[t][p]=[v,0],i[t][p]=[v,0],j[t][p]=[v,0],k[t][p]=[v,0],l[t][p]=[v,0],m[t][p]=[v,0],g[t][p]=[v,0],n[t][p]=[v,0],o[t][p]=[v,0];else if(p>10){e[t][p]=[v,(4*a.getPrice(c,p,u,s)+3*a.getPrice(c,p-1,u,s)+2*a.getPrice(c,p-2,u,s)+1*a.getPrice(c,p-3,u,s))/10],f[t][p]=[v,(.0962*e[t][p][1]+.5769*e[t][p-2][1]+.5769*e[t][p-4][1]+.0962*e[t][p-6][1])*(.075*g[t][p-1][1]+.054)],i[t][p]=[v,(.0962*f[t][p][1]+.5769*f[t][p-2][1]+.5769*f[t][p-4][1]+.0962*f[t][p-6][1])*(.075*g[t][p-1][1]+.054)],h[t][p]=[v,f[t][p-3][1]];var x=(.0962*h[t][p][1]+.5769*h[t][p-2][1]+.5769*h[t][p-4][1]+.0962*h[t][p-6][1])*(.075*g[t][p-1][1]+.054),y=(.0962*i[t][p][1]+.5769*i[t][p-2][1]+.5769*i[t][p-4][1]+.0962*i[t][p-6][1])*(.075*g[t][p-1][1]+.054);j[t][p]=[v,h[t][p][1]-y],k[t][p]=[v,i[t][p][1]+x],j[t][p]=[v,.2*j[t][p][1]+.8*j[t][p-1][1]],k[t][p]=[v,.2*k[t][p][1]+.8*k[t][p-1][1]],l[t][p]=[v,j[t][p][1]*j[t][p-1][1]+k[t][p][1]*k[t][p-1][1]],m[t][p]=[v,j[t][p][1]*k[t][p-1][1]-k[t][p][1]*j[t][p-1][1]],l[t][p]=[v,.2*l[t][p][1]+.8*l[t][p-1][1]],m[t][p]=[v,.2*m[t][p][1]+.8*m[t][p-1][1]],g[t][p]=[v,0],0!==m[t][p][1]&&0!==l[t][p][1]&&(g[t][p]=[v,360/(57.29577951307855*Math.atan(m[t][p][1]/l[t][p][1]))]),g[t][p][1]>1.5*g[t][p-1][1]&&(g[t][p]=[v,1.5*g[t][p-1][1]]),g[t][p][1]<.67*g[t][p-1][1]&&(g[t][p]=[v,.67*g[t][p-1][1]]),g[t][p][1]<6&&(g[t][p]=[v,6]),g[t][p][1]>50&&(g[t][p]=[v,50]),g[t][p]=[v,.2*g[t][p][1]+.8*g[t][p-1][1]],n[t][p]=[v,.33*g[t][p][1]+.67*n[t][p-1][1]],o[t][p]=[v,0],0!==h[t][p][1]&&(o[t][p]=[v,57.29577951307855*Math.atan(i[t][p][1]/h[t][p][1])]);var z=o[t][p-1][1]-o[t][p][1];1>z&&(z=1);var A=q/z;r>A&&(A=r),A>q&&(A=q),w=A*a.getPrice(c,p,u,s)+(1-A)*a.getIndicatorData(d,p-1)}return w}var c={},d={},e={},f={},g={},h={},i={},j={},k={},l={},m={},n={},o={};return{init:function(){!function(p,q){function r(e,f){{var g=this;g.chart}for(var h in d)if(d[h]&&d[h].options&&d[h].options.data&&d[h].options.data.length>0&&c[h].parentSeriesID==g.options.id){var i=g.options.data,j=d[h].options.data,k=c[h],l=a.findIndexInDataForTime(i,e);if(l>=1){var m=b({data:i,mamaData:j,index:l,fastLimit:k.fastLimit,slowLimit:k.slowLimit,type:this.options.type,key:h,appliedTo:k.appliedTo});f?d[h].data[l].update({y:a.toFixed(m,4)}):d[h].addPoint([i[l].x||i[l][0],a.toFixed(m,4)],!0,!0,!1)}}}p&&!p.Series.prototype.addMAMA&&(p.Series.prototype.addMAMA=function(p){var r=this.options.id;p=q.extend({fastLimit:.5,slowLimit:.05,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],appliedTo:a.CLOSE,parentSeriesID:r},p);var s="_"+(new Date).getTime(),t=this.options.data||[];if(t&&t.length>0){var u=[];e[s]=[],f[s]=[],g[s]=[],h[s]=[],i[s]=[],j[s]=[],k[s]=[],l[s]=[],m[s]=[],n[s]=[],o[s]=[];for(var v=0;v<t.length;v++){var w=b({data:t,mamaData:u,index:v,fastLimit:p.fastLimit,slowLimit:p.slowLimit,type:this.options.type,key:s,appliedTo:p.appliedTo});u.push([t[v].x||t[v][0],a.toFixed(w,4)])}var x=this.chart;c[s]=p;var y=this;d[s]=x.addSeries({id:s,name:"MAMA ("+a.appliedPriceString(p.appliedTo)+")",data:u,type:"line",dataGrouping:y.options.dataGrouping,opposite:y.options.opposite,color:p.stroke,lineWidth:p.strokeWidth,dashStyle:p.dashStyle,compare:y.options.compare},!1,!1),q(d[s]).data({onChartIndicator:!0,indicatorID:"mama",isIndicator:!0,parentSeriesID:p.parentSeriesID}),x.redraw()}return s},p.Series.prototype.removeMAMA=function(a){var b=this.chart;c[a]=null,b.get(a).remove(),d[a]=null,e[a]=[],f[a]=[],g[a]=[],h[a]=[],i[a]=[],j[a]=[],k[a]=[],l[a]=[],m[a]=[],n[a]=[],o[a]=[]},p.Series.prototype.preRemovalCheckMAMA=function(a){return{isMainIndicator:!0,appliedTo:c[a]?c[a].appliedTo:void 0,isValidUniqueID:null!=c[a]}},p.wrap(p.Series.prototype,"addPoint",function(b,d,e,f,g){b.call(this,d,e,f,g),a.checkCurrentSeriesHasIndicator(c,this.options.id)&&r.call(this,d[0])}),p.wrap(p.Point.prototype,"update",function(b,d,e,f){b.call(this,d,e,f),a.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&r.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});