define(["indicator_base","highstock"],function(a){function b(b){var c=b.data[b.index].x||b.data[b.index][0];0===b.index&&(f[b.key]=[],g[b.key]=[]);var d={data:b.data,maData:f[b.key],index:b.index,period:b.period,type:b.type,appliedTo:b.appliedTo,isIndicatorData:b.isIndicatorData},e=a.calculateEMAValue(d);b.isPointUpdate?f[b.key][b.index]=[c,e]:f[b.key].push([c,e]);var h={data:f[b.key],maData:g[b.key],index:b.index,period:b.period,type:b.type,appliedTo:b.appliedTo,isIndicatorData:!0},i=a.calculateEMAValue(h);return b.isPointUpdate?g[b.key][b.index]=[c,i]:g[b.key].push([c,i]),e*(1+b.vFactor)-i*b.vFactor}function c(a){var c=a.data[a.index].x||a.data[a.index][0];0===a.index&&(h[a.key]=[],i[a.key]=[]);var d={data:a.data,index:a.index,period:a.period,vFactor:a.vFactor,type:a.type,key:"g1"+a.key,isPointUpdate:a.isPointUpdate,appliedTo:a.appliedTo,isIndicatorData:!1},e=b(d);a.isPointUpdate?h[a.key][a.index]=[c,e]:h[a.key].push([c,e]);var f={data:h[a.key],index:a.index,period:a.period,vFactor:a.vFactor,type:a.type,key:"g2"+a.key,isPointUpdate:a.isPointUpdate,appliedTo:a.appliedTo,isIndicatorData:!0},g=b(f);a.isPointUpdate?i[a.key][a.index]=[c,g]:i[a.key].push([c,g]);var j={data:i[a.key],index:a.index,period:a.period,vFactor:a.vFactor,type:a.type,key:"g3"+a.key,isPointUpdate:a.isPointUpdate,appliedTo:a.appliedTo,isIndicatorData:!0};return b(j)}var d={},e={},f={},g={},h={},i={};return{init:function(){!function(a,b,j){function k(a,b){{var f=this;f.chart}for(var g in e)if(e[g]&&e[g].options&&e[g].options.data&&e[g].options.data.length>0&&d[g].parentSeriesID==f.options.id){var h=f.options.data,i=(e[g].options.data,d[g]),k=j.findIndexInDataForTime(h,a);if(k>=1){var l={data:h,index:k,period:i.period,vFactor:i.vFactor,type:this.options.type,key:g,isPointUpdate:b,appliedTo:i.appliedTo,isIndicatorData:!1},m=c(l);b?e[g].data[k].update({y:j.toFixed(m,4)}):e[g].addPoint([h[k].x||h[k][0],j.toFixed(m,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addT3&&(a.Series.prototype.addT3=function(a){var f=this.options.id;a=b.extend({period:21,vFactor:.7,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],appliedTo:j.CLOSE,parentSeriesID:f},a);var g="_"+(new Date).getTime(),h=this.options.data||[];if(!(a.period>=h.length)){if(h&&h.length>0){for(var i=[],k=0;k<h.length;k++){var l={data:h,index:k,period:a.period,vFactor:a.vFactor,type:this.options.type,key:g,isPointUpdate:!1,appliedTo:a.appliedTo,isIndicatorData:!1},m=c(l);i.push([h[k].x||h[k][0],j.toFixed(m,4)])}var n=this.chart;d[g]=a;var o=this;e[g]=n.addSeries({id:g,name:"T3 ("+a.period+", "+a.vFactor+", "+j.appliedPriceString(a.appliedTo)+")",data:i,type:"line",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:a.stroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:o.options.compare},!1,!1),b(e[g]).data({onChartIndicator:!0,indicatorID:"t3",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),n.redraw()}return g}},a.Series.prototype.removeT3=function(a){var b=this.chart;d[a]=null,b.get(a).remove(),e[a]=null,f["g1"+a]=[],f["g2"+a]=[],f["g3"+a]=[],g["g1"+a]=[],g["g2"+a]=[],g["g3"+a]=[],h[a]=[],i[a]=[]},a.Series.prototype.preRemovalCheckT3=function(a){return{isMainIndicator:!0,period:d[a]?d[a].period:void 0,appliedTo:d[a]?d[a].appliedTo:void 0,isValidUniqueID:null!=d[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,c,e,f){a.call(this,b,c,e,f),j.checkCurrentSeriesHasIndicator(d,this.options.id)&&k.call(this,b[0])}),a.wrap(a.Point.prototype,"update",function(a,b,c,e){a.call(this,b,c,e),j.checkCurrentSeriesHasIndicator(d,this.series.options.id)&&k.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});