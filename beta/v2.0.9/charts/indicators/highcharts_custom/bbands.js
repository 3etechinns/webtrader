define(["jquery","indicator_base","highcharts-more"],function(a,b){function c(a,c,d,e,f){for(var g=0,h=0;h<d.period&&c>=0;h++){var i=b.getPrice(a,c,d.appliedTo,e),j=Math.pow(i-f,2);g+=j,--c}return Math.sqrt(g/h)}function d(a,d,e,f){for(var g=[],h=0;h<a.length;h++){var i=b.getIndicatorData(d,h),j=c(a,h,e,f,i),k=i-j*e.devDn;g.push([a[h].x||a[h][0],b.toFixed(k,4)])}return g}function e(a,d,e,f){for(var g=[],h=0;h<a.length;h++){var i=b.getIndicatorData(d,h),j=c(a,h,e,f,i),k=i+j*e.devDn;g.push([a[h].x||a[h][0],b.toFixed(k,4)])}return g}var f={},g={},h={},i={};return{init:function(){!function(a,b,j){function k(a,b){{var c=this;c.chart}for(var d in g)if(g[d]&&g[d].options&&g[d].options.data&&g[d].options.data.length>0&&f[d].parentSeriesID==c.options.id){var e=c.options.data,h=g[d].options.data,i=f[d],k=(g[d].options.data,j.findIndexInDataForTime(e,a));if(k>=1){var l={data:e,maData:h,index:k,period:i.period,maType:i.maType,type:this.options.type,key:d,isPointUpdate:b,appliedTo:i.appliedTo,isIndicatorData:!1},m=j.calculateMAValue(l);b?g[d].data[k].update({y:j.toFixed(m,4)}):g[d].addPoint([e[k].x||e[k][0],j.toFixed(m,4)],!0,!0,!1)}}}function l(a,b){{var d=this;d.chart}for(var e in h)if(h[e]&&h[e].options&&h[e].options.data&&h[e].options.data.length>0&&f[e].parentSeriesID==d.options.id){var i=d.options.data,k=(h[e].options.data,e.replace("u","m")),l=g[k].options.data,m=f[e],n=j.findIndexInDataForTime(i,a);if(n>=1){var o=l[n][1]||l[n].y,p=c(i,n,m,this.options.type,o),q=o+p*m.devDn;b?h[e].data[n].update({y:j.toFixed(q,4)}):h[e].addPoint([i[n].x||i[n][0],j.toFixed(q,4)],!0,!0,!1)}}}function m(a,b){{var d=this;d.chart}for(var e in i)if(i[e]&&i[e].options&&i[e].options.data&&i[e].options.data.length>0&&f[e].parentSeriesID==d.options.id){var h=d.options.data,k=(i[e].options.data,e.replace("l","m")),l=g[k].options.data,m=f[e],n=j.findIndexInDataForTime(h,a);if(n>=1){var o=l[n][1]||l[n].y,p=c(h,n,m,this.options.type,o),q=o-p*m.devDn;b&&i[e].options.data.length>=h.length?i[e].data[n].update({y:j.toFixed(q,4)}):i[e].addPoint([h[n].x||h[n][0],j.toFixed(q,4)],!0,!0,!1)}}}function n(a,b){var c=this,d=c.chart;for(var e in h)if(h[e]&&h[e].options&&h[e].options.data&&h[e].options.data.length>0&&f[e].parentSeriesID==c.options.id){var g=c.options.data,k=h[e].options.data,l=i[e.replace("u","l")].options.data,m=j.findIndexInDataForTime(g,a),n=g[m].x||g[m][0],o=l[m].y||l[m][1],p=k[m].y||k[m][1],q=[n,o,p];m>=1&&d.series.forEach(function(a){return a.options.id==="range"+e.replace("u","")?(b?a.data[m].update(q):a.addPoint(q,!0,!0,!1),!1):void 0})}}a&&!a.Series.prototype.addBBANDS&&(a.Series.prototype.addBBANDS=function(a){var c=this.options.id;a=b.extend({period:20,devUp:2,devDn:2,maType:"SMA",mdlBndStroke:"red",uprBndStroke:"#A52A2A",lwrBndStroke:"#A52A2A",strokeWidth:1,dashStyle:"line",appliedTo:j.CLOSE,parentSeriesID:c},a);var k=Date.now(),l="m-"+k,m="u-"+k,n="l-"+k,o="range-"+k,p=this.options.data||[];if(p&&p.length>0){for(var q=[],r=0;r<p.length;r++){var s={data:p,maData:q,index:r,period:a.period,maType:a.maType,type:this.options.type,key:l,isPointUpdate:!1,appliedTo:a.appliedTo,isIndicatorData:!1},t=j.calculateMAValue(s);q.push([p[r].x||p[r][0],j.toFixed(t,4)])}var u=e(p,q,a,this.options.type),v=d(p,q,a,this.options.type),w=this.chart;f[l]=a,f[m]=a,f[n]=a;var x=this;g[l]=w.addSeries({id:l,name:"BBANDS (Middle,"+a.period+","+a.devUp+","+a.devDn+","+j.appliedPriceString(a.appliedTo)+")",data:q,type:"line",dataGrouping:x.options.dataGrouping,opposite:x.options.opposite,color:a.mdlBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:x.options.compare},!1,!1),h[m]=w.addSeries({id:m,name:"BBANDS Upper",data:u,type:"line",dataGrouping:x.options.dataGrouping,opposite:x.options.opposite,color:a.uprBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:x.options.compare},!1,!1),i[n]=w.addSeries({id:n,name:"BBANDS Lower",data:v,type:"line",dataGrouping:x.options.dataGrouping,opposite:x.options.opposite,color:a.lwrBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:x.options.compare},!1,!1);var y=[];v.forEach(function(a,b){var c=[a[0],a[1],u[b][1]];y.push(c)}),w.addSeries({id:o,data:y,name:"BBANDS Range",type:"arearange",dataGrouping:x.options.dataGrouping,opposite:x.options.opposite,color:"white",fillColor:"rgba(28,28,28,0.5)",connectNulls:!0,compare:x.options.compare,states:{hover:{enabled:!1}},events:{},dataLabels:{enabled:!1},point:{events:{}},enableMouseTracking:!1},!1,!1),b(g[l]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(h[m]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(i[n]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),w.redraw()}},a.Series.prototype.removeBBANDS=function(a){var b=this.chart,c=a.replace("m-","").replace("l-","").replace("u-","");["m","u","l","range"].forEach(function(a){var d=a+"-"+c;b.get(d).remove(),"range"!==a&&("TEMA"===f[d].maType&&(ema1[d]=[],ema2[d]=[],ema3[d]=[]),f[d]=null,g[d]=null,h[d]=null,i[d]=null)}),b.redraw()},a.Series.prototype.preRemovalCheckBBANDS=function(a){var b=void 0;return f[a]&&(b="BBANDS ("+f[a].period+","+f[a].devUp+","+f[a].devDn+","+j.appliedPriceString(f[a].appliedTo)+")"),{isMainIndicator:0===a.indexOf("m-"),period:f[a]?f[a].period:void 0,appliedTo:f[a]?f[a].appliedTo:void 0,devUp:f[a]?f[a].devUp:void 0,devDn:f[a]?f[a].devDn:void 0,maType:f[a]?f[a].maType:void 0,isValidUniqueID:null!=f[a],indicatorName:b}},a.wrap(a.Series.prototype,"addPoint",function(a,b,c,d,e){a.call(this,b,c,d,e),j.checkCurrentSeriesHasIndicator(f,this.options.id)&&(k.call(this,b[0]),l.call(this,b[0]),m.call(this,b[0]),n.call(this,b[0]))}),a.wrap(a.Point.prototype,"update",function(a,b,c,d){a.call(this,b,c,d),j.checkCurrentSeriesHasIndicator(f,this.series.options.id)&&(k.call(this.series,this.x,!0),l.call(this.series,this.x,!0),m.call(this.series,this.x,!0),n.call(this.series,this.x,!0))}))}(Highcharts,jQuery,b)}}});