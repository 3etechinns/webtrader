define(["indicator_base","highstock"],function(a){function b(b,c,d,i,j){var k=e[i],l=f[i],m=g[i],n=h[i],o=a.extractPriceForAppliedTO(a.HIGH,b,c),p=a.extractPriceForAppliedTO(a.LOW,b,c),q=0;if(n[c-2]===n[c-1]){var r=m[c-1]+l[c-1]*(k[c-1]-m[c-1]);if("UP"===n[c-1]){var s=Math.min(a.extractPriceForAppliedTO(a.LOW,b,c-1),a.extractPriceForAppliedTO(a.LOW,b,c-2));q=s>r?r:s}else{var t=Math.max(a.extractPriceForAppliedTO(a.HIGH,b,c-1),a.extractPriceForAppliedTO(a.HIGH,b,c-2));q=r>t?t:r}}else q=k[c-1];j?m[c]=q:m.push(q);var u="UP"===n[c-1]?o>k[c-1]?o:k[c-1]:p<k[c-1]?p:k[c-1];j?k[c]=u:k.push(u);var v="";"UP"===n[c-1]?v=p>q?"UP":"DOWN":"DOWN"===n[c-1]&&(v=q>o?"DOWN":"UP"),j?n[c]=v:n.push(v);var w=0;return w=n[c]===n[c-1]?"UP"===n[c]?l[c-1]===d.maximum?l[c-1]:d.maximum:l[c-1]:d.acceleration,j?l[c]=w:l.push(w),q}var c={},d={},e={},f={},g={},h={};return{init:function(){!function(a,i,j){function k(a,e){{var f=this;f.chart}for(var g in d)if(d[g]&&d[g].options&&d[g].options.data&&d[g].options.data.length>0&&c[g].parentSeriesID==f.options.id){var h=f.options.data,i=j.findIndexInDataForTime(h,a),k=c[g];if(i>=1){var l=b(h,i,k,g,e);e?d[g].data[i].update({y:j.toFixed(l,4)}):d[g].addPoint([h[i].x||h[i][0],j.toFixed(l,4)],!0,!0,!1)}}}a&&!a.Series.prototype.addSAR&&(a.Series.prototype.addSAR=function(a){var k=this.options.id;a=i.extend({acceleration:.02,maximum:.2,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],parentSeriesID:k},a);var l="_"+(new Date).getTime(),m=this.options.data||[];if(m&&m.length>0){var n=5,o=[],p=[],q=[],r=[],s=[];e[l]=p,f[l]=q,g[l]=r,h[l]=s;for(var t=0;t<m.length;t++){var u=j.extractPriceForAppliedTO(j.HIGH,m,t),v=j.extractPriceForAppliedTO(j.LOW,m,t);if(n>t)o.push([m[t].x||m[t][0],0]),r.push(0),p.push(0),q.push(r.acceleration),s.push(t===n-1?"UP":"");else if(t==n){for(var w=0,x=0,y=0;n>y;y++){var u=j.extractPriceForAppliedTO(j.HIGH,m,t),v=j.extractPriceForAppliedTO(j.LOW,m,t);0===w&&(w=u),w=Math.min(w,v,u),x=Math.max(w,v,u)}r.push(w),p.push(x),q.push(a.acceleration);var z="UP";"UP"===s[t-1]?z=v>w?"UP":"DOWN":"DOWN"===s[t-1]&&(z=w>u?"DOWN":"UP"),s.push(z),o.push([m[t].x||m[t][0],j.toFixed(w,4)])}else{var w=b(m,t,a,l,!1);o.push([m[t].x||m[t][0],j.toFixed(w,4)])}}var A=this.chart;c[l]=a;var B=this;d[l]=A.addSeries({id:l,name:"SAR ("+a.acceleration+","+a.maximum+")",data:o,lineWidth:0,marker:{enabled:!0},dataGrouping:B.options.dataGrouping,opposite:B.options.opposite,color:a.stroke,states:{hover:{enabled:!1}}},!1,!1),i(d[l]).data({isIndicator:!0,indicatorID:"sar",parentSeriesID:a.parentSeriesID,period:a.period}),A.redraw()}return l},a.Series.prototype.removeSAR=function(a){var b=this.chart;c[a]=null,b.get(a).remove(!1),d[a]=null,j.recalculate(b),b.redraw()},a.Series.prototype.preRemovalCheckSAR=function(a){return{isMainIndicator:!0,acceleration:c[a]?c[a].acceleration:void 0,maximum:c[a]?c[a].maximum:void 0,isValidUniqueID:null!=c[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,e,f){a.call(this,b,d,e,f),j.checkCurrentSeriesHasIndicator(c,this.options.id)&&k.call(this,b[0],!1)}),a.wrap(a.Point.prototype,"update",function(a,b,d,e){a.call(this,b,d,e),j.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&k.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});