define(["lokijs","jquery","websockets/binary_websockets","common/util"],function(a,b,c){function d(a){var c=a;if(this[c]&&this[c].chartIDs){var d=this[c].chartIDs,e=this.processOHLC;d.forEach(function(a){if(a){var d=b(a.containerIDWithHash).highcharts().get(c),g=b(a.containerIDWithHash).data("type");if(d){var h=d.data[d.data.length-1].x||d.data[d.data.length-1].time,i=f.chain().find({instrumentCdAndTp:c}).where(function(a){return a.time>=h}).simplesort("time",!1).data();for(var j in i){for(var k=i[j],l=void 0,m=d.data.length-1;m>=0;m--){var n=d.data[m];if(n&&k.time==(n.x||n.time)){l=n;break}}l?g&&isDataTypeClosePriceOnly(g)?l.update([k.time,k.close],!1):l.update([k.time,k.open,k.high,k.low,k.close],!1):g&&isDataTypeClosePriceOnly(g)?d.addPoint([k.time,k.close],!1,!0):d.addPoint([k.time,k.open,k.high,k.low,k.close],!1,!0)}d.isDirty=!0,d.isDirtyData=!0,d.chart.redraw()}else{var o=b(a.containerIDWithHash).highcharts(),p=[],i=f.chain().find({instrumentCdAndTp:c}).simplesort("time",!1).data();for(var q in i)e(i[q].open,i[q].high,i[q].low,i[q].close,i[q].time,g,p);if(!o)return;var r=p.length,s=p.length>30?r-30:0,t=a.instrumentName,u=a.series_compare,v=0;o.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++v}),0===v&&(o.xAxis[0].range=p[r-1][0]-p[s][0]);var w={id:c,name:t,data:p,type:g?g:"candlestick",dataGrouping:{enabled:!1},compare:u,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(g)||isDotType(g))&&(w.type="line",isDotType(g)&&(w.dashStyle="dot"),w.marker={enabled:!isDotType(g),radius:4}),o.addSeries(w)}}})}}var e=new a,f=e.addCollection("bars_table");return{barsTable:f,processOHLC:function(a,c,d,e,f,g,h){if(!(h.length>0&&h[h.length-1][0]>f))if(g&&isDataTypeClosePriceOnly(g)){if(!b.isNumeric(f)||!b.isNumeric(e))return;h.push([f,e])}else{if(!(b.isNumeric(f)&&b.isNumeric(a)&&b.isNumeric(c)&&b.isNumeric(d)&&b.isNumeric(e)))return;h.push([f,a,c,d,e])}},barsLoaded:d,keyFor:function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},register:function(a){var b=a.granularity||0,d=a.style||"ticks",e=!0;"string"==typeof b&&(e=!1,b=convertToTimeperiodObject(b).timeInSeconds());var f={ticks_history:a.symbol,granularity:b,subscribe:a.subscribe||0,count:a.count||1,end:"latest",style:d};if(!e){var g=a.count||1,h=(new Date).getTime()/1e3-g*b|0,i=new Date;i.setUTCFullYear(i.getUTCFullYear()-3),i.setDate(i.getDate()+1),1e3*h<i.getTime()&&(h=i.getTime()/1e3|0),f.style="candles",f.start=h,f.adjust_start_time=a.adjust_start_time||1}var j=this.keyFor(a.symbol,b);return this[j]={symbol:a.symbol,granularity:b,chartIDs:[]},c.send(f)}}});