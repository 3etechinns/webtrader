define(["jquery","windows/windows","websockets/binary_websockets","lodash","datatables","jquery-growl","common/util"],function(a,b,c,d){"use strict";function e(a){require(["css!profittable/profitTable.css"]),require(["text!profittable/profitTable.html"]),a.click(function(){g?g.moveToTop():c.cached.authorize().then(f)["catch"](function(a){})})}function f(){g=b.createBlankWindow(a("<div/>"),{title:"Profit Table",width:750,minWidth:700,minHeight:90,destroy:function(){h&&h.DataTable().destroy(!0)},close:function(){g=null},refresh:function(){i.clear(),j()},"data-authorized":"true"}),require(["text!profittable/profitTable.html"],function(b){h=a(b),h.appendTo(g),h=h.dataTable({data:[],columnDefs:[{targets:6,createdCell:function(b,c){var d=0>c?"red":c>0?"green":"bold";d&&a(b).addClass(d)}}],paging:!1,ordering:!1,searching:!0,processing:!0}),h.parent().addClass("hide-search-input"),h.api().columns().every(function(){var b=this;a("input",this.header()).on("keyup change",function(){b.search()!==this.value&&b.search(this.value).draw()})}),j(),i=g.addDateToHeader({title:"Jump to: ",date:null,changed:j,cleared:j}),g.dialog("open"),g.on("click",k)})}var g=null,h=null,i=null,j=function(b){var d=a("#"+h.attr("id")+"_processing").css("top","200px").show(),e={profit_table:1,description:1,sort:"DESC"};b?e.date_from=e.date_to=b:e.limit=50;var f=function(a){var b=a.profit_table&&a.profit_table.transactions||[],c=b.map(function(a){var b=(parseFloat(a.sell_price)-parseFloat(a.buy_price)).toFixed(2),c=b>0?"up":0>b?"down":"equal",d='<img class="arrow" src="images/'+c+'-arrow.svg"/>';return[epoch_to_string(a.purchase_time,{utc:!0}),a.transaction_id,d+a.longcode,a.buy_price,epoch_to_string(a.sell_time,{utc:!0}),a.sell_price,b,a]});h.api().rows().remove(),h.api().rows.add(c),h.api().draw(),d.hide()};c.send(e).then(f)["catch"](function(b){f({}),a.growl.error({message:b.message})})},k=function(a){if("IMG"===a.target.tagName){var b=a.target.parentElement.parentElement,c=h.api().row(b).data();c=d.last(c),require(["viewtransaction/viewTransaction"],function(a){var b=c.shortcode.split("_"),e="R"!==b[1]?b[1]:"R_"+b[2],f=c.longcode.split(" "),g=["ticks","ticks.","seconds","minutes","hours","days"].filter(function(a){return d.includes(f,a)})[0],h=f[f.indexOf(g)-1];a.init({duration:h,duration_type:g,symbol:e,contract_id:c.contract_id,longcode:c.longcode,sell_time:c.sell_time,purchase_time:c.purchase_time,buy_price:c.buy_price,sell_price:c.sell_price})})}};return{init:e}});