define(["websockets/binary_websockets","charts/chartingRequestMap","common/util"],function(a,b){function c(a,b,c){a.xAxis.forEach(function(a){b||(b=a.getExtremes().min),c||(c=a.getExtremes().max),a.setExtremes(b,c)})}var d=b.barsTable;return a.events.on("tick",function(a){var c=(a.echo_req.ticks_history+a.echo_req.granularity).toUpperCase();if(c){b[c]=b[c]||{},$(document).trigger("feedTypeNotification",[c,"realtime-feed"]);var e=parseFloat(a.tick.quote),f=1e3*parseInt(a.tick.epoch),g=b[c];if(!(g.chartIDs&&g.chartIDs.length>0))return;var h=$(g.chartIDs[0].containerIDWithHash).data("timePeriod");if(!h)return;isTick(h)&&(d.insert({instrumentCdAndTp:c,time:f,open:e,high:e,low:e,close:e}),g.chartIDs.forEach(function(a){var b=$(a.containerIDWithHash).highcharts();if(b){var d=b.get(c);d&&d.addPoint([f,e])}}))}}),a.events.on("ohlc",function(a){var e=(a.echo_req.args.ticks_history+a.echo_req.args.granularity).toUpperCase();if(e){b[e]=b[e]||{},$(document).trigger("feedTypeNotification",[e,"realtime-feed"]);var f=parseFloat(a.ohlc.open),g=parseFloat(a.ohlc.high),h=parseFloat(a.ohlc.low),i=parseFloat(a.ohlc.close),j=1e3*parseInt(a.ohlc.open_time),k=b[e];if(!(k.chartIDs&&k.chartIDs.length>0))return;var l=$(k.chartIDs[0].containerIDWithHash).data("timePeriod");if(!l)return;var m=d.chain().find({$and:[{instrumentCdAndTp:e},{time:j}]}).simplesort("time",!0).limit(1).data(),n=!1;!m||m.length<=0?(m={instrumentCdAndTp:e,time:j,open:f,high:g,low:h,close:i},d.insert(m),n=!0):(m=m[0],m.open=f,m.high=g,m.low=h,m.close=i,d.update(m)),k.chartIDs.forEach(function(a){var b=$(a.containerIDWithHash).highcharts();if(b){var d=b.get(e);if(d){var k=$(a.containerIDWithHash).data("type"),l=d.data[d.data.length-1];return d.options.data.length!=d.data.length?void c(b,null,m.time):void(k&&isDataTypeClosePriceOnly(k)?n?d.addPoint([j,i],!0,!0,!1):l.update({y:i}):n?d.addPoint([j,f,g,h,i],!0,!0,!1):l.update({open:f,high:g,low:h,close:i}))}}})}}),{}});