define(["jquery","jquery.dialogextend","modernizr","common/util"],function(a){function b(){require(["charts/chartWindow"],function(b){var c=80;isSmallView()&&(c=100);var d=1,e=1,f=20,g=a(".chart-dialog").dialog("option","minWidth"),i=a(".chart-dialog").dialog("option","minHeight");isSmallView()&&(g=a(window).width()-2*f,i=a(window).height()-c);var j=h*g+(h-1)*f,k=a(window).width()-j,l=Math.round(k/2)-f,m=window;a(".chart-dialog").each(function(){if(1==d)var j=l;else if(d>1)var j=l+(g+f)*(d-1);var k=-c+2;m=window,m==window&&(k=(e-1)*i+e*c),m=a(this).dialog("option",{position:{my:"left+"+j+" top"+(0>k?"-":"+")+k,at:"left top",of:m},width:g,height:i}),b.triggerResizeEffects(a(this).dialog("widget").find(".chart-dialog")),++d>h&&(d=1,++e,m=window)})})}function c(b){b=a.extend({title:"title",date:new Date,changed:function(a){}},b);var c=(this.parent().find(".ui-dialog-titlebar").addClass("with-dates"),this.parent().find(".ui-dialog-title")),d=function(b){function d(a,b){var c=a%4==0&&(a%100!=0||a%400==0);return[31,c?29:28,31,30,31,30,31,31,30,31,30,31][b]}function e(b,c){var d=c.render||function(a){return a+""};b.children().remove();for(var e=c.min;e<=c.max;++e)a("<option/>").val(e).text(d(e)).appendTo(b);return b.val(c.initial||c.min),b.selectmenu("refresh"),b}var f=b.date||new Date,g=a("<select />").insertAfter(c).selectmenu({width:"70px"}),h=a("<select />").insertAfter(c).selectmenu({width:"65px"}),i=a("<select />").insertAfter(c).selectmenu({width:"60px"});g=e(g,{min:2010,max:f.getFullYear(),initial:f.getFullYear()}),h=e(h,{min:0,max:11,initial:f.getMonth(),render:function(a){return["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"][a]}}),i=e(i,{min:1,max:d(f.getFullYear(),f.getMonth()),initial:f.getDate()});var j=function(){var a=new Date(g.val(),h.val(),i.val()).toISOString().slice(0,10);b.onchange(a)};i.on("selectmenuchange",j);var k=function(){var a={min:1,max:d(g.val(),h.val()),initial:i.val()};a.initial>a.max&&(a.initial=a.min),e(i,a)};return[g,h].forEach(function(a){a.on("selectmenuchange",function(){k(),j()})}),{update:function(a){var b=a.split("-");g.val(0|b[0]),g.selectmenu("refresh"),h.val(0|b[1]),h.selectmenu("refresh"),i.val(0|b[2]),k()}}},e=function(b){var d=a("<input type='hidden' />").insertAfter(c),e=d.datepicker({showOn:"both",numberOfMonths:2,maxDate:0,minDate:new Date(2010,0,1),dateFormat:"yy-mm-dd",showAnim:"drop",showButtonPanel:!0,changeMonth:!0,changeYear:!0,beforeShow:function(a,b){b.dpDiv.css({marginTop:"10px",marginLeft:"-220px"})},onSelect:function(){a(this).change()}}).datepicker("setDate",b.date.toISOString().slice(0,10));return e.next("button").text("").button({icons:{primary:"ui-icon-calendar"}}),d.on("change",function(){var c=a(this).val();b.onchange&&b.onchange(c)}),d},f=b.date,g=e({date:f,onchange:function(a){h.update(a),b.changed(a)}}),h=d({date:f,onchange:function(a){g.datepicker("setDate",a),b.changed(a)}});a('<span class="span-in-dialog-header">'+b.title+"</span>").insertAfter(c)}var d=null,e=[{symbol:"R_25",name:"Random 25 Index",timeperiod:"1d",chartType:"candlestick"},{symbol:"R_50",name:"Random 50 Index",timeperiod:"8h",chartType:"line"},{symbol:"R_75",name:"Random 75 Index",timeperiod:"4h",chartType:"ohlc"},{symbol:"R_100",name:"Random 100 Index",timeperiod:"2h",chartType:"spline"}],f=a(window).width(),g=a(window).height(),h=Math.floor(f/370),i=Math.floor(g/410);(isSmallView()||0>=i||0>=h)&&(i=1,h=1);var j=0,k=null;return{init:function(c){return loadCSS("windows/windows.css"),k=c.find("ul"),tileObject=a("li.tile"),d=a("li.closeAll").click(function(){a(".chart-dialog").length>0&&a(".chart-dialog").dialog("close")}),require(["charts/chartWindow"],function(c){tileObject.click(function(){b()});var d=h*i;a(e).each(function(a,e){d>a&&c.addNewWindow(e.symbol,e.name,e.timeperiod,function(){b()},e.chartType)})}),this},tile:function(){b()},closeAll:function(){d||d.click()},createBlankWindow:function(b,d){b=a(b);var e="windows-dialog-"+ ++j;d=a.extend({autoOpen:!1,resizable:!0,width:350,height:400,my:"center",at:"center",of:window,title:"blank window"},d||{}),d.minWidth=d.minWidth||d.width,d.minHeight=d.minHeight||d.height,d.resize&&(d.maximize=d.minimize=d.restore=d.resize);var f=b.attr("id",e).dialog(d).dialogExtend(d),g=a("<li />").addClass(e+"LI").text(d.title);return k.append(g),g.on("click",function(){f.dialog("moveToTop").parent().effect("bounce",{times:2,distance:15},450)}),f.on("dialogclose",function(){g.remove(),a("#menu").menu("refresh")}),a("#menu").menu("refresh"),d.resize&&d.resize.call(b[0]),f.addDateToHeader=c,f},makeSelectmenu:function(b,c){c=a.extend({list:["empty"],inx:0,changed:function(){}},c);var d=c.inx,e=c.list,f=function(c){b.children().remove();for(var d=0;d<c.length;++d)a("<option/>").val(c[d]).text(c[d]).appendTo(b)};return f(e),b.val(e[d]),b=b.selectmenu(),b.on("selectmenuchange",function(){var b=a(this).val();c.changed(b)}),b.update_list=function(a){f(a),b.val(a[0]),b.selectmenu("refresh")},b}}});