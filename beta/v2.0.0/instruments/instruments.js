define(["jquery","jquery-ui","websockets/eventSourceHandler","navigation/navigation"],function(a,b,c,d){"use strict";function e(a){var b=/[^a-zA-Z]/g,c=/[^0-9]/g;return function(d,e){var f=d[a].replace(b,""),g=e[a].replace(b,"");if(f===g){var h=parseInt(d[a].replace(c,""),10),i=parseInt(e[a].replace(c,""),10);return h===i?0:h>i?1:-1}return f>g?1:-1}}function f(b){a.isArray(b)&&(b.sort(e("display_name")),a.each(b,function(b,c){a.each(c,function(b,c){a.isArray(c)&&f(c)})}))}function g(b){require(["validation/validation"],function(c){require(["charts/chartWindow"],function(d){if(!c.validateIfNoOfChartsCrossingThreshold(d.totalWindows()))return void require(["jquery","jquery-growl"],function(a){a.growl.error({message:"No more charts allowed!"})});var e=a("#instrumentsDialog").dialog("option","title"),f=a("#instrumentsDialog").data("symbol"),g=a("#instrumentsDialog").data("delay_amount");require(["common/util"],function(){var i=convertToTimeperiodObject(b);i?c.validateNumericBetween(i.intValue(),parseInt(a("#timePeriod").attr("min")),parseInt(a("#timePeriod").attr("max")))?g<=i.timeInSeconds()/60?(d.addNewWindow(f,e,b,null,isTick(b)?"line":"candlestick"),h.call(a("#instrumentsDialog"))):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Charts of less than "+convertToTimeperiodObject(g+"m").humanReadableString()+" are not available for the "+e+"."})}):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Only numbers between "+a("#timePeriod").attr("min")+" to "+a("#timePeriod").attr("max")+" is allowed for "+a("#units option:selected").text()+"!"})}):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Only numbers between 1 to 100 is allowed!"})})})})})}function h(){a(this).dialog("close"),a(this).find("*").removeClass("ui-state-error")}function i(b,c){a.each(c,function(c,d){var e=d.submarkets||d.instruments,f="<span class='nav-submenu-caret'></span>",j=e?d.display_name+f:d.display_name,k=a("<a href='#'>"+j+"</a>");e&&k.addClass("nav-dropdown-toggle");var l=a("<li>").append(k).data("symbol",d.symbol).data("delay_amount",d.delay_amount).appendTo(b);if(e){var m=a("<ul>");m.appendTo(l),i(m,d.submarkets||d.instruments)}else k.click(function(){0==a("#instrumentsDialog").length?a.get("instruments/instruments.html",function(b){a(b).css("display","none").appendTo("body"),a("#standardPeriodsButtonContainer").find("button").click(function(){g(a(this).attr("id"))}).button(),a("#units").change(function(){if("t"==a(this).val())a("#timePeriod").val("1").attr("disabled","disabled").attr("min",1).attr("max",1);else{a("#timePeriod").removeAttr("disabled");var b=a("#units").val(),c={m:59,h:23,d:3}[b]||120;a("#timePeriod").attr("max",c)}}),a("#units").trigger("change"),a("#instrumentsDialog").dialog({autoOpen:!1,resizable:!1,width:260,my:"center",at:"center",of:window,buttons:[{text:"Ok",click:function(){g(a("#timePeriod").val()+a("#units").val())}},{text:"Cancel",click:function(){h.call(this)}}]}),a("#instrumentsDialog").dialog("option","title",l.text()).data("symbol",l.data("symbol")).data("delay_amount",l.data("delay_amount")),a("#instrumentsDialog").dialog("open"),a("#instrumentSelectionMenuDIV").hide()}):(a("#instrumentsDialog").dialog("option","title",a(this).text()).data("symbol",a(this).data("symbol")).data("delay_amount",a(this).data("delay_amount")),a("#instrumentsDialog").dialog("open"),a("#instrumentSelectionMenuDIV").hide()),a(document).click()})})}function j(a){for(var b in a.trading_times.markets){var c=a.trading_times.markets[b],d={name:c.name,display_name:c.name,submarkets:[]};for(var e in c.submarkets){var g=c.submarkets[e],h={name:g.name,display_name:g.name,instruments:[]};for(var i in g.symbols){var j=g.symbols[i];h.instruments.push({symbol:j.symbol,display_name:j.name,delay_amount:0})}d.submarkets.push(h)}k.push(d)}f(k)}var k=[];return{init:function(b){a.isEmptyObject(k)&&(loadCSS("instruments/instruments.css"),c.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(c){if(!a.isEmptyObject(c)){j(c);var e=a("#nav-menu").find(".instruments"),f=a("<ul>");f.appendTo(e),i(f,k),d.updateDropdownToggles(),b&&b(k)}}))},getMarketData:function(){return k},isMarketDataPresent:function(b,c){var d=!1;c||(c=k);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.isMarketDataPresent(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=!0),!d}),d},getSpecificMarketData:function(b,c){var d={};c||(c=k);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.getSpecificMarketData(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=f),a.isEmptyObject(d)}),d}}});