define(["jquery","jquery-ui","websockets/eventSourceHandler"],function(a,b,c){"use strict";function d(a){var b=/[^a-zA-Z]/g,c=/[^0-9]/g;return function(d,e){var f=d[a].replace(b,""),g=e[a].replace(b,"");if(f===g){var h=parseInt(d[a].replace(c,""),10),i=parseInt(e[a].replace(c,""),10);return h===i?0:h>i?1:-1}return f>g?1:-1}}function e(b){a.isArray(b)&&(b.sort(d("display_name")),a.each(b,function(b,c){a.each(c,function(b,c){a.isArray(c)&&e(c)})}))}function f(b){require(["validation/validation"],function(c){require(["charts/chartWindow"],function(d){if(!c.validateIfNoOfChartsCrossingThreshold(d.totalWindows()))return void require(["jquery","jquery-growl"],function(a){a.growl.error({message:"No more charts allowed!"})});var e=a("#instrumentsDialog").dialog("option","title"),f=a("#instrumentsDialog").data("symbol"),h=a("#instrumentsDialog").data("delay_amount");require(["common/util"],function(){var i=convertToTimeperiodObject(b);i?c.validateNumericBetween(i.intValue(),parseInt(a("#timePeriod").attr("min")),parseInt(a("#timePeriod").attr("max")))?h<=i.timeInSeconds()/60?(d.addNewWindow(f,e,b,null,isTick(b)?"line":"candlestick"),g.call(a("#instrumentsDialog"))):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Charts of less than "+convertToTimeperiodObject(h+"m").humanReadableString()+" are not available for the "+e+"."})}):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Only numbers between "+a("#timePeriod").attr("min")+" to "+a("#timePeriod").attr("max")+" is allowed for "+a("#units option:selected").text()+"!"})}):require(["jquery","jquery-growl"],function(a){a("#timePeriod").addClass("ui-state-error"),a.growl.error({message:"Only numbers between 1 to 100 is allowed!"})})})})})}function g(){a(this).dialog("close"),a(this).find("*").removeClass("ui-state-error")}function h(b,c){a.each(c,function(c,d){var e=a("<li>").append(d.display_name).data("symbol",d.symbol).data("delay_amount",d.delay_amount).appendTo(b);if(d.submarkets||d.instruments){e.click(function(a){return a.preventDefault(),!1});var i=a("<ul>");i.appendTo(e),h(i,d.submarkets||d.instruments)}else e.click(function(){0==a("#instrumentsDialog").length?a.get("instruments/instruments.html",function(b){a(b).css("display","none").appendTo("body"),a("#standardPeriodsButtonContainer").find("button").click(function(){f(a(this).attr("id"))}).button(),a("#units").change(function(){if("t"==a(this).val())a("#timePeriod").val("1").attr("disabled","disabled").attr("min",1).attr("max",1);else{a("#timePeriod").removeAttr("disabled");var b=a("#units").val(),c={m:59,h:23,d:3}[b]||120;a("#timePeriod").attr("max",c)}}),a("#units").trigger("change"),a("#instrumentsDialog").dialog({autoOpen:!1,resizable:!1,width:260,my:"center",at:"center",of:window,buttons:[{text:"Ok",click:function(){f(a("#timePeriod").val()+a("#units").val())}},{text:"Cancel",click:function(){g.call(this)}}]}),a("#instrumentsDialog").dialog("option","title",e.text()).data("symbol",e.data("symbol")).data("delay_amount",e.data("delay_amount")),a("#instrumentsDialog").dialog("open"),a("#instrumentSelectionMenuDIV").hide()}):(a("#instrumentsDialog").dialog("option","title",a(this).text()).data("symbol",a(this).data("symbol")).data("delay_amount",a(this).data("delay_amount")),a("#instrumentsDialog").dialog("open"),a("#instrumentSelectionMenuDIV").hide()),a(document).click()})})}function i(a){for(var b in a.trading_times.markets){var c=a.trading_times.markets[b],d={name:c.name,display_name:c.name,submarkets:[]};for(var f in c.submarkets){var g=c.submarkets[f],h={name:g.name,display_name:g.name,instruments:[]};for(var i in g.symbols){var k=g.symbols[i];h.instruments.push({symbol:k.symbol,display_name:k.name,delay_amount:0})}d.submarkets.push(h)}j.push(d)}e(j)}var j=[];return{init:function(b){a("#menu").menu(),a.isEmptyObject(j)&&(loadCSS("instruments/instruments.css"),c.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(c){if(!a.isEmptyObject(c)){i(c);var d=a(".mainContainer").find(".instruments"),e=a("<ul>");e.appendTo(d),h(e,j),e.menu(),b&&b(j)}}))},getMarketData:function(){return j},isMarketDataPresent:function(b,c){var d=!1;c||(c=j);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.isMarketDataPresent(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=!0),!d}),d},getSpecificMarketData:function(b,c){var d={};c||(c=j);var e=this;return a.each(c,function(c,f){return f.submarkets||f.instruments?d=e.getSpecificMarketData(b,f.submarkets||f.instruments):a.trim(f.display_name)==a.trim(b)&&(d=f),a.isEmptyObject(d)}),d}}});