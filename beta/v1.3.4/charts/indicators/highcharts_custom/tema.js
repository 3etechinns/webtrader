define(["indicator_base","highstock"],function(a){function b(b,c){for(var d=[],e=0,f=0;b>f;f++)if(e+=c[f][1],f==b-1){var g=e/b;$.isNumeric(g)||(g=c[f][1]),d.push([c[f][0],g])}else d.push([c[f][0],null]);for(var f=b;f<c.length;f++){var h=c[f][1],i=2*h/(b+1)+d[f-1][1]*(1-2/(b+1));d.push([c[f][0],a.toFixed(i,4)])}return d}var c={},d={},e={},f={},g={};return{init:function(){!function(h,i){function j(b,h){{var i=this;i.chart}for(var j in d)if(d[j]&&d[j].options&&d[j].options.data&&d[j].options.data.length>0&&c[j].parentSeriesID==i.options.id){var k=i.options.data,l=c[j].period,m=a.findDataUpdatedDataPoint(k,b);if(m>=1){var n=0;n=a.isOHLCorCandlestick(this.options.type)?a.extractPriceForAppliedTO(c[j].appliedTo,k,m):k[m].y?k[m].y:k[m][1];var o=2*n/(l+1)+e[j][m-1][1]*(1-2/(l+1)),p=2*o/(l+1)+f[j][m-1][1]*(1-2/(l+1)),q=2*p/(l+1)+g[j][m-1][1]*(1-2/(l+1)),r=3*o-3*p+q;o=a.toFixed(o,4),p=a.toFixed(p,4),q=a.toFixed(q,4),r=a.toFixed(r,4);var s=k[m].x||k[m][0];h?d[j].options.data.length<k.length?(e[j].push([s,o]),f[j].push([s,p]),g[j].push([s,q]),d[j].addPoint([s,r])):(e[j][m]=[s,o],f[j][m]=[s,p],g[j][m]=[s,q],d[j].data[m].update([s,r])):(e[j].push([s,o]),f[j].push([s,p]),g[j].push([s,q]),d[j].addPoint([s,r]))}}}h&&!h.Series.prototype.addTEMA&&(h.Series.prototype.addTEMA=function(h){var j=this.options.id;h=i.extend({period:21,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],appliedTo:a.CLOSE,parentSeriesID:j},h);var k="_"+(new Date).getTime(),l=this.options.data||[];if(!(h.period>=l.length)){if(l&&l.length>0){for(var m=[],n=h.period,o=0;o<l.length;o++)m.push(a.isOHLCorCandlestick(this.options.type)?[l[o].x?l[o].x:l[o][0],a.extractPriceForAppliedTO(h.appliedTo,l,o)]:[l[o].x?l[o].x:l[o][0],l[o].y?l[o].y:l[o][1]]);for(var p=b.call(this,n,m),q=b.call(this,n,p),r=b.call(this,n,q),s=[],o=0;o<r.length;o++){var t=3*p[o][1]-3*q[o][1]+r[o][1];s.push([r[o][0],a.toFixed(t,4)])}e[k]=p,f[k]=q,g[k]=r;var u=this.chart;c[k]=h;var v=this;d[k]=u.addSeries({id:k,name:"TEMA("+n+", "+a.appliedPriceString(n)+")",data:s,type:"line",dataGrouping:v.options.dataGrouping,opposite:v.options.opposite,color:h.stroke,lineWidth:h.strokeWidth,dashStyle:h.dashStyle,compare:v.options.compare},!1,!1),i(d[k]).data({onChartIndicator:!0,indicatorID:"tema",isIndicator:!0,parentSeriesID:h.parentSeriesID,period:n}),u.redraw()}return k}},h.Series.prototype.removeTEMA=function(a){var b=this.chart;c[a]=null,b.get(a).remove(),d[a]=null,e[a]=[],f[a]=[],g[a]=[]},h.wrap(h.Series.prototype,"addPoint",function(b,d,e,f,g){b.call(this,d,e,f,g),a.checkCurrentSeriesHasIndicator(c,this.options.id)&&j.call(this,d)}),h.wrap(h.Point.prototype,"update",function(b,d,e,f){b.call(this,d,e,f),a.checkCurrentSeriesHasIndicator(c,this.series.options.id)&&j.call(this.series,d,!0)}))}(Highcharts,jQuery,a)}}});