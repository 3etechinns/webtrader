define(["charts/chartingRequestMap","moment","css!charts/chartExport.css","common/util"],function(a,b){function c(a){var b=$("<img />").attr("src","images/download.svg").addClass("export-btn"),c=$("#"+a+"_header");c.prepend(b);var e=$("#"+a+"_chart").data();b.on("click",d.bind(null,e))}function d(c){var d=a.keyFor(c.instrumentCode,c.timePeriod),f=c.instrumentName+" ("+c.timePeriod+").csv",g=e.chain().find({instrumentCdAndTp:d}).simplesort("time",!1).data(),h=g.map(function(a){return'"'+b.utc(a.time).format("YYYY-MM-DD HH:mm")+'",'+a.open+","+a.high+","+a.low+","+a.close}),i="Date,Open,High,Low,Close\n"+h.join("\n"),j=new Blob([i],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(j,f);else{var k=document.createElement("a");if(void 0!==k.download){var l=URL.createObjectURL(j);k.setAttribute("href",l),k.setAttribute("download",f),k.style.visibility="hidden",document.body.appendChild(k),k.click(),document.body.removeChild(k)}}}var e=a.barsTable;return{init:c}});