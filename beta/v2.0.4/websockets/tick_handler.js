define(["websockets/binary_websockets","charts/chartingRequestMap","common/util"],function(a,b){function c(a,c,e){var f=b[a];if(f.chartIDs&&f.chartIDs.length>0){var g=$(f.chartIDs[0].containerIDWithHash).data("timeperiod");if(g){var h=null;if(isTick(g))d.insert({instrumentCdAndTp:a,time:c,open:e,high:e,low:e,close:e});else{if(h=d.chain().find({instrumentCdAndTp:a}).simplesort("time",!0).limit(1).data(),!h||h.length<=0)return;h=h[0],h.close=Math.min(Math.max(e,h.low),h.high),d.update(h)}f.chartIDs.forEach(function(b){var d=$(b.containerIDWithHash).highcharts();if(d){var f=d.get(a);if(f){if(isTick(g))return void f.addPoint([c,e]);var i=$(b.containerIDWithHash).data("type"),j=f.data[f.data.length-1];i&&isDataTypeClosePriceOnly(i)?j.update([j.x,e]):h&&j.update([j.x,h.open,h.high,h.low,h.close])}}})}}}var d=b.barsTable;return a.events.on("tick",function(a){if(a.error)return void $(document).trigger("feedTypeNotification",[d,"delayed-feed"]);var d=a.echo_req.passthrough.instrumentCdAndTp;if(d){b[d]=b[d]||{},b[d].tickStreamingID=a.tick.id,$(document).trigger("feedTypeNotification",[d,"realtime-feed"]);var e=parseFloat(a.tick.quote),f=1e3*parseInt(a.tick.epoch);c(d,f,e)}}),{}});