define(["es6-promise","reconnecting-websocket","js-cookie","token/token","jquery-timer"],function(a,b,c,d){a.polyfill();var e=!1,f=function(){var a="wss://www.binary.com/websockets/v3?l=EN",c=new b(a,null,{debug:!1,timeoutInterval:2500});return c.addEventListener("open",n),c.addEventListener("close",g),c.addEventListener("message",o),c},g=function(){e=!1,require(["charts/chartingRequestMap"],function(a){Object.keys(a).forEach(function(b){var c=a[b],d=c&&c.chartIDs&&c.chartIDs[0]&&c.chartIDs[0].instrumentCode;c&&d&&u.send({ticks:d,passthrough:{instrumentCdAndTp:b}}).then(function(a){c.tickStreamingID=a.tick.id})["catch"](function(a){})})})},h={},i=[],j=[],k={},l={},m=function(){return p&&1===p.readyState},n=function(){for(;j.length>0;)p.send(JSON.stringify(j.shift()));for(;i.length>0;)i.shift()()},o=function(a){var b=JSON.parse(a.data);(h[b.msg_type]||[]).forEach(function(a){a(b)});var c=b.echo_req.passthrough&&b.echo_req.passthrough.uid,d=k[c];d&&(delete k[c],b.error?d.reject(b.error):d.resolve(b))},p=f();require(["websockets/tick_handler"]);var q=function(a){for(prop in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1})if(prop in a)return!0;return!1},r=function(a){return a.passthrough=a.passthrough||{},a.passthrough.uid=(1e17*Math.random()).toString(),new Promise(function(b,c){k[a.passthrough.uid]={resolve:b,reject:c},m()?p.send(JSON.stringify(a)):j.push(a)})},s=function(a){var b=!1,d=JSON.stringify({authorize:a}),f=r({authorize:a});return f.then(function(g){return c.set("webtrader_token",a),e=!0,b=!0,l[d]=f,g})["catch"](function(a){throw b||(e=!1,c.remove("webtrader_token")),delete l[d],a})},t=function(a){if(e)return r(a);var b=r.bind(null,a);return c.get("webtrader_token")?s(c.get("webtrader_token")).then(b):d.getTokenAsync().then(s).then(b)},u={events:{on:function(a,b){(h[a]=h[a]||[]).push(b)}},execute:function(a){m()?setTimeout(a,0):i.push(a)},cached:{send:function(a){var b=JSON.stringify(a);return l[b]?l[b]:l[b]=u.send(a).then(function(a){return a},function(a){throw delete l[b],a})},authorize:function(){var a=c.get("webtrader_token"),b=JSON.stringify({token:a});return e&&a&&l[b]?l[b]:a?s(a):d.getTokenAsync().then(s)}},send:function(a){return q(a)?t(a):r(a)}};return u});