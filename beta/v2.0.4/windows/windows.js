define(["jquery","navigation/navigation","jquery.dialogextend","modernizr","common/util","css!windows/windows.css"],function(a){function b(){e=Math.floor(a(window).width()/350)||1,f=Math.floor(a(window).height()/400)||1,g=e*f,isSmallView()&&(f=e=1)}function c(){b(),require(["charts/chartWindow"],function(b){var c=80;isSmallView()&&(c=100);var d=1,f=1,g=20,h=a(".chart-dialog").dialog("option","minWidth"),i=a(".chart-dialog").dialog("option","minHeight");isSmallView()&&(h=a(window).width()-2*g,i=a(window).height()-c);var j=e*h+(e-1)*g,k=a(window).width()-j,l=(Math.round(k/2),window),m=a(".chart-dialog").length;a(".chart-dialog").each(function(){var g,j=c;g=e>=m?(a(window).width()-h*m)/2:(a(window).width()-h*e)/2,d>1&&(g=g+h*(d-1)+20*(d-1)),f>1&&(j=c+(i*(f-1)+20*(f-1))),l=window,l=a(this).dialog("option",{position:{my:"left+"+g+" top"+(0>j?"-":"+")+j,at:"left top",of:l},width:h,height:i}),b.triggerResizeEffects(a(this).dialog("widget").find(".chart-dialog")),++d>e&&(d=1,++f,l=window)})})}function d(b){b=a.extend({title:"title",date:null,changed:function(){},cleared:function(){}},b);var c=(this.parent().find(".ui-dialog-titlebar").addClass("with-dates with-contents"),this.parent().find(".ui-dialog-title")),d=function(b){function d(a,b){var c=a%4==0&&(a%100!=0||a%400==0);return[31,c?29:28,31,30,31,30,31,31,30,31,30,31][b]}function e(b,c){var d=c.render||function(a){return a+""};b.children().remove();for(var e=c.min;e<=c.max;++e)a("<option/>").val(e).text(d(e)).appendTo(b);return b.val(c.initial||c.min),b.selectmenu("refresh"),b.title=b.title||function(d){if(d)b._title=b._title||a("<option/>").val(-1).prependTo(b),b._title.text(d),b.updating=!0,b.val(-1).selectmenu("refresh"),b.updating=!1;else if(b._title){var e=-1===b.val()?c.initial:b.val();b._title.remove(),b.updating=!0,b.val(e).selectmenu("refresh"),b.updating=!1,this._title=null}},b}var f=b.date||new Date,g=a("<select />").insertAfter(c).selectmenu({width:"70px"}),h=a("<select />").insertAfter(c).selectmenu({width:"65px"}),i=a("<select />").insertAfter(c).selectmenu({width:"60px"});g=e(g,{min:2010,max:f.getFullYear(),initial:f.getFullYear()}),h=e(h,{min:0,max:11,initial:f.getMonth(),render:function(a){return["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"][a]}}),i=e(i,{min:1,max:d(f.getFullYear(),f.getMonth()),initial:f.getDate()}),b.date||(g.title("Year"),h.title("Month"),i.title("Day"));var j=function(){var a=new Date(Date.UTC(g.val(),h.val(),i.val())).toISOString().slice(0,10);b.onchange(a)};i.on("selectmenuchange",function(){i.updating||(i.title(null),h.title(null),g.title(null),j())});var k=function(){var a={min:1,max:d(g.val(),h.val()),initial:i.val()};a.initial>a.max&&(a.initial=a.min),e(i,a)};return[g,h].forEach(function(a){a.on("selectmenuchange",function(){h.updating||g.updating||(i.title(null),h.title(null),g.title(null),k(),j())})}),{update:function(a){i.title(null),h.title(null),g.title(null);var b=a.split("-");g.val(0|b[0]),g.selectmenu("refresh"),h.val((0|b[1])-1),h.selectmenu("refresh"),i.val(0|b[2]),k()},clear:function(){g.title("Year"),h.title("Month"),i.title("Day")}}},e=function(b){var d=a("<input type='hidden' />").insertAfter(c),e=function(c){setTimeout(function(){var d=a(c).datepicker("widget").find(".ui-datepicker-buttonpane");a("<button/>",{text:"Clear",click:function(){b.onclear&&b.onclear(),a(c).datepicker("hide")}}).addClass("ui-datepicker-clear ui-state-default ui-priority-primary ui-corner-all").appendTo(d)},0)},f={showOn:"both",numberOfMonths:2,maxDate:0,minDate:new Date(2010,0,1),dateFormat:"yy-mm-dd",showAnim:"drop",showButtonPanel:!0,changeMonth:!0,changeYear:!0,onSelect:function(){a(this).change()},beforeShow:function(a,b){e(a),b.dpDiv.css({marginTop:"10px",marginLeft:"-220px"})},onChangeMonthYear:e},g=d.datepicker(f).datepicker("setDate",b.date.toISOString().slice(0,10));return a.datepicker._gotoToday=function(b){a(b).datepicker("setDate",new Date).change().datepicker("hide")},g.next("button").text("").button({icons:{primary:"ui-icon-calendar"}}),d.on("change",function(){var c=a(this).val();b.onchange&&b.onchange(c)}),d},f=e({date:b.date||new Date,onchange:function(a){g.update(a),b.changed(a)},onclear:function(){g.clear(),b.cleared()}}),g=d({date:b.date,onchange:function(a){f.datepicker("setDate",a),b.changed(a)}});a('<span class="span-in-dialog-header">'+b.title+"</span>").insertAfter(c)}var e,f,g,h=null,i=0,j=null;return{init:function(d){return b(),j=d.find("ul"),tileObject=j.find(".tile"),h=j.find(".closeAll"),h.click(function(){a(".chart-dialog").length>0&&a(".chart-dialog").dialog("close")}),require(["charts/chartWindow","websockets/binary_websockets","common/menu"],function(a,b,d){tileObject.click(function(){c()});var g=e*f;b.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(b){b=d.extractChartableMarkets(b);for(var e=function(a){return a[Math.floor(Math.random()*a.length)]},f=["2h","4h","8h","1d"],h=["candlestick","line","ohlc","spline"],i=0;g>i;++i){var j=e(b).submarkets,k=e(j).instruments,l=e(k),m=e(f),n=e(h);a.addNewWindow(l.symbol,l.display_name,m,c,n)}})}),this},tile:function(){c()},closeAll:function(){h||h.click()},createBlankWindow:function(b,c){b=a(b);var e="windows-dialog-"+ ++i;c=a.extend({autoOpen:!1,resizable:!0,width:350,height:400,my:"center",at:"center",of:window,title:"blank window"},c||{}),c.minWidth=c.minWidth||c.width,c.minHeight=c.minHeight||c.height,c.resize&&(c.maximize=c.minimize=c.restore=c.resize);var f=b.attr("id",e).dialog(c).dialogExtend(c),g=null,h=function(){var b=a("<a href='#'>"+c.title+"</a>");b.click(function(){f.dialog("moveToTop").parent().effect("bounce",{times:2,distance:15},450)}),g=a("<li />").addClass(e+"LI").html(b),j.append(g)};return h(),f.on("dialogclose",function(){g.remove(),g=null}),f.on("dialogopen",function(){!g&&h()}),c.resize&&c.resize.call(b[0]),f.addDateToHeader=d,f},makeSelectmenu:function(b,c){c=a.extend({list:["empty"],inx:0,changed:function(){}},c);var d=c.inx,e=c.list,f=function(c){b.children().remove();for(var d=0;d<c.length;++d)a("<option/>").val(c[d]).text(c[d]).appendTo(b)};return f(e),b.val(e[d]),b=b.selectmenu({width:c.width}),b.on("selectmenuchange",function(){var b=a(this).val();c.changed(b)}),b.update_list=function(a){f(a),b.val(a[0]),b.selectmenu("refresh")},b}}});