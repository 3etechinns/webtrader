define(["windows/windows","websockets/binary_websockets","lodash","navigation/menu"],function(a,b,c,d){function e(a){i=h,h={},k();var c={assetIndex:"#nav-container .assetIndex",statement:"#nav-container .statement",tradingTimes:"#nav-container .tradingTimes",download:"#nav-container .download",portfolio:"#nav-container .portfolio",profitTable:"#nav-container .profitTable",token:"#nav-container .token-management",deposit:"#nav-container .deposit",withdraw:"#nav-container .withdraw"},d=0,e=function(e,f){if("closed"!==e.position.mode)if(e.is_unique)e.is_authorized?b.events.on_till("login",function(){return $(c[f]).click(),!0}):$(c[f]).click();else if("chartWindow"===f){var g=e.data.instrumentCode;if(a.length>0&&-1===a.indexOf(g))return;e.data.tracker_id=++d,require(["charts/chartWindow"],function(a){a.addNewWindow(e.data)})}else"tradeDialog"===f&&b.events.on_till("login",function(){return e.data.tracker_id=++d,b.send({contracts_for:e.data.symbol}).then(function(a){require(["trade/tradeDialog"],function(b){b.init(e.data,a.contracts_for)})})["catch"](void 0),!0})};_.forEach(i,function(a,b){_.isArray(a)?a.forEach(function(a){e(a,b)}):e(a,b)})}function f(a,b,c,d){var e=d.position;e.size&&b.dialog("option","width",e.size.width),e.size&&b.dialog("option","height",e.size.height),c.position.size=e.size,c.position.mode=e.mode,"maximized"===e.mode?setTimeout(function(){b.dialogExtend("maximize"),b.dialog("moveToTop")},10):"minimized"===e.mode&&b.dialogExtend("minimize"),e.offset&&(a.css({left:e.offset.left+"px",top:e.offset.top+"px"}),c.position.offset=e.offset),k()}function g(a,b){var c=b.dialog("widget"),d=null,e={module_id:a.module_id,is_unique:a.is_unique,is_authorized:"true"===b.attr("data-authorized"),data:a.data,position:{size:{width:b.dialog("option","width"),height:b.dialog("option","height")},offset:void 0,mode:"normal"}};if(a.is_unique)h[a.module_id]=e,d=i[a.module_id],d&&("closed"===d.position.mode&&(d=null),delete i[a.module_id]);else if(h[a.module_id]=h[a.module_id]||[],h[a.module_id].push(e),i[a.module_id]&&void 0!==e.data.tracker_id){var g=_.findIndex(i[a.module_id],function(a){return a.data.tracker_id===e.data.tracker_id});-1!==g&&(d=i[a.module_id][g],i[a.module_id].splice(g,1),"closed"===d.position.mode&&(d=null))}return k(),c.on("dragstop",function(){e.position.offset=c.offset(),k()}),c.on("animated",function(){e.position.offset=c.offset(),k()}),c.on("resizestop",function(a,b){e.position.size=b.size,e.position.offset=c.offset(),k()}),b.on("dialogextendminimize",function(){e.position.mode="minimized",k()}),b.on("dialogextendmaximize",function(){e.position.mode="maximized",k()}),b.on("dialogextendrestore",function(){e.position.offset=c.offset(),e.position.mode="normal",k()}),b.on("dialogdestroy",function(){if(e.is_unique)delete h[e.module_id];else{var a=h[e.module_id].indexOf(e);1==h[e.module_id].length?delete h[e.module_id]:h[e.module_id].splice(a,1)}k()}),b.on("dialogclose",function(){e.position.mode="closed",k()}),b.on("dialogopen",function(){e.position.offset=c.offset(),e.position.mode="normal",k(),d&&(f(c,b,e,d),d=null)}),function(a){e.data=a,k()}}var h=local_storage.get("states")||{},i={},j=b.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(a){var b=d.extractChartableMarkets(a),c=_(b).map("submarkets").flatten().map("instruments").flatten().map("symbol").value();return c})["catch"](function(a){return[]}),k=_.debounce(function(){local_storage.set("states",h)},50);return{track:g,reopen:function(){j.then(e)},is_empty:function(){var a=_.values(h).filter(function(a){return _.isArray(a)||"closed"!==a.position.mode});return 0===a.length}}});