define(["jquery","common/rivetsExtra","charts/chartWindow","charts/charts","moment","charts/chartingRequestMap","common/util"],function(a,b,c,d,e,f){function g(a){a.showTimePeriodSelector=!1,a.showChartTypeSelector=!1,a.showDrawingToolSelector=!1,a.showExportSelector=!1,a.showLoadSaveSelector=!1}function h(b,c){switch(b){case o:a("#"+c+" .chartOptions .chartTypeOverlay > .chartoptions-horizontal-line:first-child").css({width:"60px",left:"34px"});break;case p:a("#"+c+" .chartOptions .chartTypeOverlay > .chartoptions-horizontal-line:first-child").css({width:"58px",left:"36px"});break;case q:a("#"+c+" .chartOptions .chartTypeOverlay > .chartoptions-horizontal-line:first-child").css({width:"52px",left:"41px"});break;case r:case s:a("#"+c+" .chartOptions .chartTypeOverlay > .chartoptions-horizontal-line:first-child").css({width:"53px",left:"40px"});break;case t:a("#"+c+" .chartOptions .chartTypeOverlay > .chartoptions-horizontal-line:first-child").css({width:"53px",left:"41px"})}}function i(b,c){c==u?b.tableViewCallback&&b.tableViewCallback():(b.chartType=c,d.refresh("#"+b.newTabId+"_chart",null,b.chartType),a("#"+b.newTabId).trigger("chart-type-changed",b.chartType),h(c,b.newTabId)),g(b)}function j(b){var c=!1,d=a(b).highcharts();return d&&d.series.forEach(function(a){"percent"===a.options.compare&&(c=!0)}),c}function k(b){switch(b){case"1t":a(".chartOptions .timePeriodOverlay > .chartoptions-horizontal-line:first-child").css({width:"85%",left:"40px"});break;case"1m":case"2m":case"3m":case"5m":a(".chartOptions .timePeriodOverlay > .chartoptions-horizontal-line:first-child").css({width:"82%",left:"47px"});break;case"10m":case"15m":case"30m":a(".chartOptions .timePeriodOverlay > .chartoptions-horizontal-line:first-child").css({width:"80%",left:"54px"});break;case"1h":case"2h":case"4h":case"8h":case"1d":a(".chartOptions .timePeriodOverlay > .chartoptions-horizontal-line:first-child").css({width:"84%",left:"43px"})}}var l={},m={},n={},o="candlestick",p="ohlc",q="line",r="dot",s="linedot",t="spline",u="table",v=(local_storage.get("i18n")||{value:"en"}).value,w="https://webtrader.binary.com?affiliates=true&instrument={0}&timePeriod={1}&lang="+v,x='<iframe src="'+w+'" width="350" height="400" style="overflow-y : hidden;" scrolling="no" />',y="https://twitter.com/share?url={0}&text={1}",z="https://facebook.com/sharer/sharer.php?u={0}",A="https://plus.google.com/share?url={0}",B="https://www.blogger.com/blog-this.g?u={0}&n={1}",C="http://vk.com/share.php?url={0}&title={1}";return{init:function(e,o,p,q,r,s){require(["text!charts/chartOptions.html","css!charts/chartOptions.css"],function(t){m[e]&&m[e].unbind(),l[e]={newTabId:e,timePeriod:o,chartType:p,tableViewCallback:q,instrumentName:r,instrumentCode:s,indicatorsCount:0,overlayCount:0,showTimePeriodSelector:!1,showChartTypeSelector:!1,showCandlestickAndOHLC:!j("#"+e+"_chart"),showTableOption:!0,enableCrosshair:!0,showDrawingToolSelector:!1,showExportSelector:!1,showLoadSaveSelector:!1,exportChartURLShare:w.format(s,o),exportChartIframeShare:x.format(s,o),fbShareLink:z.format(encodeURIComponent(w.format(s,o))),twitterShareLink:y.format(encodeURIComponent(w.format(s,o)),r+"("+o+")"),gPlusShareLink:A.format(encodeURIComponent(w.format(s,o))),bloggerShareLink:B.format(w.format(s,o),r+"("+o+")"),vkShareLink:C.format(w.format(s,o),r+"("+o+")")},m[e]=null,l[e].toggleTimerPeriodSelector=function(a,b){var c=!b.showTimePeriodSelector;g(b),b.showTimePeriodSelector=c},l[e].toggleChartTypeSelector=function(a,b){var c=!b.showChartTypeSelector;g(b),b.showChartTypeSelector=c},l[e].addRemoveIndicator=function(a,b){require(["charts/indicators/indicatorManagement"],function(a){var c=b.instrumentName+" ("+b.timePeriod+")";a.openDialog("#"+b.newTabId+"_chart",c)}),g(b)},l[e].addRemoveOverlay=function(a,b){require(["charts/overlay/overlayManagement"],function(a){var c=b.instrumentName+" ("+b.timePeriod+")";a.openDialog("#"+b.newTabId+"_chart",c)}),g(b)},l[e].changeChartType=function(a,b){var c=a.target.dataset.charttype;c&&i(b,c)},l[e].changeTimePeriod=function(b,h){var i=b.target.dataset.timeperiod;if(a("#"+e+" .timePeriodOverlay [data-timeperiod="+h.timePeriod+"]").removeAttr("disabled"),a("#"+e+" .timePeriodOverlay [data-timeperiod="+i+"]").attr("disabled",""),i){f.unregister(f.keyFor(h.instrumentCode,h.timePeriod),"#"+h.newTabId+"_chart"),h.timePeriod=i;var l=isTick(i);h.showCandlestickAndOHLC=l?!1:!j("#"+h.newTabId+"_chart"),h.chartType=l?"line":h.chartType,d.refresh("#"+h.newTabId+"_chart",i,h.chartType),"true"===getParameterByName("affiliates")?d.changeTitle("#"+h.newTabId+"_chart",h.instrumentName+" ("+i+")"):c.changeChartWindowTitle(h.newTabId,h.instrumentName,i),g(h),h.exportChartURLShare=w.format(h.instrumentCode,i),h.exportChartIframeShare=x.format(h.instrumentCode,i),h.fbShareLink=z.format(encodeURIComponent(w.format(s,o))),h.twitterShareLink=y.format(encodeURIComponent(w.format(s,o)),r+"("+o+")"),h.gPlusShareLink=A.format(encodeURIComponent(w.format(s,o))),h.bloggerShareLink=B.format(encodeURIComponent(w.format(s,o)),r+"("+o+")"),h.vkShareLink=C.format(encodeURIComponent(w.format(s,o)),r+"("+o+")"),k(i),a("#"+h.newTabId).trigger("chart-time-period-changed",i)}},isTick(o)&&(l[e].showCandlestickAndOHLC=!1),q||(l[e].showTableOption=!1),l[e].toggleCrosshair=function(a,b){b.enableCrosshair=!b.enableCrosshair,require(["charts/crosshair"],function(a){a.toggleCrossHair("#"+b.newTabId+"_chart")}),g(b)},l[e].toggleDrawingToolSelector=function(a,b){var c=!b.showDrawingToolSelector;g(b),b.showDrawingToolSelector=c},l[e].addDrawingTool=function(b,c){var d=b.target.dataset.drawingtool;d&&(require(["charts/draw/highcharts_custom/"+d],function(b){var d="#"+c.newTabId+"_chart";a(d).highcharts().annotate=!0,b.init(d)}),g(c))},l[e].toggleExportSelector=function(a,b){var c=!b.showExportSelector;g(b),b.showExportSelector=c},l[e].toggleLoadSaveSelector=function(a,b){var c=!b.showLoadSaveSelector;g(b),b.showLoadSaveSelector=c},l[e]["export"]=function(b,c){var e=b.target.dataset.exporttype;if(e){var f="#"+c.newTabId+"_chart",h=a(f).highcharts();switch(e){case"png":h.exportChartLocal();break;case"pdf":h.exportChart({type:"application/pdf"});break;case"csv":d.generate_csv(h,a(f).data());break;case"svg":h.exportChartLocal({type:"image/svg+xml"})}g(c)}},a("#"+e).on("chart-indicators-changed",function(a,b){l[e].indicatorsCount=b.get_indicators().length}),l[e].overlayCount=a("#"+e+"_chart").data("overlayCount"),a("#"+e).on("chart-overlay-add",function(){var b=a("#"+e+"_chart").highcharts();l[e].overlayCount=b.get_overlay_count()}),a("#"+e).on("chart-overlay-remove",function(){var b=a("#"+e+"_chart").highcharts();l[e].overlayCount=b.get_overlay_count()});var u=a(t);a("#"+e+"_header").prepend(u),a("#"+e+" .timePeriodOverlay [data-timeperiod="+o+"]").attr("disabled",""),k(o),h(p,e),m[e]=b.bind(u[0],l[e]),require(["charts/chartTemplateManager"],function(a){var b=u.find(".chart-template-manager-root");n[e]=a.init(b,e)})})},updateOptions:function(a,b,c,d,e){var f=l[a];f&&(f.chartType=b,f.timePeriod=c,f.indicatorsCount=d,f.overlayCount=e)},disableEnableCandlestickAndOHLC:function(a,b){l[a]&&(l[a].showCandlestickAndOHLC=b)},selectChartType:function(a,b,c){c?l[a].changeChartType(l[a],b):l[a].chartType=b},cleanBinding:function(a){m[a]&&(m[a].unbind(),n[a]&&n[a].unbind(),delete n[a],delete m[a],delete l[a])},setIndicatorsCount:function(a,b){l[b].indicatorsCount=a}}});