{"version":3,"sources":["../../../../src/cashier/withdraw.es6"],"names":[],"mappings":"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","file":"withdraw.js","sourcesContent":["/*\n * Created by amin on July 16, 2016.\n */\n\ndefine(['jquery', 'websockets/binary_websockets', 'windows/windows', 'common/rivetsExtra', 'lodash', 'moment'], function($, liveapi, windows, rv, _, moment) {\n    require(['text!cashier/withdraw.html']);\n    require(['css!cashier/withdraw.css']);\n\n    let win = null;\n    let win_view = null;\n\n    let error_handler = err => {\n      console.error(err);\n      $.growl.error({ message: err.message });\n    };\n\n    class Withdraw {\n      init = li => {\n        li.click(() => {\n            if(!win)\n              require(['text!cashier/withdraw.html'], this._init_win);\n            else\n              win.moveToTop();\n        });\n      }\n\n      _init_win = root => {\n        root = $(root);\n        win = windows.createBlankWindow(root, {\n            title: 'Withdraw funds',\n            resizable: true,\n            collapsable: false,\n            minimizable: true,\n            maximizable: true,\n            width: 700,\n            height: 400,\n            'data-authorized': true,\n            close: () => {\n              win.dialog('destroy');\n              win.trigger('dialogclose'); // TODO: figure out why event is not fired.\n              win.remove();\n              win = null;\n            },\n            open: () => { },\n            destroy: () => {\n              win_view && win_view.unbind();\n              win_view = null;\n            }\n        });\n\n        this._init_state(root);\n        win.dialog('open');\n\n        /* update dialog position, this way when dialog is resized it will not move*/\n        var offset = win.dialog('widget').offset();\n        offset.top = 110;\n        win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\n        win.dialog('widget').css({\n            left: offset.left + 'px',\n            top: offset.top + 'px'\n        });\n        win.fixFooterPosition();\n        win.track({\n          module_id: 'withdraw',\n          is_unique: true\n        });\n      };\n\n      _init_state = root => {\n        var state = {\n          route: { value: 'menu'},\n          empty_fields: {\n            validate: false,\n            clear: _.debounce(() => ( state.empty_fields.validate = false ), 4000),\n            show: () => {\n              state.empty_fields.validate = true;\n              state.empty_fields.clear();\n            }\n          },\n          menu: {\n            choice: ''\n          },\n          verify: {\n            token: '',\n            code: '',\n            disabled: false,\n          },\n          transfer: {\n            disabled: false,\n            account: '',\n            amount: '',\n            loginid: local_storage.get('authorize').loginid,\n          },\n          standard: {\n            url: '',\n            iframe_visible: false\n          },\n          agent: {\n            disabled: false,\n            loginid: '',\n            name: '',\n            agents: [],\n            commission: '',\n            amount: '',\n            currency: local_storage.get('authorize').currency,\n            residence: '',\n            instructions: '',\n          },\n        };\n        let {route, menu, verify, empty_fields, standard, agent, transfer} = state;\n\n        let routes = { menu : 400, verify: 400, transfer: 400, 'transfer-done': 300, standard: 400, agent: 550, 'agent-confirm': 400, 'agent-done': 300 };\n        route.update = r => {\n          route.value = r;\n          win.dialog('option', 'height', routes[r]);\n        };\n\n        menu.click = choice => { /* choice is 'transfer', 'agent' or 'standard' */\n          menu.choice = choice;\n          route.update(choice !== 'transfer' ? 'verify' : 'transfer');\n          if(choice === 'transfer')\n            return;\n          const email = local_storage.get('authorize').email;\n          const type = choice === 'agent' ? 'paymentagent_withdraw' : 'payment_withdraw';\n          liveapi.send({\n            verify_email: email,\n            type: type\n          })\n          .then(() => $.growl.notice({ message: 'Verification code sent to '.i18n() + email }))\n          .catch(err => {\n            error_handler(err);\n            route.update('menu');\n          });\n        };\n\n        verify.back = () => {\n          verify.token = verify.code = '';\n          route.update('menu');\n        };\n\n        verify.unlock = () => {\n          if(!verify.token) {\n            empty_fields.show();\n            return;\n          }\n\n          if(menu.choice === 'standard') {\n            verify.disabled = true;\n            liveapi.send({\n              cashier: 'withdraw',\n              verification_code: verify.token\n            })\n            .then(data => {\n              if(data.cashier.startsWith('ASK_')) { /* error code */\n                throw new Error(data.cashier);\n              }\n              standard.url = data.cashier;\n              verify.disabled = false;\n              route.update('standard');\n              verify.code = verify.token;\n              verify.token = '';\n            })\n            .catch(err => {\n              verify.disabled = false;\n              error_handler(err);\n            });\n          }\n          else if(menu.choice == 'agent') {\n            verify.code = verify.token;\n            verify.token = '';\n            route.update('agent');\n          }\n        };\n\n        standard.iframe_loaded = () => {\n          if(standard.url)\n            standard.iframe_visible = true;\n        };\n\n        agent.onchanged = () => {\n          if(agent.loginid) {\n            let {withdrawal_commission, name} = agent.agents.find(a => a.paymentagent_loginid == agent.loginid);\n            agent.commission = withdrawal_commission;\n            agent.name = name;\n          }\n          else {\n            agent.commission = '';\n            agent.name = '';\n          }\n        }\n\n        agent.amount_with_commission = () => {\n            var with_commission = (agent.amount || 0)*(100 - agent.commission)/100;\n            return with_commission.toFixed(2);\n        }\n\n        agent.click = () => {\n          if(!agent.loginid) {\n            $.growl.error({message: 'Please select a payment agent'.i18n()});\n            return;\n          }\n          if(!(agent.amount >= 10 && agent.amount <= 2000)) {\n            $.growl.error({message: 'Amount Min: 10 Max: 2000'.i18n()});\n            return;\n          }\n          if(!agent.instructions) {\n            empty_fields.show();\n            return;\n          }\n\n          route.update('agent-confirm');\n        }\n\n        agent.confirm_transfer = () => {\n          var request = {\n            paymentagent_withdraw: 1,\n            paymentagent_loginid: agent.loginid,\n            currency: agent.currency,\n            amount: agent.amount*1,\n            verification_code: verify.code\n          };\n          agent.disabled = true;\n          liveapi.send(request)\n                 .then(data => {\n                   route.update('agent-done')\n                   agent.disabled = false;\n                 })\n                 .catch(err => {\n                    agent.disabled = false;\n                    route.update('menu') // because tokens are one time use.\n                    error_handler(err);\n                 });\n        }\n\n        transfer.submit = () => {\n          if(transfer.account === '' || transfer.amount === '') {\n            empty_fields.show();\n            return;\n          }\n          var req = {\n            transfer_between_accounts: 1,\n            account_from: transfer.loginid,\n            account_to: transfer.account,\n            currency: agent.currency,\n            amount: transfer.amount\n          };\n          transfer.disabled = true;\n          liveapi.send(req)\n            .then(data => {\n              if(data.transfer_between_accounts === 0) {\n                $.growl.error({message: 'Transfering funds between accounts failed'.i18n() });\n                return;\n              }\n              route.update('transfer-done');\n            })\n            .catch(err => {\n              error_handler(err);\n              transfer.disabled = false;\n            });\n        }\n\n        liveapi.send({get_settings: 1})\n               .then(data => {\n                 agent.residence = data.get_settings.country_code;\n                 return liveapi.cached.send({paymentagent_list: agent.residence });\n               })\n               .then(data => {\n                 agent.agents = data.paymentagent_list.list;\n               })\n               .catch(error_handler);\n\n        liveapi.send({payout_currencies: 1})\n            .then(data => {\n                agent.currency = data.payout_currencies[0];\n            }).catch(err => console.error(err));\n\n        win_view = rv.bind(root[0], state);\n      };\n    };\n\n    return new Withdraw();\n});\n"]}