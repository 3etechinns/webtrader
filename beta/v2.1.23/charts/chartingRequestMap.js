define(["exports","lokijs","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(a,b,c,d,e){"use strict";function f(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(a,"__esModule",{value:!0}),a.digits_after_decimal=a.removeChart=a.unregister=a.subscribe=a.register=a.keyFor=a.processOHLC=a.barsLoaded=a.barsTable=void 0;var g=f(b),h=f(c),i=f(d),j=f(e),k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},l=new g["default"],m=a.barsTable=l.addCollection("bars_table"),n=a.barsLoaded=function(a){var b=a;if(this[b]&&this[b].chartIDs){var c=this[b].chartIDs,d=this.processOHLC;c.forEach(function(a){if(a){var c=i["default"](a.containerIDWithHash).highcharts().get(b),e=i["default"](a.containerIDWithHash).data("type"),f=i["default"](a.containerIDWithHash).data("timePeriod");if(c)!function(){var a=c.data[c.data.length-1].x||c.data[c.data.length-1].time,d=m.chain().find({instrumentCdAndTp:b}).where(function(b){return b.time>=a}).simplesort("time",!1).data();for(var f in d){for(var g=d[f],h=void 0,i=c.data.length-1;i>=0;i--){var j=c.data[i];if(j&&g.time==(j.x||j.time)){h=j;break}}h?e&&isDataTypeClosePriceOnly(e)?h.update([g.time,g.close],!1):h.update([g.time,g.open,g.high,g.low,g.close],!1):e&&isDataTypeClosePriceOnly(e)?c.addPoint([g.time,g.close],!1,!0):c.addPoint([g.time,g.open,g.high,g.low,g.close],!1,!0)}c.isDirty=!0,c.isDirtyData=!0,c.chart.redraw()}();else{var g=function(){var c=i["default"](a.containerIDWithHash).highcharts(),g=[],h=m.chain().find({instrumentCdAndTp:b}).simplesort("time",!1).data();for(var j in h)d(h[j].open,h[j].high,h[j].low,h[j].close,h[j].time,e,g);if(!c||0===g.length)return{v:void 0};var k=30;isTick(f)&&(k=200);var l=g.length,n=g.length>k?l-k:0,o=a.instrumentName,p=a.series_compare,q=0;c.series.forEach(function(a){a.options.isInstrument&&"navigator"!==a.options.id&&++q}),0===q&&(c.xAxis[0].range=g[l-1][0]-g[n][0]);var r={id:b,name:o,data:g,type:e?e:"candlestick",dataGrouping:{enabled:!1},compare:p,states:{hover:{enabled:!1}},isInstrument:!0};(isLineDotType(e)||isDotType(e))&&(r.type="line",isDotType(e)&&(r.dashStyle="dot"),r.marker={enabled:!isDotType(e),radius:4}),c.addSeries(r)}();if("object"===("undefined"==typeof g?"undefined":k(g)))return g.v}}})}},o=a.processOHLC=function(a,b,c,d,e,f,g){if(!(g.length>0&&g[g.length-1][0]>e))if(f&&isDataTypeClosePriceOnly(f)){if(!i["default"].isNumeric(e)||!i["default"].isNumeric(d))return;g.push([e,d])}else{if(!(i["default"].isNumeric(e)&&i["default"].isNumeric(a)&&i["default"].isNumeric(b)&&i["default"].isNumeric(c)&&i["default"].isNumeric(d)))return;g.push([e,a,b,c,d])}},p=a.keyFor=function(a,b){var c=b||0;return"string"==typeof c&&(c=convertToTimeperiodObject(c).timeInSeconds()),(a+c).toUpperCase()},q=a.register=function(a){var b=this,c=b.keyFor(a.symbol,a.granularity),d=a.granularity||0,e=0!=d&&a.style?a.style:"ticks",f=!0;"string"==typeof d&&("0"==i["default"].trim(d)||("1t"==i["default"].trim(d).toLowerCase()?d=convertToTimeperiodObject(d).timeInSeconds():(f=!1,d=convertToTimeperiodObject(d).timeInSeconds())));var g={ticks_history:a.symbol,granularity:d,count:a.count||1,end:"latest",style:e};if(1===a.subscribe&&(g.subscribe=1),!f){var h=a.count||1,k=(new Date).getTime()/1e3-h*d|0,l=new Date;l.setUTCFullYear(l.getUTCFullYear()-3),l.setDate(l.getDate()+1),1e3*k<l.getTime()&&(k=l.getTime()/1e3|0),g.style="candles",g.start=k,g.adjust_start_time=a.adjust_start_time||1}return b[c]={symbol:a.symbol,granularity:d,subscribers:0,chartIDs:[]},g.subscribe&&(b[c].subscribers=1),j["default"].send(g,3e4)["catch"](function(d){if(g.subscribe&&"MarketIsClosed"==d.code)return i["default"].growl.notice({message:a.symbol+" market is presently closed.".i18n()}),delete g.subscribe,b[c].subscribers-=1,j["default"].send(g,3e4);throw delete b[c],d})},r=a.subscribe=function(a,b){var c=this;c[a]&&(c[a].subscribers+=1,b&&c[a].chartIDs.push(b))},s=a.unregister=function(a,b){var c=this;c[a]&&(b&&h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}),c[a].subscribers-=1,0===c[a].chartIDs.length&&c[a].timerHandler&&(clearInterval(c[a].timerHandler),c[a].timerHandler=null),0===c[a].subscribers&&c[a].id&&j["default"].send({forget:c[a].id})["catch"](function(a){}),0===c[a].subscribers&&delete c[a])},t=a.removeChart=function(a,b){var c=this;c[a]&&h["default"](c[a].chartIDs).map("containerIDWithHash").includes(b)&&(c[a].subscribers-=1,h["default"].remove(c[a].chartIDs,{containerIDWithHash:b}))},u=a.digits_after_decimal=function(a,b){var c=this;if(a=a&&a+"",!a){var d=function(){var a=c.keyFor(b,0),d=0;return m.chain().find({instrumentCdAndTp:a}).simplesort("time",!0).limit(10).data().forEach(function(a){var b=a.close+"",c=b.substring(b.indexOf(".")+1).length;c>d&&(d=c)}),{v:d}}();if("object"===("undefined"==typeof d?"undefined":k(d)))return d.v}return a.substring(a.indexOf(".")+1).length};a["default"]={barsLoaded:n,processOHLC:o,keyFor:p,barsTable:m,register:q,subscribe:r,unregister:s,removeChart:t,digits_after_decimal:u}});