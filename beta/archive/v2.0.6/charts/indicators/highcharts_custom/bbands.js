define(["jquery","indicator_base","highcharts-more"],function(a,b){function c(a,c,d,e){var f=0;return f=b.isOHLCorCandlestick(e)?b.extractPriceForAppliedTO(d.appliedTo,a,c):b.extractPrice(a,c)}function d(a,b,d,e,f){for(var g=0,h=0;h<d.period&&b>=0;h++){var i=c(a,b,d,e),j=Math.pow(i-f,2);g+=j,--b}return Math.sqrt(g/h)}function e(a,d,e,f,g){var h=null;if(e>=1){var i=c(a,e,f,g);h=b.toFixed(((d[e-1].y||d[e-1][1])*(f.period-1)+i)/f.period,4)}return h}function f(a,b,d){for(var f=[],g=0,h=0;h<b.period;h++)g+=c(a,h,b,d),f.push(h==b.period-1?[a[b.period-1].x?a[b.period-1].x:a[b.period-1][0],g/b.period]:[a[h].x?a[h].x:a[h][0],null]);for(var h=b.period;h<a.length;h++){var i=e(a,f,h,b,d);f.push([a[h].x||a[h][0],i])}return f}function g(a,b,d,e,f){var g=c(a,d,e,f);return 2*g/(e.period+1)+(b[d-1][1]||b[d-1].y)*(1-2/(e.period+1))}function h(a,d,e){for(var f=[],h=0,i=0;i<d.period;i++)h+=c(a,i,d,e),f.push(i==d.period-1?[a[d.period-1].x?a[d.period-1].x:a[d.period-1][0],h/d.period]:[a[i].x?a[i].x:a[i][0],null]);for(var i=d.period;i<a.length;i++){var j=g(a,f,i,d,e);f.push([a[i].x||a[i][0],b.toFixed(j,4)])}return f}function i(c,d){for(var e=[],f=0,g=0;d>g;g++)if(f+=c[g][1],g==d-1){var h=f/d;a.isNumeric(h)||(h=c[g][1]),e.push([c[g][0],h])}else e.push([c[g][0],null]);for(var g=d;g<c.length;g++){var i=c[g][1],j=2*i/(d+1)+e[g-1][1]*(1-2/(d+1));e.push([c[g][0],b.toFixed(j,4)])}return e}function j(a,d,e,f){for(var g=[],h=0;h<a.length;h++){var j=c(a,h,d,e);g.push([a[h].x?a[h].x:a[h][0],j])}for(var k=i(g,d.period),l=i(k,d.period),m=i(l,d.period),n=[],h=0;h<m.length;h++){var o=3*k[h][1]-3*l[h][1]+m[h][1];n.push([m[h][0],b.toFixed(o,4)])}return x[f]=k,y[f]=l,z[f]=m,n}function k(a,d,e,f,g,h){var i=c(a,d,e,f),j=e.period,k=2*i/(j+1)+x[g][d-1][1]*(1-2/(j+1)),l=2*k/(j+1)+y[g][d-1][1]*(1-2/(j+1)),m=2*l/(j+1)+z[g][d-1][1]*(1-2/(j+1)),n=3*k-3*l+m;k=b.toFixed(k,4),l=b.toFixed(l,4),m=b.toFixed(m,4),n=b.toFixed(n,4);var o=a[d].x||a[d][0];return h?(x[g][d]=[o,k],y[g][d]=[o,l],z[g][d]=[o,m]):(x[g].push([o,k]),y[g].push([o,l]),z[g].push([o,m])),n}function l(a,b,d,e){for(var f=0,g=d,h=b.period;g>=0&&h>=0;h--,g--){var i=c(a,g,b,e);f+=i*h}return f/(b.period*(b.period+1)/2)}function m(a,c,d){for(var e=[],f=0;f<c.period;f++)e.push([a[c.period-1].x?a[c.period-1].x:a[c.period-1][0],null]);for(var f=c.period;f<a.length;f++){var g=l(a,c,f,d);e.push([a[f].x||a[f][0],b.toFixed(g,4)])}return e}function n(a,b,d,e,f,g){var h=c(a,d,e,f);return(b[d-1][1]*(g-1)+h)/g}function o(a,c,d){for(var e=[],f=0,g=c.period+1,h=Math.round(g/2),i=0;h>i;i++)f+=b.isOHLCorCandlestick(d)?b.extractPriceForAppliedTO(c.appliedTo,a,i):b.extractPrice(a,i),e.push(i==h-1?[a[h-1].x?a[h-1].x:a[h-1][0],f/h]:[a[i].x?a[i].x:a[i][0],null]);for(var i=h;i<a.length;i++){var j=n(a,e,i,c,d,h);e.push([a[i].x||a[i][0],b.toFixed(j,4)])}return e}function p(a,b,c,d,f,h,i){var j=null;switch(d.maType){case"SMA":j=e(a,b,c,d,f);break;case"EMA":j=g(a,b,c,d,f);break;case"WMA":j=l(a,d,c,f);break;case"TEMA":j=k(a,c,d,f,h,i);break;case"TRIMA":var m=Math.round((d.period+1)/2);j=n(a,b,c,d,f,m)}return j}function q(a,b,c,d){var e=[];switch(b.maType){case"SMA":e=f(a,b,c);break;case"EMA":e=h(a,b,c);break;case"WMA":e=m(a,b,c);break;case"TEMA":e=j(a,b,c,d);break;case"TRIMA":e=o(a,b,c)}return e}function r(a,c,e,f){for(var g=[],h=0;h<a.length;h++){var i=c[h][1],j=d(a,h,e,f,i),k=i-j*e.devDn;g.push([a[h].x||a[h][0],b.toFixed(k,4)])}return g}function s(a,c,e,f){for(var g=[],h=0;h<a.length;h++){var i=c[h][1],j=d(a,h,e,f,i),k=i+j*e.devDn;g.push([a[h].x||a[h][0],b.toFixed(k,4)])}return g}var t={},u={},v={},w={},x={},y={},z={};return{init:function(){!function(a,b,c){function e(a,b){{var d=this;d.chart}for(var e in u)if(u[e]&&u[e].options&&u[e].options.data&&u[e].options.data.length>0&&t[e].parentSeriesID==d.options.id){var f=d.options.data,g=u[e].options.data,h=t[e],i=(u[e].options.data,c.findIndexInDataForTime(f,a));if(i>=1){var j=p(f,g,i,h,this.options.type,e,b&&u[e].options.data.length>=f.length);b?u[e].data[i].update({y:c.toFixed(j,4)}):u[e].addPoint([f[i].x||f[i][0],c.toFixed(j,4)],!0,!0,!1)}}}function f(a,b){{var e=this;e.chart}for(var f in v)if(v[f]&&v[f].options&&v[f].options.data&&v[f].options.data.length>0&&t[f].parentSeriesID==e.options.id){var g=e.options.data,h=(v[f].options.data,f.replace("u","m")),i=u[h].options.data,j=t[f],k=c.findIndexInDataForTime(g,a);if(k>=1){var l=i[k][1]||i[k].y,m=d(g,k,j,this.options.type,l),n=l+m*j.devDn;b?v[f].data[k].update({y:c.toFixed(n,4)}):v[f].addPoint([g[k].x||g[k][0],c.toFixed(n,4)],!0,!0,!1)}}}function g(a,b){{var e=this;e.chart}for(var f in w)if(w[f]&&w[f].options&&w[f].options.data&&w[f].options.data.length>0&&t[f].parentSeriesID==e.options.id){var g=e.options.data,h=(w[f].options.data,f.replace("l","m")),i=u[h].options.data,j=t[f],k=c.findIndexInDataForTime(g,a);if(k>=1){var l=i[k][1]||i[k].y,m=d(g,k,j,this.options.type,l),n=l-m*j.devDn;b&&w[f].options.data.length>=g.length?w[f].data[k].update({y:c.toFixed(n,4)}):w[f].addPoint([g[k].x||g[k][0],c.toFixed(n,4)],!0,!0,!1)}}}function h(a,b){var d=this,e=d.chart;for(var f in v)if(v[f]&&v[f].options&&v[f].options.data&&v[f].options.data.length>0&&t[f].parentSeriesID==d.options.id){var g=d.options.data,h=v[f].options.data,i=w[f.replace("u","l")].options.data,j=c.findIndexInDataForTime(g,a),k=g[j].x||g[j][0],l=i[j].y||i[j][1],m=h[j].y||h[j][1],n=[k,l,m];j>=1&&e.series.forEach(function(a){return a.options.id==="range"+f.replace("u","")?(b?a.data[j].update(n):a.addPoint(n,!0,!0,!1),!1):void 0})}}a&&!a.Series.prototype.addBBANDS&&(a.Series.prototype.addBBANDS=function(a){var d=this.options.id;a=b.extend({period:20,devUp:2,devDn:2,maType:"SMA",mdlBndStroke:"red",uprBndStroke:"#A52A2A",lwrBndStroke:"#A52A2A",strokeWidth:1,dashStyle:"line",appliedTo:c.CLOSE,parentSeriesID:d},a);var e=Date.now(),f="m-"+e,g="u-"+e,h="l-"+e,i="range-"+e,j=this.options.data||[];if(j&&j.length>0){var k=q(j,a,this.options.type,f),l=s(j,k,a,this.options.type),m=r(j,k,a,this.options.type),n=this.chart;t[f]=a,t[g]=a,t[h]=a;var o=this;u[f]=n.addSeries({id:f,name:"BBANDS (Middle,"+a.period+","+a.devUp+","+a.devDn+","+c.appliedPriceString(a.appliedTo)+")",data:k,type:"line",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:a.mdlBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:o.options.compare},!1,!1),v[g]=n.addSeries({id:g,name:"BBANDS Upper",data:l,type:"line",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:a.uprBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:o.options.compare},!1,!1),w[h]=n.addSeries({id:h,name:"BBANDS Lower",data:m,type:"line",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:a.lwrBndStroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle,compare:o.options.compare},!1,!1);var p=[];m.forEach(function(a,b){var c=[a[0],a[1],l[b][1]];p.push(c)}),n.addSeries({id:i,data:p,name:"BBANDS Range",type:"arearange",dataGrouping:o.options.dataGrouping,opposite:o.options.opposite,color:"white",fillColor:"rgba(28,28,28,0.5)",connectNulls:!0,compare:o.options.compare,states:{hover:{enabled:!1}},events:{},dataLabels:{enabled:!1},point:{events:{}},enableMouseTracking:!1},!1,!1),b(u[f]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(v[g]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),b(w[h]).data({onChartIndicator:!0,indicatorID:"bbands",isIndicator:!0,parentSeriesID:a.parentSeriesID,period:a.period}),n.redraw()}},a.Series.prototype.removeBBANDS=function(a){var b=this.chart,c=a.replace("m-","").replace("l-","").replace("u-","");["m","u","l","range"].forEach(function(a){var d=a+"-"+c;b.get(d).remove(),"range"!==a&&("TEMA"===t[d].maType&&(x[d]=[],y[d]=[],z[d]=[]),t[d]=null,u[d]=null,v[d]=null,w[d]=null)}),b.redraw()},a.Series.prototype.preRemovalCheckBBANDS=function(a){var b=void 0;return t[a]&&(b="BBANDS ("+t[a].period+","+t[a].devUp+","+t[a].devDn+","+c.appliedPriceString(t[a].appliedTo)+")"),{isMainIndicator:0===a.indexOf("m-"),period:t[a]?t[a].period:void 0,appliedTo:t[a]?t[a].appliedTo:void 0,devUp:t[a]?t[a].devUp:void 0,devDn:t[a]?t[a].devDn:void 0,maType:t[a]?t[a].maType:void 0,isValidUniqueID:null!=t[a],indicatorName:b}},a.wrap(a.Series.prototype,"addPoint",function(a,b,d,i,j){a.call(this,b,d,i,j),c.checkCurrentSeriesHasIndicator(t,this.options.id)&&(e.call(this,b[0]),f.call(this,b[0]),g.call(this,b[0]),h.call(this,b[0]))}),a.wrap(a.Point.prototype,"update",function(a,b,d,i){a.call(this,b,d,i),c.checkCurrentSeriesHasIndicator(t,this.series.options.id)&&(e.call(this.series,this.x,!0),f.call(this.series,this.x,!0),g.call(this.series,this.x,!0),h.call(this.series,this.x,!0))}))}(Highcharts,jQuery,b)}}});