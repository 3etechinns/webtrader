define(["lodash","jquery","moment","windows/windows","common/rivetsExtra","websockets/binary_websockets","charts/chartingRequestMap","text!trade/tradeDialog.html","css!trade/tradeDialog.css","timepicker","jquery-ui"],function(a,b,c,d,e,f,g,h){function i(b){return a(b).filter({contract_category_display:"Up/Down",barrier_category:"euro_atm",contract_display:"higher"}).each(m("contract_display","rise")).value(),a(b).filter({contract_category_display:"Up/Down",barrier_category:"euro_atm",contract_display:"lower"}).each(m("contract_display","fall")).value(),a(b).filter(["contract_category_display","Stays In/Goes Out"]).each(m("contract_category_display","In/Out")).value(),a(b).filter(["contract_category_display","Ends In/Out"]).each(m("contract_category_display","In/Out")).value(),a(b).filter(["contract_category_display","Digits"]).each(m("barriers",0)).value(),a(b).filter(["contract_display","ends outside"]).each(m("contract_display","ends out")).value(),a(b).filter(["contract_display","ends between"]).each(m("contract_display","ends in")).value(),a(b).filter(["contract_display","stays between"]).each(m("contract_display","stays in")).value(),a(b).filter(["contract_display","goes outside"]).each(m("contract_display","goes out")).value(),a(b).filter(["contract_display","touches"]).each(m("contract_display","touch")).value(),a(b).filter(["contract_display","does not touch"]).each(m("contract_display","no touch")).value(),b=a.sortBy(b,function(a){var b={"Up/Down":1,"Touch/No Touch":2,"In/Out":3,Digits:4,Asians:5,Spreads:6}[a.contract_category_display];return 4===b&&(b={odd:4,even:4.5}[a.contract_display]||3.5),b})}function j(a,b){return f.cached.send({trading_times:a}).then(function(a){var c={open:"--",close:"--"};return a.trading_times.markets.forEach(function(a){a.submarkets.forEach(function(a){a.symbols.forEach(function(a){a.symbol===b&&(c={open:a.times.open[0],close:a.times.close[0]})})})}),c})["catch"](function(a){return{open:"--",close:"--"}})}function k(d,e){var g={duration:{array:["Duration","End Time"],value:"Duration"},duration_unit:{array:[""],ranges:[{min:1,max:365}],value:""},duration_count:{value:1,min:1,max:365},date_start:{value:"now",array:[{text:"Now",value:"now"}],visible:!1},date_expiry:{value_date:c.utc().format("YYYY-MM-DD"),value_hour:c.utc().format("HH:mm"),value:0,today_times:{open:"--",close:"--",disabled:!1},onHourShow:function(a){var b=g.date_expiry.today_times;if("--"===b.open)return!0;var d=c.utc(),e=c(b.close,"HH:mm:ss").hour(),f=c(b.open,"HH:mm:ss").hour();return d.hour()>=f&&d.hour()<=e&&(f=d.hour()),a>=f&&e>=a||e>=a&&f>=e||a>=f&&f>=e},onMinuteShow:function(a,b){var d=g.date_expiry.today_times;if("--"===d.open)return!0;var e=c.utc(),f=c(d.close,"HH:mm:ss").hour(),h=c(d.close,"HH:mm:ss").minute(),i=c(d.open,"HH:mm:ss").hour(),j=c(d.open,"HH:mm:ss").minute();return e.hour()>=i&&e.hour()<=f&&(i=e.hour(),j=e.minute()),i===a?b>=j:f===a?h>=b:a>i&&f>a||f>a||a>i}},categories:{array:[],value:"",paddingTop:function(){var a={Asians:"26px","Up/Down":"16px",Digits:"14px","In/Out":"4px","Touch/No Touch":"16px",Spreads:"5px"};return a[g.categories.value]||"3px"}},category_displays:{array:[],selected:""},barriers:{barrier_count:0,barrier:"",high_barrier:"",low_barrier:"",barrier_live:function(){return 1*this.barrier+1*g.tick.quote},high_barrier_live:function(){return 1*this.high_barrier+1*g.tick.quote},low_barrier_live:function(){return 1*this.low_barrier+1*g.tick.quote}},digits:{array:["0","1","2","3","4","5","6","7","8","9"],value:"0",visible:!1,text:"Last Digit Prediction"},currency:{array:["USD"],value:"USD"},basis:{array:["Payout","Stake"],value:"payout",amount:10,limit:null,up:function(){var a=1*g.basis.amount;a=1>a?a+.1:a+1,(0|a)!==a&&(a=a.toFixed(2)),g.basis.amount=a},down:function(){var a=1*g.basis.amount;a=a>1?a-1:a-.1,(0|a)!==a&&(a=a.toFixed(2)),a>0&&(g.basis.amount=a)}},spreads:{amount_per_point:1,stop_type:"point",stop_loss:10,stop_profit:10,spread:0,spot:"0.0",spot_time:"0",deposit_:function(){return this.stop_loss*this.amount_per_point}},tick:{epoch:"0",quote:"0",perv_quote:"0",down:function(){var a=1*this.quote<1*this.perv_quote;return a}},ticks:{array:[],loading:!0},proposal:{symbol:a(d).head().underlying_symbol,ids:[],req_id:-1,ask_price:"0.0",date_start:0,display_value:"0.0",message:"Loading ...",payout:0,spot:"0.0",spot_time:"0",error:"",loading:!0,netprofit_:function(){return g.currency.value+" "+(this.payout-this.ask_price||0).toFixed(2)},return_:function(){var a=((this.payout-this.ask_price)/this.ask_price||0).toFixed(2);return(100*a|0)+"%"}},purchase:{loading:!1},tooltips:{barrier:{my:"left-215 top+10",at:"left bottom",collision:"flipfit"},barrier_p:{my:"left-5 top+10",at:"left bottom",collision:"flipfit"}}};return g.barriers.root=g,g.date_expiry.update_times=function(){j(g.date_expiry.value_date,g.proposal.symbol).then(function(b){var d=g.date_expiry;d.today_times.open=b.open,d.today_times.close=b.close;var e=a(g.duration_unit.ranges).filter(["type","minutes"]).head();d.today_times.disabled=!e;var f=e?c.utc().add(e.min+1,"m").format("HH:mm"):"00:00";d.value_hour=f>d.value_hour?f:d.value_hour})},g.categories.update=function(){var b=g.categories.value;g.category_displays.array=a(d).filter(["contract_category_display",b]).map("contract_display").uniq().value(),g.category_displays.selected=a.head(g.category_displays.array)},g.category_displays.onclick=function(a){g.category_displays.selected=b(a.target).attr("data")},g.date_start.update=function(){var b=a(d).filter({contract_category_display:g.categories.value,contract_display:g.category_displays.selected,start_type:"forward"}).head();if(!b)return void a.assign(g.date_start,{visible:!1,array:[],value:"now"});b=b.forward_starting_options;var c=(g.date_start,[{text:"Now",value:"now"}]);a.each(b,function(a){var b=300,d=Math.ceil(Math.max((new Date).getTime()/1e3,a.open)/b)*b;to=a.close;for(var e=d;e<to;e+=b){var f=new Date(1e3*e),g=("00"+f.getUTCHours()).slice(-2)+":"+("00"+f.getUTCMinutes()).slice(-2)+" "+["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][f.getUTCDay()];c.push({text:g,value:e})}}),a.assign(g.date_start,{value:"now",array:c,visible:!0})},g.date_expiry.update=function(a){var b=g.date_expiry,d=!c.utc(b.value_date).isAfter(c.utc(),"day");d?(a!==b.value_hour&&b.update_times(),b.value=c.utc(b.value_date+" "+b.value_hour).unix(),n(b.value,g.proposal.onchange)):(b.today_times.disabled=!0,j(b.value_date,g.proposal.symbol).then(function(a){var d="--"!==a.close?a.close:"00:00:00";b.value_hour=c(d,"HH:mm:ss").format("HH:mm"),b.value=c.utc(b.value_date+" "+d).unix(),n(b.value,g.proposal.onchange)}))},g.duration.update=function(){var b=g.categories.value;a(["Up/Down","In/Out","Touch/No Touch"]).includes(b)?2!==g.duration.array.length&&(g.duration.array=["Duration","End Time"]):(g.duration.value="Duration",1!==g.duration.array.length&&(g.duration.array=["Duration"]))},g.duration_unit.update=function(){var b="now"!==g.date_start.value?"forward":"spot",c=a(d).filter({contract_category_display:g.categories.value,contract_display:g.category_displays.selected,start_type:b}).map(function(a){return{min:a.min_contract_duration+"",max:a.max_contract_duration+"",type:a.expiry_type}}).value(),e=[],f=[];a.each(c,function(b){if(a(["tick","daily"]).includes(b.type))return e.push({tick:"ticks",daily:"days"}[b.type]),void f.push({min:0|b.min.replace("d","").replace("t",""),max:0|b.max.replace("d","").replace("t",""),type:{tick:"ticks",daily:"days"}[b.type]});var c=b.min.replace("s","").replace("m","").replace("h",""),d=b.max.replace("s","").replace("m","").replace("h","").replace("d",""),g=a(b.min).last(),h=a(b.max).last();c*={s:1,m:60,h:3600}[g],d*={s:1,m:60,h:3600,d:86400}[h],"s"===g&&(e.push("seconds"),f.push({min:c,max:d,type:"seconds"})),a(["s","m"]).includes(g)&&d>=60&&(e.push("minutes"),f.push({min:Math.max(c/60,1),max:d/60,type:"minutes"})),a(["s","m","h"]).includes(g)&&d>=3600&&(e.push("hours"),f.push({min:Math.max(c/3600,1),max:d/3600,type:"hours"}))});var h={ticks:0,seconds:1,minutes:2,hours:3,days:4};return e.sort(function(a,b){return h[a]-h[b]}),f.sort(function(a,b){return h[a.type]-h[b.type]}),e.length?(g.duration_unit.ranges=f,a.includes(e,g.duration_unit.value)?g.duration_count.update(!0):g.duration_unit.value=a.head(e),g.duration_unit.array=e,g.barriers.update(),void g.date_expiry.update_times()):void g.barriers.update()},g.duration_count.update=function(b){var c=a(g.duration_unit.ranges).filter({type:g.duration_unit.value}).head();c&&(g.duration_count.min=c.min,g.duration_count.max=c.max,b!==!0?g.duration_count.value=c.min:(g.duration_count.value<c.min||g.duration_count.value>c.max)&&(g.duration_count.value=c.min))},g.digits.update=function(){var b=g.category_displays.selected;if("Digits"!==g.categories.value||"odd"===b||"even"===b)return void(g.digits.visible=!1);var c={matches:["0","1","2","3","4","5","6","7","8","9"],differs:["0","1","2","3","4","5","6","7","8","9"],under:["1","2","3","4","5","6","7","8","9"],over:["0","1","2","3","4","5","6","7","8"]}[b],d={matches:"Last Digit Prediction",differs:"Last Digit Prediction",under:"Last Digit is Under",over:"Last Digit is Over"}[b];a.includes(c,g.digits.value)||(g.digits.value=c[0]),g.digits.array=c,g.digits.text=d,g.digits.visible=!0},g.barriers.update=function(){var b=g.duration_unit.value,c=a(["seconds","minutes","hours"]).includes(b)?"intraday":"days"===b?"daily":"tick",e=a(d).filter({contract_category_display:g.categories.value,contract_display:g.category_displays.selected,expiry_type:c}).filter(function(a){return a.barriers>=1}).head();g.barriers.barrier_count=e?e.barriers:0,e&&(e.barrier&&(g.barriers.barrier="+"+1*(g.barriers.barrier||e.barrier)),e.high_barrier&&(g.barriers.high_barrier="+"+1*(g.barriers.high_barrier||e.high_barrier)),e.low_barrier&&(g.barriers.low_barrier=1*(g.barriers.low_barrier||e.low_barrier)))},g.basis.update_limit=function(){var b=g.basis,c=a(d).filter({contract_category_display:g.categories.value,contract_display:g.category_displays.selected}).head();c=c&&c.payout_limit||null,b.limit=c?1*c:null,b.limit&&(b.amount=Math.min(b.amount,b.limit))},g.proposal.onchange=function(){var b=g.duration_unit.value,c=a(["seconds","minutes","hours"]).includes(b)?"intraday":"days"===b?"daily":"tick";"Spreads"===g.categories.value&&(c="intraday");var e=a(d).filter({contract_category_display:g.categories.value,contract_display:g.category_displays.selected,expiry_type:c}).head(),h={proposal:1,subscribe:1,contract_type:e.contract_type,currency:g.currency.value,symbol:g.proposal.symbol};for("Spreads"!==g.categories.value?(h.amount=g.basis.amount,h.basis=g.basis.value):(h.amount_per_point=g.spreads.amount_per_point,h.stop_type=g.spreads.stop_type,h.stop_loss=g.spreads.stop_loss,h.stop_profit=g.spreads.stop_profit),1==g.barriers.barrier_count&&(h.barrier=g.barriers.barrier),2==g.barriers.barrier_count&&(h.barrier=g.barriers.high_barrier,h.barrier2=g.barriers.low_barrier+""),"Digits"===g.categories.value&&(h.barrier=g.digits.value+""),"now"!==g.date_start.value&&(h.date_start=1*g.date_start.value),"Duration"===g.duration.value?(h.duration_unit=a(g.duration_unit.value).head(),h.duration=1*g.duration_count.value):h.date_expiry=g.date_expiry.value,g.proposal.loading=!0;g.proposal.ids.length;){var i=g.proposal.ids.shift();f.send({forget:i})}f.send(h).then(function(a){var b=a.proposal.id;g.proposal.ids.push(b),g.proposal.error="",g.proposal.req_id=a.req_id})["catch"](function(a){g.proposal.error=a.message,g.proposal.message=""})},g.purchase.onclick=function(){g.purchase.loading=!0;var c=function(a){a.appendTo(e),e.find(".trade-fields").css({left:"350px"}),e.find(".trade-conf").css({left:"0"})},d=function(a){e.find(".trade-fields").css({left:"0"}),e.find(".trade-conf").css({left:"-350px"}),g.purchase.loading=!1,a.remove(),g.proposal.onchange()},h={currency:g.currency.value,symbol:g.proposal.symbol,category:g.categories.value,category_display:g.category_displays.selected,duration_unit:g.duration_unit.value};a(["Digits","Up/Down","Asians"]).includes(h.category)&&"ticks"===h.duration_unit&&(h.digits_value=g.digits.value,h.tick_count=1*g.duration_count.value,"Digits"!==h.category&&(h.tick_count+=1)),f.is_authenticated()?f.send({buy:a(g.proposal.ids).last(),price:1*g.proposal.ask_price}).then(function(a){require(["trade/tradeConf"],function(b){b.init(a,h,c,d)})})["catch"](function(a){g.purchase.loading=!1,b.growl.error({message:a.message}),g.proposal.onchange()}):(b.growl.warning({message:"Please login with real account in order to Purchase"}),g.purchase.loading=!1)},g.categories.array=a(d).map("contract_category_display").uniq().value(),g.categories.value=a(g.categories.array).includes("Up/Down")?"Up/Down":a(g.categories.array).head(),f.events.on("tick",function(a){a.tick&&a.tick.symbol==g.proposal.symbol&&(g.tick.perv_quote=g.tick.quote,g.tick.epoch=a.tick.epoch,g.tick.quote=a.tick.quote,g.ticks.loading=!1,g.ticks.array.length>30&&g.ticks.array.shift(),g.ticks.array.push(a.tick))}),f.events.on("proposal",function(a){if(a.req_id===g.proposal.req_id){if(a.error)return g.proposal.error=a.error.message,void(g.proposal.message="");if(!g.purchase.loading){var b=a.proposal;g.proposal.ask_price=b.ask_price,g.proposal.date_start=b.date_start,g.proposal.display_value=b.display_value,g.proposal.message=b.longcode,g.proposal.payout=b.payout,g.proposal.spot=b.spot,g.proposal.spot_time=b.spot_time,g.spreads.spread=b.spread||0,g.spreads.spot=b.spot||"0.0",g.spreads.spot_time=b.spot_time||"0",g.proposal.loading=!1}}}),f.is_authenticated()&&f.send({payout_currencies:1}).then(function(a){g.currency.value=a.payout_currencies[0],g.currency.array=a.payout_currencies})["catch"](function(a){}),g}function l(c,j){var l=b(h),m=i(j.available),n=d.createBlankWindow(l,{title:c.display_name,resizable:!1,collapsable:!0,minimizable:!0,maximizable:!1,"data-authorized":"true",close:function(){for(;p.proposal.ids.length;){var a=p.proposal.ids.shift();f.send({forget:a})}g.unregister(o),q.unbind()}}),c=a(m).head().underlying_symbol,o=g.keyFor(c,0);g[o]?g.subscribe(o):g.register({symbol:c,subscribe:1,granularity:0,count:1e3,style:"ticks"})["catch"](function(c){b.growl.error({message:c.message});var d=a(m).map("min_contract_duration").some(function(b){return/^\d+$/.test(b)||"t"===a.last(b)});d?a.delay(function(){n.dialog("close")},2e3):p.ticks.loading=!1});var p=k(m,l,n),q=e.bind(l[0],p);p.categories.update(),n.dialog("open")}require(["trade/tradeConf"]);var m=function(a,b){return function(c){return c[a]=b,c}},n=e.formatters.debounce;return{init:l}});