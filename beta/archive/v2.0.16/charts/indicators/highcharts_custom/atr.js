define(["indicator_base","highstock"],function(a){var b={},c={};return{init:function(){!function(a,d,e){function f(a,d){var f=this,g=f.chart;for(var h in c)if(c[h]&&c[h].options&&c[h].options.data&&c[h].options.data.length>0&&b[h].parentSeriesID==f.options.id&&c[h].chart===g){var i=f.options.data,j=c[h].options.data,k=b[h].period,l=e.findIndexInDataForTime(i,a);if(l>=1){var m=0;if(e.isOHLCorCandlestick(f.options.type)){var n=i[l].high||i[l][2],o=i[l].low||i[l][3],p=i[l-1].close||i[l-1][4];m=Math.max(Math.max(n-o,Math.abs(n-p)),o-p)}else{var q=i[l].y||i[l][1],r=i[l-1].y||i[l-1][1];m=Math.abs(q-r)}var s=e.toFixed(((j[l-1].y||j[l-1][1])*(k-1)+m)/k,4);d?c[h].data[l].update({y:s}):c[h].addPoint([i[l].x||i[l][0],s],!0,!0,!1)}}}a&&!a.Series.prototype.addATR&&(a.Series.prototype.addATR=function(a){var f=this.options.id;a=d.extend({period:14,stroke:"red",strokeWidth:2,dashStyle:"line",levels:[],parentSeriesID:f},a);var g="_"+(new Date).getTime(),h=this.options.data||[];if(h&&h.length>0){for(var i=[],j=[],k=0;k<h.length;k++)if(i.push(e.isOHLCorCandlestick(this.options.type)?0==k?(h[k].high||h[k][2])-(h[k].low||h[k][3]):Math.max(Math.max((h[k].high||h[k][2])-(h[k].low||h[k][3]),Math.abs((h[k].high||h[k][2])-(h[k-1].close||h[k-1][4]))),(h[k].low||h[k][3])-(h[k-1].close||h[k-1][4])):0==k?h[k].y||h[k][1]:Math.abs((h[k].y||h[k][1])-(h[k-1].y||h[k-1][1]))),k>=a.period){var l=(j[k-1][1]*(a.period-1)+i[k])/a.period;isFinite(l)&&!isNaN(l)&&j.push([h[k].x||h[k][0],e.toFixed(l,4)])}else j.push([h[k].x||h[k][0],0]);var m=this.chart;b[g]=a,m.addAxis({id:"atr"+g,title:{text:"ATR ("+a.period+")",align:"high",offset:0,rotation:0,y:10,x:50},lineWidth:2,plotLines:a.levels},!1,!1,!1),e.recalculate(m);var n=this;c[g]=m.addSeries({id:g,name:"ATR ("+a.period+")",data:j,type:"line",dataGrouping:n.options.dataGrouping,yAxis:"atr"+g,opposite:n.options.opposite,color:a.stroke,lineWidth:a.strokeWidth,dashStyle:a.dashStyle},!1,!1),d(c[g]).data({isIndicator:!0,indicatorID:"atr",parentSeriesID:a.parentSeriesID,period:a.period}),m.redraw()}return g},a.Series.prototype.removeATR=function(a){var d=this.chart;b[a]=null,d.get(a).remove(!1),d.get("atr"+a).remove(!1),c[a]=null,e.recalculate(d),d.redraw()},a.Series.prototype.preRemovalCheckATR=function(a){return{isMainIndicator:!0,period:b[a]?b[a].period:void 0,isValidUniqueID:null!=b[a]}},a.wrap(a.Series.prototype,"addPoint",function(a,c,d,g,h){a.call(this,c,d,g,h),e.checkCurrentSeriesHasIndicator(b,this.options.id)&&f.call(this,c[0],!1)}),a.wrap(a.Point.prototype,"update",function(a,c,d,g){a.call(this,c,d,g),e.checkCurrentSeriesHasIndicator(b,this.series.options.id)&&f.call(this.series,this.x,!0)}))}(Highcharts,jQuery,a)}}});