define(["websockets/binary_websockets","charts/chartingRequestMap"],function(a,b){function c(a){var b=a.toUpperCase().replace("D","").replace("M","").replace("W",""),c=""==b?1:parseInt(b),d=a.toUpperCase().replace(""+c,"");return{suffix:d,intVal:c}}function d(a,b){var c=0;switch(a){case"M":c=60*b;break;case"H":c=60*b*60;break;case"D":c=24*b*60*60}return c}function e(a,b,c,d,e,f,g){if(!(g.length>0&&g[g.length-1][0]>e))if(f&&isDataTypeClosePriceOnly(f)){if(!$.isNumeric(e)||!$.isNumeric(d))return;g.push([e,d])}else{if(!($.isNumeric(e)&&$.isNumeric(a)&&$.isNumeric(b)&&$.isNumeric(c)&&$.isNumeric(d)))return;g.push([e,a,b,c,d])}}function f(a,b,c,d,e,f){if(a){var g=b.length,h=b.length>30?g-30:0;a.xAxis[0].range=b[g-1][0]-b[h][0];var i=a.addSeries({id:e,name:d,data:b,type:c?c:"candlestick",dataGrouping:{enabled:!1},compare:f});i.isDirty=!0,$(i).data("isInstrument",!0),i.isDirtyData=!0,$(document).oneTime(1e3,null,function(){i.addCurrentPrice(),a.redraw()}),a.hideLoading()}}function g(b,g,h,i,j){var k=b;if(g[k]){var l=g[k].chartIDs;if(j){var m=void 0;l.forEach(function(a){return a.containerIDWithHash==j?(m=a,!1):void 0});var n=$(j).highcharts(),o=h.chain().find({instrumentCdAndTp:k}).simplesort("time",!1).data(),p=[],q=$(j).data("type");for(var r in o)e(o[r].open,o[r].high,o[r].low,o[r].close,o[r].time,q,p);f(n,p,q,m.instrumentName,k,m.series_compare,m.instrumentCode)}else for(var s in l){var m=l[s];if(i){var t=$(m.containerIDWithHash).highcharts().get(b),u=t.data[t.data.length-1].x||t.data[t.data.length-1].time,o=h.chain().find({instrumentCdAndTp:k}).where(function(a){return a.time>=u}).simplesort("time",!1).data();for(var s in o){for(var v=o[s],w=void 0,x=t.data.length-1;x>=0;x--){var y=t.data[x];if(y&&v.time==(y.x||y.time)){w=y;break}}w?w.update(q&&isDataTypeClosePriceOnly(q)?[v.time,v.close]:[v.time,v.open,v.high,v.low,v.close]):q&&isDataTypeClosePriceOnly(q)?t.addPoint([v.time,v.close],!1,!1):t.addPoint([v.time,v.open,v.high,v.low,v.close],!1,!1),t.isDirty=!0,t.isDirtyData=!0}t.chart.redraw()}else{var n=$(m.containerIDWithHash).highcharts(),o=h.chain().find({instrumentCdAndTp:k}).simplesort("time",!1).data(),p=[],q=$(m.containerIDWithHash).data("type");for(var r in o)e(o[r].open,o[r].high,o[r].low,o[r].close,o[r].time,q,p);f(n,p,q,m.instrumentName,k,m.series_compare,m.instrumentCode)}}if($.isEmptyObject(g[k].tickStreamingID)){var m=g[k].chartIDs[0],z=$(m.containerIDWithHash).data("instrumentCode"),A=$(m.containerIDWithHash).data("timeperiod");if(a.send({ticks:m.instrumentCode,passthrough:{instrumentCdAndTp:k}}),isTick(A))return;for(var o=h.chain().find({instrumentCdAndTp:k}).simplesort("time",!0).limit(1).data(),B=c(A),C=B.suffix,D=B.intVal,E=d(C,D),F=o[0].time,G=F+1e3*E,H=new Date;G<H.getTime();)G+=1e3*E;g[k].timerHandler="_"+(new Date).getTime(),$(document).oneTime(Math.ceil(G-H.getTime())+1e3,g[k].timerHandler,function(){function b(){var b=h.chain().find({instrumentCdAndTp:k}).simplesort("time",!0).limit(1).data();if(b&&b.length>0){b=b[0];var d=c(A),e=d.suffix,f=d.intVal,g={ticks_history:z,end:"latest",start:b.time/1e3,granularity:e+f,passthrough:{isTimer:"true",instrumentCdAndTp:k}};a.send(g)}}g[k].timerHandler="_"+(new Date).getTime(),$(document).everyTime(1e3*E,g[k].timerHandler,b),b()})}}}var h=b.barsTable;return a.events.on("candles",function(a){for(var c in a.candles){var d=a.candles[c],e=parseFloat(d.open),f=parseFloat(d.high),i=parseFloat(d.low),j=parseFloat(d.close),k=1e3*parseInt(d.epoch),l=h.chain().find({time:k}).find({instrumentCdAndTp:a.echo_req.passthrough.instrumentCdAndTp}).limit(1).data();l&&l.length>0?(l=l[0],l.open=e,l.high=f,l.low=i,l.close=j,h.update(l)):h.insert({instrumentCdAndTp:a.echo_req.passthrough.instrumentCdAndTp,time:k,open:e,high:f,low:i,close:j})}g(a.echo_req.passthrough.instrumentCdAndTp,b,h,a.echo_req.passthrough.isTimer,null)}),a.events.on("history",function(a){for(var c in a.history.times){var d=1e3*parseInt(a.history.times[c]),e=parseFloat(a.history.prices[c]),f=h.chain().find({time:d}).find({instrumentCdAndTp:a.echo_req.passthrough.instrumentCdAndTp}).limit(1).data();f&&f.length>0?(f=f[0],f.open=e,f.high=e,f.low=e,f.close=e,h.update(f)):h.insert({instrumentCdAndTp:a.echo_req.passthrough.instrumentCdAndTp,time:d,open:e,high:e,low:e,close:e})}g(a.echo_req.passthrough.instrumentCdAndTp,b,h,!1,null)}),{retrieveChartDataAndRender:function(e,f,i,j,k,l){var m=c(e),n=m.suffix,o=m.intVal,p=d(n,o),q=1e3;"D"==n&&o>1&&(q=Math.floor(q/o));var r=Math.ceil((new Date).getTime()/1e3),s=r-q*p,t=Math.ceil((r-s)/p);if(isTick(e)&&(t=1e3),!$.isEmptyObject(b[(f+e).toUpperCase()]))return b[(f+e).toUpperCase()].chartIDs.push({containerIDWithHash:i,series_compare:l,instrumentCode:f,instrumentName:k}),void g((f+e).toUpperCase(),b,h,!1,i);var u=(f+e).toUpperCase();b[u]=b[u]||{tickStreamingID:""},b[u].chartIDs=[{containerIDWithHash:i,series_compare:l,instrumentCode:f,instrumentName:k}];var v={ticks_history:f,end:"latest",count:t,adjust_start_time:1,passthrough:{instrumentCdAndTp:(f+e).toUpperCase()}};isTick(e)||(v=$.extend(v,{start:s,granularity:n+o})),a.send(v)}}});