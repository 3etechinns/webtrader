define(["jquery","windows/windows","websockets/binary_websockets","lodash","common/rivetsExtra","jquery-growl","common/util"],function(a,b,c,d,e){var f=null,g=null,h={max_balance:null,max_turnover:null,max_losses:null,max_7day_turnover:null,max_7day_losses:null,max_30day_turnover:null,max_30day_losses:null,max_open_bets:null,session_duration_limit:null,exclude_until:null,update:function(b,d){var e={set_self_exclusion:1,session_duration_limit:d.session_duration_limit,exclude_until:d.exclude_until,max_open_bets:d.max_open_bets,max_balance:d.max_balance,max_30day_losses:d.max_30day_losses,max_turnover:d.max_turnover,max_30day_turnover:d.max_30day_turnover,max_7day_losses:d.max_7day_losses,max_losses:d.max_losses,max_7day_turnover:d.max_7day_turnover};c.send(e).then(function(){a.growl.notice({message:"Your changes have been updated"}),k()})["catch"](function(b){a.growl.error({message:b.message})})}},i=function(){return require(["css!selfexclusion/selfexclusion.css"]),new Promise(function(c){require(["text!selfexclusion/selfexclusion.html"],function(d){var g=a(d);f=b.createBlankWindow(a("<div/>"),{title:"Self-Exclusion Facilities",width:700,minHeight:90,"data-authorized":"true",destroy:function(){f=null}}),g.appendTo(f),e.bind(g[0],h),j(),c()})})},j=function(){return a.growl.notice({message:"Loading self-exclusion settings!"}),c.send({get_self_exclusion:1}).then(function(a){a.get_self_exclusion&&(h.max_balance=a.get_self_exclusion.max_balance,h.max_turnover=a.get_self_exclusion.max_turnover,h.max_losses=a.get_self_exclusion.max_losses,h.max_7day_turnover=a.get_self_exclusion.max_7day_turnover,h.max_7day_losses=a.get_self_exclusion.max_7day_losses,h.max_30day_turnover=a.get_self_exclusion.max_30day_turnover,h.max_30day_losses=a.get_self_exclusion.max_30day_losses,h.max_open_bets=a.get_self_exclusion.max_open_bets,h.session_duration_limit=a.get_self_exclusion.session_duration_limit,h.exclude_until=a.get_self_exclusion.exclude_until)})["catch"](function(b){a.growl.error({message:b.message})})},k=function(){if(!d.isUndefined(h.session_duration_limit)&&!d.isNull(h.session_duration_limit)&&d.isNumber(h.session_duration_limit)){g&&clearTimeout(g);var b=60*h.session_duration_limit*1e3;g=setLongTimeout(function(){a.growl.warning({message:"Logging out because of self-exclusion session time out!"}),c.invalidate()},b,function(a){g=a})}};return c.events.on("login",function(){c.cached.authorize().then(function(){j().then(function(){k()})})}),c.events.on("logout",function(){f&&f.dialog("destroy"),f=null,g&&clearTimeout(g),g=null,h.max_balance=null,h.max_turnover=null,h.max_losses=null,h.max_7day_turnover=null,h.max_7day_losses=null,h.max_30day_turnover=null,h.max_30day_losses=null,h.max_open_bets=null,h.session_duration_limit=null,h.exclude_until=null}),{init:function(a){a.click(function(){c.cached.authorize().then(function(){f?(j(),f.moveToTop()):i().then(function(){f.dialog("open")})})["catch"](function(a){})})}}});