{"version":3,"sources":["../../../../src/assetindex/assetIndex.es6"],"names":["table","assetWin","market_names","submarket_names","assets","markets","init","li","click","createBlankWindow","title","i18n","dialogClass","width","height","track","module_id","is_unique","data","dialog","require","initAssetWin","moveToTop","processMarketSubmarkets","activeSymbols","extractChartableMarkets","ret","filter","allInstruments","eMarket","submarkets","forEach","concat","f","instruments","some","found","find","symbol","eInstrument","is_trading_suspended","exchange_is_open","market","smarkets","display_name","smarket","map","refreshTable","updateTable","market_name","submarket_name","symbols","rows","asset","indexOf","props","prop","unshift","api","remove","add","draw","processing_msg","attr","show","Promise","all","cached","send","trading_times","Date","toISOString","slice","asset_index","active_symbols","then","results","head","ff","header","parent","addClass","dialog_buttons","makeSelectmenu","insertBefore","list","Object","keys","inx","changed","val","update_list","selectmenu","is_rtl_language","local_storage","get","value","hide","err","console","error","catch","growl","message","$html","appendTo","dataTable","className","paging","ordering","searching","processing","column","every","on","search","liveapi","events"],"mappings":"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","file":"assetIndex.js","sourcesContent":["ï»¿/**\n * Created by amin on October 19, 2015.\n */\nimport $ from 'jquery';\nimport windows from '../windows/windows';\nimport liveapi from '../websockets/binary_websockets';\nimport menu from \"../navigation/menu\";\nimport _ from \"lodash\";\nimport \"datatables\";\nimport \"jquery-growl\";\n\nlet table = null;\nlet assetWin = null;\nlet market_names = null;\nlet submarket_names = null;\nlet assets = [];\nlet markets = {};\n\nexport const init = (li) => {\n    li.click(() => {\n        if (!assetWin) {\n            assetWin = windows.createBlankWindow($('<div/>'), {\n                title: 'Asset Index'.i18n(),\n                dialogClass: 'assetIndex',\n                width: 700,\n                height: 400\n            });\n            assetWin.track({\n                module_id: 'assetIndex',\n                is_unique: true,\n                data: null\n            });\n            assetWin.dialog('open'); /* bring window to front */\n            require(['text!assetindex/assetIndex.html'], initAssetWin);\n        } else\n            assetWin.moveToTop();\n    });\n}\n\nconst processMarketSubmarkets = (markets, activeSymbols) => {\n    markets = menu.extractChartableMarkets(markets);\n\n    const ret = {};\n    markets\n      .filter(eMarket => {\n        let allInstruments = [];\n        eMarket.submarkets.forEach(f => allInstruments = allInstruments.concat(f.instruments));\n        return _.some(allInstruments, eInstrument => {\n          const found = (activeSymbols.find(f => f.symbol === eInstrument.symbol) || {});\n          return !found.is_trading_suspended && found.exchange_is_open;\n        });\n      })\n      .forEach((market) => {\n        const smarkets = ret[market.display_name] = {};\n        market.submarkets.forEach((smarket) => {\n            smarkets[smarket.display_name] = smarket.instruments.map((symbol) => {\n                return symbol.display_name; });\n        });\n    });\n    return ret;\n}\n\nconst refreshTable = () => {\n    const updateTable = (market_name, submarket_name) => {\n        const symbols = markets[market_name][submarket_name];\n        const rows = assets\n            .filter((asset) => {\n                return symbols.indexOf(asset[1] /* asset.name */ ) > -1;\n            })\n            .map((asset) => {\n                /* secham:\n                    [ \"frxAUDJPY\",\"AUD/JPY\",\n                        [\"callput\",\"callput\",\"5t\",\"365d\"],\n                        [\"touchnotouch\",\"Touch/No Touch\",\"1h\",\"1h\"],\n                        [\"endsinout\",\"endsinout\",\"1d\",\"1d\"],\n                        [\"staysinout\",\"staysinout\",\"1d\",\"1d\"]\n                    ]\n                */\n                const props = asset[2] /* asset.props */\n                    .map(prop => prop[2] + ' - ' + prop[3]); /* for each property extract a string */\n                props.unshift(asset[1]); /* add asset.name to the beginning of array */\n\n                return props;\n            });\n        table.api().rows().remove();\n        table.api().rows.add(rows);\n        table.api().draw();\n    }\n\n    const processing_msg = $('#' + table.attr('id') + '_processing').show();\n    Promise.all(\n            [\n                liveapi.cached.send({ trading_times: new Date().toISOString().slice(0, 10) }),\n                liveapi.cached.send({ asset_index: 1 }),\n                liveapi.send({ active_symbols: 'brief' }),\n            ])\n        .then((results) => {\n            try {\n                assets = results[1].asset_index.filter(f => {\n                  const active_symbols = results[2].active_symbols;\n                  return _.find(active_symbols, ff => _.head(f) === ff.symbol);\n                });\n                markets = processMarketSubmarkets(results[0], results[2].active_symbols);\n                const header = assetWin.parent().find('.ui-dialog-title').addClass('with-content');\n                const dialog_buttons = assetWin.parent().find('.ui-dialog-titlebar-buttonpane');\n\n                if (!market_names) {\n                  market_names = windows\n                      .makeSelectmenu($('<select />').insertBefore(dialog_buttons), {\n                          list: Object.keys(markets), //Keys are the display_name\n                          inx: 0, //Index to select the item in drop down\n                          changed: (val) => {\n                              const list = Object.keys(markets[val]); /* get list of sub_markets */\n                              submarket_names.update_list(list);\n                              updateTable(market_names.val(), submarket_names.val());\n                          },\n                          width: '180px'\n                      });\n                  market_names.selectmenu('widget').addClass('asset-index-selectmenu');\n                } else {\n                  market_names.update_list(Object.keys(markets));\n                }\n\n                const is_rtl_language = local_storage.get('i18n') && local_storage.get('i18n').value === 'ar';\n                if (!submarket_names) {\n                  submarket_names = windows\n                    .makeSelectmenu($('<select />').insertBefore(is_rtl_language ? market_names : dialog_buttons), {\n                        list: Object.keys(markets[market_names.val()]),\n                        inx: 0,\n                        changed: (val) => {\n                            updateTable(market_names.val(), submarket_names.val());\n                        },\n                        width: '200px'\n                    });\n                  submarket_names.selectmenu('widget').addClass('asset-index-selectmenu');\n                } else {\n                  submarket_names.update_list(Object.keys(markets[market_names.val()]));\n                }\n\n                updateTable(market_names.val(), submarket_names.val());\n                processing_msg.hide();\n            } catch (err) { console.error(err) }\n        })\n        .catch((error) => {\n            $.growl.error({ message: error.message });\n            console.error(error);\n        });\n}\n\nconst initAssetWin = ($html) => {\n    $html = $($html).i18n();\n    table = $html.filter('table');\n    $html.appendTo(assetWin);\n\n    table = table.dataTable({\n        data: [],\n        \"columnDefs\": [\n            { className: \"dt-body-center dt-header-center\", \"targets\": [0, 1, 2, 3, 4] },\n            { \"defaultContent\": \"-\", \"targets\": [0, 1, 2, 3, 4] }\n        ],\n        paging: false,\n        ordering: false,\n        searching: true,\n        processing: true\n    });\n    table.parent().addClass('hide-search-input');\n\n    // Apply the a search on each column input change\n    table.api().column(0).every(function() {\n        const column = this;\n        $('input', this.header()).on('keyup change', function() {\n            if (column.search() !== this.value)\n                column.search(this.value).draw();\n        });\n    });\n\n    refreshTable();\n    require(['websockets/binary_websockets'], (liveapi) => {\n      liveapi.events.on('login', refreshTable);\n      liveapi.events.on('logout', refreshTable);\n   });\n}\n\nexport default {\n    init\n}\n"]}